<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Server - Sulfur Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1410 0%, #2a221a 50%, #3d3226 100%);
            background-attachment: fixed;
            color: #f5e6c3;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .navbar {
            background: rgba(42, 34, 26, 0.92) !important;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(232, 165, 85, 0.2);
        }

        .card {
            background: rgba(42, 34, 26, 0.7);
            border: 1px solid rgba(232, 165, 85, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .card-header {
            background: linear-gradient(135deg, rgba(232, 165, 85, 0.15), rgba(212, 149, 106, 0.1));
            border-bottom: 1px solid rgba(232, 165, 85, 0.2);
            border-radius: 12px 12px 0 0 !important;
            color: #e8a555;
        }
        
        .btn-minecraft {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            color: white;
        }
        
        .btn-minecraft:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            color: white;
        }
        
        .btn-danger-minecraft {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            border: none;
        }
        
        .console-output {
            background-color: rgba(20, 16, 12, 0.95);
            color: #a8b88c;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(232, 165, 85, 0.2);
        }

        .console-input {
            background-color: rgba(20, 16, 12, 0.95);
            color: #a8b88c;
            border: 1px solid rgba(232, 165, 85, 0.2);
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .console-input:focus {
            background-color: rgba(20, 16, 12, 0.95);
            color: #a8b88c;
            border-color: #8b9b6a;
            box-shadow: 0 0 0 0.25rem rgba(139, 155, 106, 0.25);
        }
        
        .status-badge {
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 20px;
        }
        
        .status-online {
            background-color: #4CAF50;
            color: white;
        }
        
        .status-offline {
            background-color: #f44336;
            color: white;
        }
        
        .status-starting {
            background-color: #ff9800;
            color: white;
        }
        
        .player-card {
            background-color: rgba(42, 34, 26, 0.6);
            border: 1px solid rgba(232, 165, 85, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
        }

        .world-card {
            transition: transform 0.2s;
        }

        .world-card:hover {
            transform: translateY(-2px);
        }

        .backup-item {
            background-color: rgba(42, 34, 26, 0.6);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
        }

        .mod-toggle {
            width: 100%;
            text-align: left;
            background-color: rgba(42, 34, 26, 0.6);
            border: 1px solid rgba(232, 165, 85, 0.2);
            color: #f5e6c3;
            padding: 12px 15px;
            border-radius: 8px;
            margin: 5px 0;
        }

        .mod-toggle:hover {
            background-color: rgba(232, 165, 85, 0.1);
        }

        .mod-toggle.active {
            border-color: #8b9b6a;
            background-color: rgba(139, 155, 106, 0.1);
        }

        .nav-tabs .nav-link {
            color: #c4b89a;
            border: none;
            border-bottom: 2px solid transparent;
        }

        .nav-tabs .nav-link:hover {
            color: #f5e6c3;
            border-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: #4CAF50;
            background-color: transparent;
            border-bottom: 2px solid #4CAF50;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .schedule-day {
            text-align: center;
            padding: 10px;
            background-color: rgba(42, 34, 26, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(232, 165, 85, 0.2);
            cursor: pointer;
            transition: all 0.2s;
        }

        .schedule-day:hover {
            border-color: rgba(232, 165, 85, 0.5);
        }

        .schedule-day.active {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }

        .schedule-hour {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            margin: 2px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            background-color: rgba(42, 34, 26, 0.6);
            border: 1px solid rgba(232, 165, 85, 0.2);
            transition: all 0.2s;
        }

        .schedule-hour:hover {
            border-color: rgba(232, 165, 85, 0.5);
        }

        .schedule-hour.active {
            background-color: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .ban-item {
            background-color: rgba(42, 34, 26, 0.6);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 5px 0;
        }

        .player-stats-card {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(139, 155, 106, 0.1));
            border: 1px solid rgba(139, 155, 106, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 5px 0;
        }
        
        /* Fix form label readability - ensure white/light text on dark backgrounds */
        .form-label {
            color: #eee !important;
        }
        
        /* Ensure card body text is readable */
        .card-body {
            color: #eee;
        }
        
        /* Fix select/input text color on dark backgrounds */
        .form-select.bg-dark, 
        .form-control.bg-dark {
            color: #f8f9fa !important;
        }
        
        /* Fix text-muted to be more visible */
        .text-muted {
            color: #a0a0a0 !important;
        }
        
        /* Ensure h5, h6 headings are readable */
        .card-body h5, .card-body h6 {
            color: #fff;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-robot"></i> Sulfur Bot
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="bi bi-house"></i> Dashboard</a>
                <a class="nav-link" href="/config"><i class="bi bi-gear"></i> Config</a>
                <a class="nav-link active" href="/minecraft"><i class="bi bi-controller"></i> Minecraft</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Status Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="bi bi-controller"></i> Minecraft Server
                            </h4>
                            <small class="text-muted" id="server-info">Loading...</small>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span id="status-badge" class="status-badge status-offline">
                                <i class="bi bi-circle-fill"></i> Offline
                            </span>
                            <div class="btn-group">
                                <button id="btn-start" class="btn btn-minecraft" onclick="startServer()">
                                    <i class="bi bi-play-fill"></i> Start
                                </button>
                                <button id="btn-stop" class="btn btn-danger-minecraft" onclick="stopServer()" disabled>
                                    <i class="bi bi-stop-fill"></i> Stop
                                </button>
                                <button id="btn-restart" class="btn btn-warning" onclick="restartServer()" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Restart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Console Panel -->
            <div class="col-lg-8 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> Server Console</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="clearConsole()">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="console-output" class="console-output">
                            <p class="text-muted">Console output will appear here when the server is running...</p>
                        </div>
                        <div class="input-group mt-3">
                            <span class="input-group-text bg-dark text-success border-dark">></span>
                            <input type="text" id="console-input" class="form-control console-input" 
                                   placeholder="Enter server command..." 
                                   onkeypress="handleCommandInput(event)">
                            <button class="btn btn-minecraft" onclick="sendCommand()">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="col-lg-4">
                <!-- Players Online -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-people"></i> Players Online 
                            <span id="player-count" class="badge bg-secondary">0</span>
                        </h5>
                    </div>
                    <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                        <div id="player-list">
                            <p class="text-muted mb-0">No players online</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Server Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <h4 id="stat-uptime" class="mb-0">--:--:--</h4>
                                <small class="text-muted">Uptime</small>
                            </div>
                            <div class="col-6 mb-3">
                                <h4 id="stat-memory" class="mb-0">-- MB</h4>
                                <small class="text-muted">Memory</small>
                            </div>
                            <div class="col-6">
                                <h4 id="stat-tps" class="mb-0">--</h4>
                                <small class="text-muted">TPS</small>
                            </div>
                            <div class="col-6">
                                <h4 id="stat-version" class="mb-0">--</h4>
                                <small class="text-muted">Version</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-light" onclick="createBackup()">
                                <i class="bi bi-download"></i> Create Backup
                            </button>
                            <button class="btn btn-outline-light" onclick="openWhitelist()">
                                <i class="bi bi-person-plus"></i> Manage Whitelist
                            </button>
                            <button class="btn btn-outline-light" onclick="openSchedule()">
                                <i class="bi bi-calendar"></i> Server Schedule
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs for Additional Features -->
        <div class="row mt-4">
            <div class="col-12">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-worlds">
                            <i class="bi bi-globe"></i> Worlds
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-backups">
                            <i class="bi bi-archive"></i> Backups
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-mods">
                            <i class="bi bi-puzzle"></i> Mods & Plugins
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config">
                            <i class="bi bi-sliders"></i> Configuration
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-whitelist">
                            <i class="bi bi-person-check"></i> Whitelist
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-bans">
                            <i class="bi bi-person-x"></i> Ban List
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-players">
                            <i class="bi bi-graph-up"></i> Player Stats
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-schedule">
                            <i class="bi bi-calendar-week"></i> Schedule
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Worlds Tab -->
                    <div class="tab-pane fade show active" id="tab-worlds">
                        <div class="card">
                            <div class="card-body">
                                <div class="row" id="worlds-list">
                                    <!-- World cards will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backups Tab -->
                    <div class="tab-pane fade" id="tab-backups">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Backup Management</h5>
                                <button class="btn btn-minecraft btn-sm" onclick="createBackup()">
                                    <i class="bi bi-plus"></i> New Backup
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="backups-list">
                                    <!-- Backup items will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mods Tab -->
                    <div class="tab-pane fade" id="tab-mods">
                        <div class="card">
                            <div class="card-body">
                                <h5>Performance Mods</h5>
                                <p class="text-muted">Enable/disable optimization mods</p>
                                <div id="performance-mods-list">
                                    <!-- Mod toggles will be inserted here -->
                                </div>
                                
                                <hr>
                                
                                <h5>Optional Mods</h5>
                                <p class="text-muted">Additional features</p>
                                <div id="optional-mods-list">
                                    <!-- Optional mod toggles will be inserted here -->
                                </div>
                                
                                <hr>
                                
                                <h5>Modpacks</h5>
                                <p class="text-muted">Switch to a different modpack</p>
                                <div class="row" id="modpacks-list">
                                    <!-- Modpack cards will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration Tab -->
                    <div class="tab-pane fade" id="tab-config">
                        <div class="card">
                            <div class="card-body">
                                <form id="server-config-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5>Server Settings</h5>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Server Type</label>
                                                <select class="form-select bg-dark text-light" id="config-server-type">
                                                    <option value="vanilla">Vanilla</option>
                                                    <option value="paper">PaperMC</option>
                                                    <option value="purpur">Purpur</option>
                                                    <option value="fabric">Fabric</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Minecraft Version</label>
                                                <input type="text" class="form-control bg-dark text-light" 
                                                       id="config-version" value="1.21.4">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Max Players</label>
                                                <input type="number" class="form-control bg-dark text-light" 
                                                       id="config-max-players" value="20">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">MOTD</label>
                                                <input type="text" class="form-control bg-dark text-light" 
                                                       id="config-motd" value="Sulfur Bot Minecraft Server">
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h5>Memory</h5>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Minimum RAM</label>
                                                <input type="text" class="form-control bg-dark text-light" 
                                                       id="config-mem-min" value="1G">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Maximum RAM</label>
                                                <input type="text" class="form-control bg-dark text-light" 
                                                       id="config-mem-max" value="4G">
                                            </div>
                                            
                                            <h5 class="mt-4">Schedule</h5>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Schedule Mode</label>
                                                <select class="form-select bg-dark text-light" id="config-schedule-mode">
                                                    <option value="always">Always On (24/7)</option>
                                                    <option value="timed">Timed (specific hours)</option>
                                                    <option value="weekdays_only">Weekdays Only</option>
                                                    <option value="weekends_only">Weekends Only</option>
                                                    <option value="custom">Custom Schedule</option>
                                                </select>
                                            </div>
                                            
                                            <div class="row" id="schedule-hours" style="display: none;">
                                                <div class="col-6">
                                                    <label class="form-label">Start Hour</label>
                                                    <input type="number" class="form-control bg-dark text-light" 
                                                           id="config-start-hour" value="6" min="0" max="23">
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label">End Hour</label>
                                                    <input type="number" class="form-control bg-dark text-light" 
                                                           id="config-end-hour" value="22" min="0" max="24">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <button type="submit" class="btn btn-minecraft">
                                            <i class="bi bi-save"></i> Save Configuration
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" onclick="downloadServerJar()">
                                            <i class="bi bi-download"></i> Download/Update Server
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Whitelist Tab -->
                    <div class="tab-pane fade" id="tab-whitelist">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Whitelist Management</h5>
                                <button class="btn btn-minecraft btn-sm" onclick="addToWhitelist()">
                                    <i class="bi bi-plus"></i> Add Player
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <h6>Pending Requests</h6>
                                    <div id="pending-requests">
                                        <p class="text-muted">No pending requests</p>
                                    </div>
                                </div>

                                <h6>Whitelisted Players</h6>
                                <div id="whitelist-players">
                                    <!-- Whitelist entries will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ban List Tab -->
                    <div class="tab-pane fade" id="tab-bans">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-person-x"></i> Ban Management</h5>
                                <button class="btn btn-danger btn-sm" onclick="openBanModal()">
                                    <i class="bi bi-plus"></i> Ban Player
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <input type="text" class="form-control bg-dark text-light"
                                           id="ban-search" placeholder="Search banned players..."
                                           onkeyup="filterBanList()">
                                </div>
                                <div id="ban-list">
                                    <p class="text-muted">Loading ban list...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Player Stats Tab -->
                    <div class="tab-pane fade" id="tab-players">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Player Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="stat-box text-center">
                                            <h3 id="stat-total-players">0</h3>
                                            <small class="text-muted">Total Players</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-box text-center">
                                            <h3 id="stat-total-playtime">0h</h3>
                                            <small class="text-muted">Total Playtime</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-box text-center">
                                            <h3 id="stat-avg-session">0m</h3>
                                            <small class="text-muted">Avg Session</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-box text-center">
                                            <h3 id="stat-peak-players">0</h3>
                                            <small class="text-muted">Peak Players</small>
                                        </div>
                                    </div>
                                </div>

                                <h6 class="mt-4 mb-3">Player Leaderboard</h6>
                                <div id="player-stats-list">
                                    <p class="text-muted">No player data available yet. Start the server to track players!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Schedule Tab -->
                    <div class="tab-pane fade" id="tab-schedule">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Weekly Schedule</h5>
                                <button class="btn btn-minecraft btn-sm" onclick="saveSchedule()">
                                    <i class="bi bi-save"></i> Save Schedule
                                </button>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Click on hours to toggle when the server should be running. Green = Online</p>

                                <div class="schedule-container">
                                    <div class="row mb-2">
                                        <div class="col-1"></div>
                                        <div class="col-11">
                                            <div class="d-flex justify-content-between px-2">
                                                <small>12am</small>
                                                <small>6am</small>
                                                <small>12pm</small>
                                                <small>6pm</small>
                                                <small>11pm</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="weekly-schedule">
                                        <!-- Schedule rows will be generated by JS -->
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <h6>Quick Presets</h6>
                                    <div class="btn-group flex-wrap">
                                        <button class="btn btn-outline-light btn-sm" onclick="setSchedulePreset('always')">
                                            <i class="bi bi-clock"></i> 24/7
                                        </button>
                                        <button class="btn btn-outline-light btn-sm" onclick="setSchedulePreset('daytime')">
                                            <i class="bi bi-sun"></i> Daytime (6am-10pm)
                                        </button>
                                        <button class="btn btn-outline-light btn-sm" onclick="setSchedulePreset('evening')">
                                            <i class="bi bi-moon"></i> Evening (4pm-12am)
                                        </button>
                                        <button class="btn btn-outline-light btn-sm" onclick="setSchedulePreset('weekends')">
                                            <i class="bi bi-calendar-check"></i> Weekends Only
                                        </button>
                                        <button class="btn btn-outline-light btn-sm" onclick="setSchedulePreset('none')">
                                            <i class="bi bi-x-circle"></i> Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="whitelistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Add to Whitelist</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Minecraft Username</label>
                        <input type="text" class="form-control bg-dark text-light" id="whitelist-username">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-minecraft" onclick="submitWhitelist()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban Modal -->
    <div class="modal fade" id="banModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header border-danger">
                    <h5 class="modal-title text-danger"><i class="bi bi-person-x"></i> Ban Player</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Minecraft Username</label>
                        <input type="text" class="form-control bg-dark text-light" id="ban-username" placeholder="Player name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <input type="text" class="form-control bg-dark text-light" id="ban-reason" placeholder="Reason for ban (optional)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duration</label>
                        <select class="form-select bg-dark text-light" id="ban-duration">
                            <option value="permanent">Permanent</option>
                            <option value="1h">1 Hour</option>
                            <option value="24h">24 Hours</option>
                            <option value="7d">7 Days</option>
                            <option value="30d">30 Days</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="submitBan()">
                        <i class="bi bi-person-x"></i> Ban Player
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        // Connect to WebSocket for real-time updates
        const socket = io();
        
        // Console state
        let lastConsoleLines = 0;
        let useWebSocket = true;
        let consolePollingInterval = null;
        
        // Request Minecraft console stream when connected
        socket.on('connect', function() {
            console.log('WebSocket connected');
            socket.emit('minecraft_console_connect');
            useWebSocket = true;
            // Stop HTTP polling if WebSocket works
            if (consolePollingInterval) {
                clearInterval(consolePollingInterval);
                consolePollingInterval = null;
            }
        });
        
        socket.on('connect_error', function(error) {
            console.log('WebSocket connection error:', error);
            useWebSocket = false;
            startConsolePolling();
        });
        
        socket.on('disconnect', function() {
            console.log('WebSocket disconnected');
            useWebSocket = false;
            startConsolePolling();
        });
        
        // Fallback: HTTP polling for console when WebSocket fails
        function startConsolePolling() {
            if (consolePollingInterval) return; // Already polling
            
            console.log('Starting HTTP console polling as WebSocket fallback');
            consolePollingInterval = setInterval(async function() {
                if (useWebSocket) return; // WebSocket recovered
                
                try {
                    const response = await fetch('/api/minecraft/console?lines=100');
                    const data = await response.json();
                    
                    if (data.lines && data.lines.length > lastConsoleLines) {
                        // Only show new lines
                        const newLines = data.lines.slice(lastConsoleLines);
                        newLines.forEach(line => appendToConsole(line));
                        lastConsoleLines = data.lines.length;
                    }
                } catch (error) {
                    console.error('Error polling console:', error);
                }
            }, 1000); // Poll every second
        }
        
        // Server state
        let serverStatus = {
            running: false,
            players: [],
            uptime: null
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            refreshModsAndModpacks();
            setInterval(refreshStatus, 5000);
            
            // Initial console fetch via HTTP (in case WebSocket is slow)
            fetchInitialConsole();
            
            // Schedule mode change handler
            document.getElementById('config-schedule-mode').addEventListener('change', function() {
                const hoursDiv = document.getElementById('schedule-hours');
                // Show hours for timed, weekdays_only, weekends_only, and custom modes
                const showHours = ['timed', 'weekdays_only', 'weekends_only', 'custom'].includes(this.value);
                hoursDiv.style.display = showHours ? 'flex' : 'none';
            });
            
            // Config form submission
            document.getElementById('server-config-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveConfig();
            });
        });
        
        async function fetchInitialConsole() {
            try {
                const response = await fetch('/api/minecraft/console?lines=50');
                const data = await response.json();
                
                if (data.lines && data.lines.length > 0) {
                    data.lines.forEach(line => appendToConsole(line));
                    lastConsoleLines = data.lines.length;
                }
            } catch (error) {
                console.error('Error fetching initial console:', error);
            }
        }
        
        // Mods and Modpacks Functions
        async function refreshModsAndModpacks() {
            try {
                // Fetch mods configuration
                const modsResponse = await fetch('/api/minecraft/mods');
                const modsData = await modsResponse.json();
                if (modsData.status === 'success') {
                    updateModsList(modsData);
                }
                
                // Fetch modpacks
                const modpacksResponse = await fetch('/api/minecraft/modpacks');
                const modpacksData = await modpacksResponse.json();
                if (modpacksData.status === 'success') {
                    updateModpacksList(modpacksData);
                }
            } catch (error) {
                console.error('Error fetching mods/modpacks:', error);
            }
        }
        
        function updateModsList(data) {
            // Update performance mods list using server-provided data
            const perfModsList = document.getElementById('performance-mods-list');
            if (data.performance_mods) {
                // Use the available mods from server config
                const availableMods = data.available_performance_mods || ['lithium', 'ferritecore', 'starlight', 'krypton', 'c2me', 'spark'];
                const enabledMods = data.performance_mods.mods || [];
                
                if (availableMods.length === 0 && enabledMods.length === 0) {
                    perfModsList.innerHTML = '<p class="text-muted">No performance mods configured</p>';
                } else {
                    // Show enabled mods first
                    const allMods = [...new Set([...enabledMods, ...availableMods])];
                    perfModsList.innerHTML = allMods.map(mod => {
                        const isEnabled = enabledMods.includes(mod);
                        return `
                            <button class="mod-toggle ${isEnabled ? 'active' : ''}" onclick="toggleMod('${mod}')">
                                <i class="bi bi-${isEnabled ? 'check-circle-fill text-success' : 'circle'}"></i>
                                ${mod.charAt(0).toUpperCase() + mod.slice(1)}
                            </button>
                        `;
                    }).join('');
                }
            } else {
                perfModsList.innerHTML = '<p class="text-muted">No performance mods configured</p>';
            }
            
            // Update optional mods list using server-provided data
            const optModsList = document.getElementById('optional-mods-list');
            if (data.optional_mods && Object.keys(data.optional_mods).length > 0) {
                // Display all optional mods from server
                optModsList.innerHTML = Object.entries(data.optional_mods).map(([key, modConfig]) => {
                    const isEnabled = modConfig.enabled || false;
                    const modName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const requiresClientMod = modConfig.requires_client_mod || false;
                    return `
                        <button class="mod-toggle ${isEnabled ? 'active' : ''}" onclick="toggleOptionalMod('${key}')">
                            <i class="bi bi-${isEnabled ? 'check-circle-fill text-success' : 'circle'}"></i>
                            <strong>${modName}</strong>
                            ${requiresClientMod ? '<span class="badge bg-warning ms-1">Client mod required</span>' : ''}
                        </button>
                    `;
                }).join('');
            } else {
                optModsList.innerHTML = '<p class="text-muted">No optional mods available</p>';
            }
        }
        
        function updateModpacksList(data) {
            const container = document.getElementById('modpacks-list');
            if (!data.modpacks || data.modpacks.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-muted">No modpacks available</p></div>';
                return;
            }
            
            container.innerHTML = data.modpacks.map(modpack => `
                <div class="col-md-4 mb-3">
                    <div class="card ${modpack.is_current ? 'border-success' : ''}">
                        <div class="card-body">
                            <h5>${modpack.name} ${modpack.is_current ? '<span class="badge bg-success">Active</span>' : ''}</h5>
                            <p class="text-muted small">${modpack.description}</p>
                            <div class="d-flex gap-2">
                                ${modpack.has_saved_world ? '<span class="badge bg-info">Has Saved World</span>' : ''}
                                <span class="badge bg-secondary">${modpack.server_type}</span>
                            </div>
                            <div class="mt-2">
                                ${!modpack.is_current ? `
                                    <button class="btn btn-sm btn-minecraft" onclick="switchModpack('${modpack.id}')" 
                                            ${serverStatus.running ? 'disabled title="Stop server first"' : ''}>
                                        <i class="bi bi-arrow-right-circle"></i> Switch
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function switchModpack(modpackName) {
            if (serverStatus.running) {
                alert('Please stop the server before switching modpacks.');
                return;
            }
            
            if (!confirm(`Switch to modpack "${modpackName}"? This will save your current world and load the modpack's world.`)) return;
            
            try {
                const response = await fetch('/api/minecraft/modpack/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ modpack: modpackName, save_current: true })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('Modpack switched successfully! Start the server to play.');
                    refreshModsAndModpacks();
                } else {
                    alert('Failed to switch modpack: ' + (data.message || data.errors?.join(', ')));
                }
            } catch (error) {
                console.error('Error switching modpack:', error);
                alert('Error switching modpack');
            }
        }
        
        async function toggleMod(modName) {
            // This would toggle a mod on/off - requires config update endpoint
            alert(`Mod toggling for ${modName} - this feature will update the server configuration.`);
        }
        
        async function toggleOptionalMod(modKey) {
            alert(`Optional mod toggling for ${modKey} - this feature will update the server configuration.`);
        }
        
        // Socket events
        socket.on('minecraft_console', function(data) {
            if (data.error) {
                appendToConsole('[ERROR] ' + data.error);
            } else if (data.line) {
                appendToConsole(data.line);
            }
        });
        
        socket.on('minecraft_status', function(data) {
            updateStatusUI(data);
        });
        
        // API Functions
        async function refreshStatus() {
            try {
                const response = await fetch('/api/minecraft/status');
                const data = await response.json();
                updateStatusUI(data);
                updateWorldsList(data.worlds || []);
                updateBackupsList(data.backups || []);
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }
        
        function updateStatusUI(data) {
            serverStatus = data;
            
            // Update status badge
            const badge = document.getElementById('status-badge');
            const startBtn = document.getElementById('btn-start');
            const stopBtn = document.getElementById('btn-stop');
            const restartBtn = document.getElementById('btn-restart');
            
            if (data.running) {
                badge.className = 'status-badge status-online';
                badge.innerHTML = '<i class="bi bi-circle-fill"></i> Online';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                restartBtn.disabled = false;
            } else if (data.status === 'starting') {
                badge.className = 'status-badge status-starting';
                badge.innerHTML = '<i class="bi bi-circle-fill"></i> Starting...';
                startBtn.disabled = true;
                stopBtn.disabled = true;
                restartBtn.disabled = true;
            } else {
                badge.className = 'status-badge status-offline';
                badge.innerHTML = '<i class="bi bi-circle-fill"></i> Offline';
                startBtn.disabled = false;
                stopBtn.disabled = true;
                restartBtn.disabled = true;
            }
            
            // Update server info
            document.getElementById('server-info').textContent = 
                `${data.server_type || 'Unknown'} ${data.version || ''} | Port: ${data.port || 25565}`;
            
            // Update stats
            document.getElementById('stat-uptime').textContent = data.uptime || '--:--:--';
            document.getElementById('stat-version').textContent = data.version || '--';
            
            // Update player count
            document.getElementById('player-count').textContent = data.player_count || 0;
            
            // Update player list
            const playerList = document.getElementById('player-list');
            if (data.players && data.players.length > 0) {
                playerList.innerHTML = data.players.map(player => `
                    <div class="player-card">
                        <i class="bi bi-person-fill"></i> ${player}
                    </div>
                `).join('');
            } else {
                playerList.innerHTML = '<p class="text-muted mb-0">No players online</p>';
            }
        }
        
        function updateWorldsList(worlds) {
            const container = document.getElementById('worlds-list');
            if (worlds.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-muted">No worlds found</p></div>';
                return;
            }
            
            container.innerHTML = worlds.map(world => `
                <div class="col-md-4 mb-3">
                    <div class="card world-card">
                        <div class="card-body">
                            <h5><i class="bi bi-globe"></i> ${world.name}</h5>
                            <p class="text-muted mb-2">${world.size_mb} MB</p>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteWorld('${world.name}')"
                                    ${serverStatus.running ? 'disabled' : ''}>
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateBackupsList(backups) {
            const container = document.getElementById('backups-list');
            if (backups.length === 0) {
                container.innerHTML = '<p class="text-muted">No backups found</p>';
                return;
            }
            
            container.innerHTML = backups.map(backup => `
                <div class="backup-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${backup.filename}</strong>
                        <br>
                        <small class="text-muted">${backup.size_mb} MB - ${backup.created}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-light" onclick="restoreBackup('${backup.path}')">
                            <i class="bi bi-arrow-counterclockwise"></i> Restore
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup('${backup.path}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Console Functions
        function appendToConsole(line) {
            const console = document.getElementById('console-output');
            const p = document.createElement('p');
            p.className = 'mb-0';
            p.textContent = line;
            console.appendChild(p);
            console.scrollTop = console.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }
        
        function handleCommandInput(event) {
            if (event.key === 'Enter') {
                sendCommand();
            }
        }
        
        async function sendCommand() {
            const input = document.getElementById('console-input');
            const command = input.value.trim();
            
            if (!command) return;
            
            try {
                await fetch('/api/minecraft/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command })
                });
                
                appendToConsole('> ' + command);
                input.value = '';
            } catch (error) {
                console.error('Error sending command:', error);
            }
        }
        
        // Server Control Functions
        async function startServer() {
            try {
                const response = await fetch('/api/minecraft/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    appendToConsole('[Dashboard] Server starting...');
                } else {
                    alert('Failed to start server: ' + data.error);
                }
            } catch (error) {
                console.error('Error starting server:', error);
            }
        }
        
        async function stopServer() {
            if (!confirm('Are you sure you want to stop the server?')) return;
            
            try {
                const response = await fetch('/api/minecraft/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    appendToConsole('[Dashboard] Server stopping...');
                } else {
                    alert('Failed to stop server: ' + data.error);
                }
            } catch (error) {
                console.error('Error stopping server:', error);
            }
        }
        
        async function restartServer() {
            if (!confirm('Are you sure you want to restart the server?')) return;
            
            try {
                const response = await fetch('/api/minecraft/restart', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    appendToConsole('[Dashboard] Server restarting...');
                } else {
                    alert('Failed to restart server: ' + data.error);
                }
            } catch (error) {
                console.error('Error restarting server:', error);
            }
        }
        
        // Backup Functions
        async function createBackup() {
            try {
                const response = await fetch('/api/minecraft/backup', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('Backup created successfully!');
                    refreshStatus();
                } else {
                    alert('Failed to create backup: ' + data.error);
                }
            } catch (error) {
                console.error('Error creating backup:', error);
            }
        }
        
        async function restoreBackup(path) {
            if (!confirm('This will replace the current world. Are you sure?')) return;
            if (serverStatus.running) {
                alert('Please stop the server before restoring a backup.');
                return;
            }
            
            try {
                const response = await fetch('/api/minecraft/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Backup restored successfully!');
                } else {
                    alert('Failed to restore backup: ' + data.error);
                }
            } catch (error) {
                console.error('Error restoring backup:', error);
            }
        }
        
        // World Functions
        async function deleteWorld(name) {
            if (!confirm(`Are you sure you want to delete the world "${name}"? This cannot be undone!`)) return;
            if (serverStatus.running) {
                alert('Please stop the server before deleting worlds.');
                return;
            }
            
            try {
                const response = await fetch('/api/minecraft/world/' + name, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    alert('World deleted successfully!');
                    refreshStatus();
                } else {
                    alert('Failed to delete world: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting world:', error);
            }
        }
        
        // Whitelist Functions
        function addToWhitelist() {
            const modal = new bootstrap.Modal(document.getElementById('whitelistModal'));
            modal.show();
        }
        
        async function submitWhitelist() {
            const username = document.getElementById('whitelist-username').value.trim();
            if (!username) return;
            
            try {
                const response = await fetch('/api/minecraft/whitelist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Player added to whitelist!');
                    bootstrap.Modal.getInstance(document.getElementById('whitelistModal')).hide();
                    refreshStatus();
                } else {
                    alert('Failed to add to whitelist: ' + data.error);
                }
            } catch (error) {
                console.error('Error adding to whitelist:', error);
            }
        }
        
        // Config Functions
        async function saveConfig() {
            const config = {
                server_type: document.getElementById('config-server-type').value,
                minecraft_version: document.getElementById('config-version').value,
                max_players: parseInt(document.getElementById('config-max-players').value),
                motd: document.getElementById('config-motd').value,
                memory_min: document.getElementById('config-mem-min').value,
                memory_max: document.getElementById('config-mem-max').value,
                schedule: {
                    mode: document.getElementById('config-schedule-mode').value,
                    start_hour: parseInt(document.getElementById('config-start-hour').value),
                    end_hour: parseInt(document.getElementById('config-end-hour').value)
                }
            };
            
            try {
                const response = await fetch('/api/minecraft/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Configuration saved!');
                } else {
                    alert('Failed to save configuration: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving config:', error);
            }
        }
        
        async function downloadServerJar() {
            if (!confirm('This will download/update the Minecraft server JAR. Continue?')) return;
            
            try {
                const response = await fetch('/api/minecraft/download', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('Server download started!');
                } else {
                    alert('Failed to start download: ' + data.error);
                }
            } catch (error) {
                console.error('Error downloading server:', error);
            }
        }
        
        // Utility functions
        function openWhitelist() {
            document.querySelector('[data-bs-target="#tab-whitelist"]').click();
        }

        function openSchedule() {
            document.querySelector('[data-bs-target="#tab-schedule"]').click();
        }

        // ===== Weekly Schedule Functions =====
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        let weeklySchedule = {};

        function initWeeklySchedule() {
            days.forEach(day => {
                weeklySchedule[day] = new Array(24).fill(false);
            });

            const container = document.getElementById('weekly-schedule');
            container.innerHTML = days.map(day => `
                <div class="row mb-1 align-items-center">
                    <div class="col-1">
                        <strong>${day}</strong>
                    </div>
                    <div class="col-11">
                        ${Array.from({length: 24}, (_, hour) => `
                            <span class="schedule-hour"
                                  id="sched-${day}-${hour}"
                                  onclick="toggleScheduleHour('${day}', ${hour})"
                                  title="${hour}:00 - ${hour+1}:00">
                                ${hour}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Load saved schedule
            loadScheduleFromServer();
        }

        function toggleScheduleHour(day, hour) {
            weeklySchedule[day][hour] = !weeklySchedule[day][hour];
            const el = document.getElementById(`sched-${day}-${hour}`);
            el.classList.toggle('active', weeklySchedule[day][hour]);
        }

        function setSchedulePreset(preset) {
            days.forEach(day => {
                for (let h = 0; h < 24; h++) {
                    let active = false;
                    switch(preset) {
                        case 'always':
                            active = true;
                            break;
                        case 'daytime':
                            active = h >= 6 && h < 22;
                            break;
                        case 'evening':
                            active = h >= 16 || h < 1;
                            break;
                        case 'weekends':
                            active = (day === 'Sat' || day === 'Sun');
                            break;
                        case 'none':
                            active = false;
                            break;
                    }
                    weeklySchedule[day][h] = active;
                    document.getElementById(`sched-${day}-${h}`).classList.toggle('active', active);
                }
            });
        }

        async function loadScheduleFromServer() {
            try {
                const response = await fetch('/api/minecraft/config');
                const data = await response.json();
                if (data.schedule && data.schedule.weekly) {
                    days.forEach(day => {
                        if (data.schedule.weekly[day]) {
                            data.schedule.weekly[day].forEach(hour => {
                                if (hour >= 0 && hour < 24) {
                                    weeklySchedule[day][hour] = true;
                                    document.getElementById(`sched-${day}-${hour}`).classList.add('active');
                                }
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        async function saveSchedule() {
            const scheduleData = {};
            days.forEach(day => {
                scheduleData[day] = weeklySchedule[day]
                    .map((active, hour) => active ? hour : -1)
                    .filter(h => h >= 0);
            });

            try {
                const response = await fetch('/api/minecraft/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schedule: {
                            mode: 'custom',
                            weekly: scheduleData
                        }
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Schedule saved successfully!');
                } else {
                    alert('Failed to save schedule: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving schedule:', error);
                alert('Error saving schedule');
            }
        }

        // ===== Ban List Functions =====
        let banList = [];

        async function loadBanList() {
            try {
                const response = await fetch('/api/minecraft/bans');
                const data = await response.json();
                if (data.bans) {
                    banList = data.bans;
                    renderBanList();
                }
            } catch (error) {
                console.error('Error loading ban list:', error);
                document.getElementById('ban-list').innerHTML = '<p class="text-muted">Could not load ban list</p>';
            }
        }

        function renderBanList() {
            const container = document.getElementById('ban-list');
            if (banList.length === 0) {
                container.innerHTML = '<p class="text-muted">No banned players</p>';
                return;
            }

            container.innerHTML = banList.map(ban => `
                <div class="ban-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-danger"><i class="bi bi-person-x"></i> ${ban.name || ban.username}</strong>
                        ${ban.reason ? `<br><small class="text-muted">Reason: ${ban.reason}</small>` : ''}
                        ${ban.expires ? `<br><small class="text-warning">Expires: ${new Date(ban.expires).toLocaleString()}</small>` : '<br><small class="text-danger">Permanent</small>'}
                    </div>
                    <button class="btn btn-sm btn-outline-success" onclick="unbanPlayer('${ban.name || ban.username}')">
                        <i class="bi bi-person-check"></i> Unban
                    </button>
                </div>
            `).join('');
        }

        function filterBanList() {
            const search = document.getElementById('ban-search').value.toLowerCase();
            const filtered = banList.filter(ban =>
                (ban.name || ban.username || '').toLowerCase().includes(search) ||
                (ban.reason || '').toLowerCase().includes(search)
            );

            const container = document.getElementById('ban-list');
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-muted">No matching players</p>';
                return;
            }

            container.innerHTML = filtered.map(ban => `
                <div class="ban-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-danger"><i class="bi bi-person-x"></i> ${ban.name || ban.username}</strong>
                        ${ban.reason ? `<br><small class="text-muted">Reason: ${ban.reason}</small>` : ''}
                    </div>
                    <button class="btn btn-sm btn-outline-success" onclick="unbanPlayer('${ban.name || ban.username}')">
                        <i class="bi bi-person-check"></i> Unban
                    </button>
                </div>
            `).join('');
        }

        function openBanModal() {
            document.getElementById('ban-username').value = '';
            document.getElementById('ban-reason').value = '';
            document.getElementById('ban-duration').value = 'permanent';
            const modal = new bootstrap.Modal(document.getElementById('banModal'));
            modal.show();
        }

        async function submitBan() {
            const username = document.getElementById('ban-username').value.trim();
            const reason = document.getElementById('ban-reason').value.trim();
            const duration = document.getElementById('ban-duration').value;

            if (!username) {
                alert('Please enter a username');
                return;
            }

            try {
                const response = await fetch('/api/minecraft/ban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, reason, duration })
                });
                const data = await response.json();

                if (data.success) {
                    alert(`Player ${username} has been banned!`);
                    bootstrap.Modal.getInstance(document.getElementById('banModal')).hide();
                    loadBanList();
                } else {
                    alert('Failed to ban player: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error banning player:', error);
                alert('Error banning player');
            }
        }

        async function unbanPlayer(username) {
            if (!confirm(`Are you sure you want to unban ${username}?`)) return;

            try {
                const response = await fetch('/api/minecraft/unban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await response.json();

                if (data.success) {
                    alert(`Player ${username} has been unbanned!`);
                    loadBanList();
                } else {
                    alert('Failed to unban player: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error unbanning player:', error);
                alert('Error unbanning player');
            }
        }

        // ===== Player Stats Functions =====
        async function loadPlayerStats() {
            try {
                const response = await fetch('/api/minecraft/player-stats');
                const data = await response.json();

                if (data.stats) {
                    document.getElementById('stat-total-players').textContent = data.stats.total_players || 0;
                    document.getElementById('stat-total-playtime').textContent = formatPlaytime(data.stats.total_playtime_minutes || 0);
                    document.getElementById('stat-avg-session').textContent = (data.stats.avg_session_minutes || 0) + 'm';
                    document.getElementById('stat-peak-players').textContent = data.stats.peak_players || 0;
                }

                if (data.players && data.players.length > 0) {
                    const container = document.getElementById('player-stats-list');
                    container.innerHTML = data.players.map((player, index) => `
                        <div class="player-stats-card d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-secondary me-2">#${index + 1}</span>
                                <strong>${player.username}</strong>
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> ${formatPlaytime(player.playtime_minutes)}
                                    | <i class="bi bi-calendar"></i> ${player.sessions || 0} sessions
                                    | Last: ${player.last_seen ? formatTimeAgo(player.last_seen) : 'Never'}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge ${player.online ? 'bg-success' : 'bg-secondary'}">
                                    ${player.online ? 'Online' : 'Offline'}
                                </span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading player stats:', error);
            }
        }

        function formatPlaytime(minutes) {
            if (minutes < 60) return minutes + 'm';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours < 24) return hours + 'h ' + mins + 'm';
            const days = Math.floor(hours / 24);
            return days + 'd ' + (hours % 24) + 'h';
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + 'm ago';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'h ago';
            const days = Math.floor(hours / 24);
            return days + 'd ago';
        }

        // ===== Whitelist Functions =====
        async function loadWhitelist() {
            try {
                const response = await fetch('/api/minecraft/whitelist');
                const data = await response.json();
                
                const container = document.getElementById('whitelist-players');
                
                if (data.error) {
                    container.innerHTML = '<p class="text-danger">Error loading whitelist: ' + data.error + '</p>';
                    return;
                }
                
                if (!data.whitelist || data.whitelist.length === 0) {
                    container.innerHTML = '<p class="text-muted">No players on whitelist</p>';
                    return;
                }
                
                container.innerHTML = data.whitelist.map(player => `
                    <div class="player-stats-card d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong><i class="bi bi-person-check-fill text-success"></i> ${player.name}</strong>
                            ${player.uuid ? `<br><small class="text-muted">UUID: ${player.uuid}</small>` : ''}
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromWhitelist('${player.name}')">
                            <i class="bi bi-x"></i> Remove
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading whitelist:', error);
                document.getElementById('whitelist-players').innerHTML = '<p class="text-danger">Failed to load whitelist</p>';
            }
        }

        async function removeFromWhitelist(username) {
            if (!confirm(`Remove ${username} from whitelist?`)) return;
            
            try {
                const response = await fetch(`/api/minecraft/whitelist/${username}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`${username} removed from whitelist!`);
                    loadWhitelist(); // Reload list
                } else {
                    alert('Failed to remove: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error removing from whitelist:', error);
                alert('Error removing from whitelist');
            }
        }

        // Initialize new features on page load
        document.addEventListener('DOMContentLoaded', function() {
            initWeeklySchedule();
            loadBanList();
            loadPlayerStats();
            loadWhitelist();
        });
    </script>
</body>
</html>
