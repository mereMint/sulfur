<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Server - Sulfur Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a2e;
            color: #eee;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            border-bottom: 1px solid #0f3460;
        }
        
        .card {
            background-color: #16213e;
            border: 1px solid #0f3460;
            border-radius: 12px;
        }
        
        .card-header {
            background-color: #0f3460;
            border-bottom: 1px solid #0f3460;
            border-radius: 12px 12px 0 0 !important;
        }
        
        .btn-minecraft {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            color: white;
        }
        
        .btn-minecraft:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            color: white;
        }
        
        .btn-danger-minecraft {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            border: none;
        }
        
        .console-output {
            background-color: #0a0a0a;
            color: #00ff00;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        
        .console-input {
            background-color: #0a0a0a;
            color: #00ff00;
            border: 1px solid #333;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .console-input:focus {
            background-color: #0a0a0a;
            color: #00ff00;
            border-color: #4CAF50;
            box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
        }
        
        .status-badge {
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 20px;
        }
        
        .status-online {
            background-color: #4CAF50;
            color: white;
        }
        
        .status-offline {
            background-color: #f44336;
            color: white;
        }
        
        .status-starting {
            background-color: #ff9800;
            color: white;
        }
        
        .player-card {
            background-color: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
        }
        
        .world-card {
            transition: transform 0.2s;
        }
        
        .world-card:hover {
            transform: translateY(-2px);
        }
        
        .backup-item {
            background-color: #1a1a2e;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
        }
        
        .mod-toggle {
            width: 100%;
            text-align: left;
            background-color: #1a1a2e;
            border: 1px solid #0f3460;
            color: #eee;
            padding: 12px 15px;
            border-radius: 8px;
            margin: 5px 0;
        }
        
        .mod-toggle:hover {
            background-color: #0f3460;
        }
        
        .mod-toggle.active {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .nav-tabs .nav-link {
            color: #aaa;
            border: none;
            border-bottom: 2px solid transparent;
        }
        
        .nav-tabs .nav-link:hover {
            color: #eee;
            border-color: transparent;
        }
        
        .nav-tabs .nav-link.active {
            color: #4CAF50;
            background-color: transparent;
            border-bottom: 2px solid #4CAF50;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .schedule-day {
            text-align: center;
            padding: 10px;
            background-color: #1a1a2e;
            border-radius: 8px;
            border: 1px solid #0f3460;
        }
        
        .schedule-day.active {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        /* Fix form label readability - ensure white/light text on dark backgrounds */
        .form-label {
            color: #eee !important;
        }
        
        /* Ensure card body text is readable */
        .card-body {
            color: #eee;
        }
        
        /* Fix select/input text color on dark backgrounds */
        .form-select.bg-dark, 
        .form-control.bg-dark {
            color: #f8f9fa !important;
        }
        
        /* Fix text-muted to be more visible */
        .text-muted {
            color: #a0a0a0 !important;
        }
        
        /* Ensure h5, h6 headings are readable */
        .card-body h5, .card-body h6 {
            color: #fff;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-robot"></i> Sulfur Bot
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="bi bi-house"></i> Dashboard</a>
                <a class="nav-link" href="/config"><i class="bi bi-gear"></i> Config</a>
                <a class="nav-link active" href="/minecraft"><i class="bi bi-controller"></i> Minecraft</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Status Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="bi bi-controller"></i> Minecraft Server
                            </h4>
                            <small class="text-muted" id="server-info">Loading...</small>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span id="status-badge" class="status-badge status-offline">
                                <i class="bi bi-circle-fill"></i> Offline
                            </span>
                            <div class="btn-group">
                                <button id="btn-start" class="btn btn-minecraft" onclick="startServer()">
                                    <i class="bi bi-play-fill"></i> Start
                                </button>
                                <button id="btn-stop" class="btn btn-danger-minecraft" onclick="stopServer()" disabled>
                                    <i class="bi bi-stop-fill"></i> Stop
                                </button>
                                <button id="btn-restart" class="btn btn-warning" onclick="restartServer()" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Restart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Console Panel -->
            <div class="col-lg-8 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> Server Console</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="clearConsole()">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="console-output" class="console-output">
                            <p class="text-muted">Console output will appear here when the server is running...</p>
                        </div>
                        <div class="input-group mt-3">
                            <span class="input-group-text bg-dark text-success border-dark">></span>
                            <input type="text" id="console-input" class="form-control console-input" 
                                   placeholder="Enter server command..." 
                                   onkeypress="handleCommandInput(event)">
                            <button class="btn btn-minecraft" onclick="sendCommand()">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="col-lg-4">
                <!-- Players Online -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-people"></i> Players Online 
                            <span id="player-count" class="badge bg-secondary">0</span>
                        </h5>
                    </div>
                    <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                        <div id="player-list">
                            <p class="text-muted mb-0">No players online</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Server Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <h4 id="stat-uptime" class="mb-0">--:--:--</h4>
                                <small class="text-muted">Uptime</small>
                            </div>
                            <div class="col-6 mb-3">
                                <h4 id="stat-memory" class="mb-0">-- MB</h4>
                                <small class="text-muted">Memory</small>
                            </div>
                            <div class="col-6">
                                <h4 id="stat-tps" class="mb-0">--</h4>
                                <small class="text-muted">TPS</small>
                            </div>
                            <div class="col-6">
                                <h4 id="stat-version" class="mb-0">--</h4>
                                <small class="text-muted">Version</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-light" onclick="createBackup()">
                                <i class="bi bi-download"></i> Create Backup
                            </button>
                            <button class="btn btn-outline-light" onclick="openWhitelist()">
                                <i class="bi bi-person-plus"></i> Manage Whitelist
                            </button>
                            <button class="btn btn-outline-light" onclick="openSchedule()">
                                <i class="bi bi-calendar"></i> Server Schedule
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs for Additional Features -->
        <div class="row mt-4">
            <div class="col-12">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-worlds">
                            <i class="bi bi-globe"></i> Worlds
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-backups">
                            <i class="bi bi-archive"></i> Backups
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-mods">
                            <i class="bi bi-puzzle"></i> Mods & Plugins
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config">
                            <i class="bi bi-sliders"></i> Configuration
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-whitelist">
                            <i class="bi bi-person-check"></i> Whitelist
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Worlds Tab -->
                    <div class="tab-pane fade show active" id="tab-worlds">
                        <div class="card">
                            <div class="card-body">
                                <div class="row" id="worlds-list">
                                    <!-- World cards will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backups Tab -->
                    <div class="tab-pane fade" id="tab-backups">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Backup Management</h5>
                                <button class="btn btn-minecraft btn-sm" onclick="createBackup()">
                                    <i class="bi bi-plus"></i> New Backup
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="backups-list">
                                    <!-- Backup items will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mods Tab -->
                    <div class="tab-pane fade" id="tab-mods">
                        <div class="card">
                            <div class="card-body">
                                <h5>Performance Mods</h5>
                                <p class="text-muted">Enable/disable optimization mods</p>
                                <div id="performance-mods-list">
                                    <!-- Mod toggles will be inserted here -->
                                </div>
                                
                                <hr>
                                
                                <h5>Optional Mods</h5>
                                <p class="text-muted">Additional features</p>
                                <div id="optional-mods-list">
                                    <!-- Optional mod toggles will be inserted here -->
                                </div>
                                
                                <hr>
                                
                                <h5>Modpacks</h5>
                                <p class="text-muted">Switch to a different modpack</p>
                                <div class="row" id="modpacks-list">
                                    <!-- Modpack cards will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration Tab -->
                    <div class="tab-pane fade" id="tab-config">
                        <div class="card">
                            <div class="card-body">
                                <form id="server-config-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5>Server Settings</h5>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Server Type</label>
                                                <select class="form-select bg-dark text-light" id="config-server-type">
                                                    <option value="vanilla">Vanilla</option>
                                                    <option value="paper">PaperMC</option>
                                                    <option value="purpur">Purpur</option>
                                                    <option value="fabric">Fabric</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Minecraft Version</label>
                                                <input type="text" class="form-control bg-dark text-light" 
                                                       id="config-version" value="1.21.4">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Max Players</label>
                                                <input type="number" class="form-control bg-dark text-light" 
                                                       id="config-max-players" value="20">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">MOTD</label>
                                                <input type="text" class="form-control bg-dark text-light" 
                                                       id="config-motd" value="Sulfur Bot Minecraft Server">
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h5>Memory</h5>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Minimum RAM</label>
                                                <input type="text" class="form-control bg-dark text-light" 
                                                       id="config-mem-min" value="1G">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Maximum RAM</label>
                                                <input type="text" class="form-control bg-dark text-light" 
                                                       id="config-mem-max" value="4G">
                                            </div>
                                            
                                            <h5 class="mt-4">Schedule</h5>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Schedule Mode</label>
                                                <select class="form-select bg-dark text-light" id="config-schedule-mode">
                                                    <option value="always">Always On (24/7)</option>
                                                    <option value="timed">Timed (specific hours)</option>
                                                    <option value="weekdays_only">Weekdays Only</option>
                                                    <option value="weekends_only">Weekends Only</option>
                                                    <option value="custom">Custom Schedule</option>
                                                </select>
                                            </div>
                                            
                                            <div class="row" id="schedule-hours" style="display: none;">
                                                <div class="col-6">
                                                    <label class="form-label">Start Hour</label>
                                                    <input type="number" class="form-control bg-dark text-light" 
                                                           id="config-start-hour" value="6" min="0" max="23">
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label">End Hour</label>
                                                    <input type="number" class="form-control bg-dark text-light" 
                                                           id="config-end-hour" value="22" min="0" max="24">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <button type="submit" class="btn btn-minecraft">
                                            <i class="bi bi-save"></i> Save Configuration
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" onclick="downloadServerJar()">
                                            <i class="bi bi-download"></i> Download/Update Server
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Whitelist Tab -->
                    <div class="tab-pane fade" id="tab-whitelist">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Whitelist Management</h5>
                                <button class="btn btn-minecraft btn-sm" onclick="addToWhitelist()">
                                    <i class="bi bi-plus"></i> Add Player
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <h6>Pending Requests</h6>
                                    <div id="pending-requests">
                                        <p class="text-muted">No pending requests</p>
                                    </div>
                                </div>
                                
                                <h6>Whitelisted Players</h6>
                                <div id="whitelist-players">
                                    <!-- Whitelist entries will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="whitelistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Add to Whitelist</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Minecraft Username</label>
                        <input type="text" class="form-control bg-dark text-light" id="whitelist-username">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-minecraft" onclick="submitWhitelist()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        // Connect to WebSocket for real-time updates
        const socket = io();
        
        // Request Minecraft console stream when connected
        socket.on('connect', function() {
            console.log('WebSocket connected');
            socket.emit('minecraft_console_connect');
        });
        
        // Server state
        let serverStatus = {
            running: false,
            players: [],
            uptime: null
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            refreshModsAndModpacks();
            setInterval(refreshStatus, 5000);
            
            // Schedule mode change handler
            document.getElementById('config-schedule-mode').addEventListener('change', function() {
                const hoursDiv = document.getElementById('schedule-hours');
                hoursDiv.style.display = this.value === 'timed' ? 'flex' : 'none';
            });
            
            // Config form submission
            document.getElementById('server-config-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveConfig();
            });
        });
        
        // Mods and Modpacks Functions
        async function refreshModsAndModpacks() {
            try {
                // Fetch mods configuration
                const modsResponse = await fetch('/api/minecraft/mods');
                const modsData = await modsResponse.json();
                if (modsData.status === 'success') {
                    updateModsList(modsData);
                }
                
                // Fetch modpacks
                const modpacksResponse = await fetch('/api/minecraft/modpacks');
                const modpacksData = await modpacksResponse.json();
                if (modpacksData.status === 'success') {
                    updateModpacksList(modpacksData);
                }
            } catch (error) {
                console.error('Error fetching mods/modpacks:', error);
            }
        }
        
        function updateModsList(data) {
            // Update performance mods list using server-provided data
            const perfModsList = document.getElementById('performance-mods-list');
            if (data.performance_mods) {
                // Use the available mods from server config
                const availableMods = data.available_performance_mods || ['lithium', 'ferritecore', 'starlight', 'krypton', 'c2me', 'spark'];
                const enabledMods = data.performance_mods.mods || [];
                
                if (availableMods.length === 0 && enabledMods.length === 0) {
                    perfModsList.innerHTML = '<p class="text-muted">No performance mods configured</p>';
                } else {
                    // Show enabled mods first
                    const allMods = [...new Set([...enabledMods, ...availableMods])];
                    perfModsList.innerHTML = allMods.map(mod => {
                        const isEnabled = enabledMods.includes(mod);
                        return `
                            <button class="mod-toggle ${isEnabled ? 'active' : ''}" onclick="toggleMod('${mod}')">
                                <i class="bi bi-${isEnabled ? 'check-circle-fill text-success' : 'circle'}"></i>
                                ${mod.charAt(0).toUpperCase() + mod.slice(1)}
                            </button>
                        `;
                    }).join('');
                }
            } else {
                perfModsList.innerHTML = '<p class="text-muted">No performance mods configured</p>';
            }
            
            // Update optional mods list using server-provided data
            const optModsList = document.getElementById('optional-mods-list');
            if (data.optional_mods && Object.keys(data.optional_mods).length > 0) {
                // Display all optional mods from server
                optModsList.innerHTML = Object.entries(data.optional_mods).map(([key, modConfig]) => {
                    const isEnabled = modConfig.enabled || false;
                    const modName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const requiresClientMod = modConfig.requires_client_mod || false;
                    return `
                        <button class="mod-toggle ${isEnabled ? 'active' : ''}" onclick="toggleOptionalMod('${key}')">
                            <i class="bi bi-${isEnabled ? 'check-circle-fill text-success' : 'circle'}"></i>
                            <strong>${modName}</strong>
                            ${requiresClientMod ? '<span class="badge bg-warning ms-1">Client mod required</span>' : ''}
                        </button>
                    `;
                }).join('');
            } else {
                optModsList.innerHTML = '<p class="text-muted">No optional mods available</p>';
            }
        }
        
        function updateModpacksList(data) {
            const container = document.getElementById('modpacks-list');
            if (!data.modpacks || data.modpacks.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-muted">No modpacks available</p></div>';
                return;
            }
            
            container.innerHTML = data.modpacks.map(modpack => `
                <div class="col-md-4 mb-3">
                    <div class="card ${modpack.is_current ? 'border-success' : ''}">
                        <div class="card-body">
                            <h5>${modpack.name} ${modpack.is_current ? '<span class="badge bg-success">Active</span>' : ''}</h5>
                            <p class="text-muted small">${modpack.description}</p>
                            <div class="d-flex gap-2">
                                ${modpack.has_saved_world ? '<span class="badge bg-info">Has Saved World</span>' : ''}
                                <span class="badge bg-secondary">${modpack.server_type}</span>
                            </div>
                            <div class="mt-2">
                                ${!modpack.is_current ? `
                                    <button class="btn btn-sm btn-minecraft" onclick="switchModpack('${modpack.id}')" 
                                            ${serverStatus.running ? 'disabled title="Stop server first"' : ''}>
                                        <i class="bi bi-arrow-right-circle"></i> Switch
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function switchModpack(modpackName) {
            if (serverStatus.running) {
                alert('Please stop the server before switching modpacks.');
                return;
            }
            
            if (!confirm(`Switch to modpack "${modpackName}"? This will save your current world and load the modpack's world.`)) return;
            
            try {
                const response = await fetch('/api/minecraft/modpack/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ modpack: modpackName, save_current: true })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('Modpack switched successfully! Start the server to play.');
                    refreshModsAndModpacks();
                } else {
                    alert('Failed to switch modpack: ' + (data.message || data.errors?.join(', ')));
                }
            } catch (error) {
                console.error('Error switching modpack:', error);
                alert('Error switching modpack');
            }
        }
        
        async function toggleMod(modName) {
            // This would toggle a mod on/off - requires config update endpoint
            alert(`Mod toggling for ${modName} - this feature will update the server configuration.`);
        }
        
        async function toggleOptionalMod(modKey) {
            alert(`Optional mod toggling for ${modKey} - this feature will update the server configuration.`);
        }
        
        // Socket events
        socket.on('minecraft_console', function(data) {
            appendToConsole(data.line);
        });
        
        socket.on('minecraft_status', function(data) {
            updateStatusUI(data);
        });
        
        // API Functions
        async function refreshStatus() {
            try {
                const response = await fetch('/api/minecraft/status');
                const data = await response.json();
                updateStatusUI(data);
                updateWorldsList(data.worlds || []);
                updateBackupsList(data.backups || []);
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }
        
        function updateStatusUI(data) {
            serverStatus = data;
            
            // Update status badge
            const badge = document.getElementById('status-badge');
            const startBtn = document.getElementById('btn-start');
            const stopBtn = document.getElementById('btn-stop');
            const restartBtn = document.getElementById('btn-restart');
            
            if (data.running) {
                badge.className = 'status-badge status-online';
                badge.innerHTML = '<i class="bi bi-circle-fill"></i> Online';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                restartBtn.disabled = false;
            } else if (data.status === 'starting') {
                badge.className = 'status-badge status-starting';
                badge.innerHTML = '<i class="bi bi-circle-fill"></i> Starting...';
                startBtn.disabled = true;
                stopBtn.disabled = true;
                restartBtn.disabled = true;
            } else {
                badge.className = 'status-badge status-offline';
                badge.innerHTML = '<i class="bi bi-circle-fill"></i> Offline';
                startBtn.disabled = false;
                stopBtn.disabled = true;
                restartBtn.disabled = true;
            }
            
            // Update server info
            document.getElementById('server-info').textContent = 
                `${data.server_type || 'Unknown'} ${data.version || ''} | Port: ${data.port || 25565}`;
            
            // Update stats
            document.getElementById('stat-uptime').textContent = data.uptime || '--:--:--';
            document.getElementById('stat-version').textContent = data.version || '--';
            
            // Update player count
            document.getElementById('player-count').textContent = data.player_count || 0;
            
            // Update player list
            const playerList = document.getElementById('player-list');
            if (data.players && data.players.length > 0) {
                playerList.innerHTML = data.players.map(player => `
                    <div class="player-card">
                        <i class="bi bi-person-fill"></i> ${player}
                    </div>
                `).join('');
            } else {
                playerList.innerHTML = '<p class="text-muted mb-0">No players online</p>';
            }
        }
        
        function updateWorldsList(worlds) {
            const container = document.getElementById('worlds-list');
            if (worlds.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-muted">No worlds found</p></div>';
                return;
            }
            
            container.innerHTML = worlds.map(world => `
                <div class="col-md-4 mb-3">
                    <div class="card world-card">
                        <div class="card-body">
                            <h5><i class="bi bi-globe"></i> ${world.name}</h5>
                            <p class="text-muted mb-2">${world.size_mb} MB</p>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteWorld('${world.name}')"
                                    ${serverStatus.running ? 'disabled' : ''}>
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateBackupsList(backups) {
            const container = document.getElementById('backups-list');
            if (backups.length === 0) {
                container.innerHTML = '<p class="text-muted">No backups found</p>';
                return;
            }
            
            container.innerHTML = backups.map(backup => `
                <div class="backup-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${backup.filename}</strong>
                        <br>
                        <small class="text-muted">${backup.size_mb} MB - ${backup.created}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-light" onclick="restoreBackup('${backup.path}')">
                            <i class="bi bi-arrow-counterclockwise"></i> Restore
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup('${backup.path}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Console Functions
        function appendToConsole(line) {
            const console = document.getElementById('console-output');
            const p = document.createElement('p');
            p.className = 'mb-0';
            p.textContent = line;
            console.appendChild(p);
            console.scrollTop = console.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }
        
        function handleCommandInput(event) {
            if (event.key === 'Enter') {
                sendCommand();
            }
        }
        
        async function sendCommand() {
            const input = document.getElementById('console-input');
            const command = input.value.trim();
            
            if (!command) return;
            
            try {
                await fetch('/api/minecraft/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command })
                });
                
                appendToConsole('> ' + command);
                input.value = '';
            } catch (error) {
                console.error('Error sending command:', error);
            }
        }
        
        // Server Control Functions
        async function startServer() {
            try {
                const response = await fetch('/api/minecraft/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    appendToConsole('[Dashboard] Server starting...');
                } else {
                    alert('Failed to start server: ' + data.error);
                }
            } catch (error) {
                console.error('Error starting server:', error);
            }
        }
        
        async function stopServer() {
            if (!confirm('Are you sure you want to stop the server?')) return;
            
            try {
                const response = await fetch('/api/minecraft/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    appendToConsole('[Dashboard] Server stopping...');
                } else {
                    alert('Failed to stop server: ' + data.error);
                }
            } catch (error) {
                console.error('Error stopping server:', error);
            }
        }
        
        async function restartServer() {
            if (!confirm('Are you sure you want to restart the server?')) return;
            
            try {
                const response = await fetch('/api/minecraft/restart', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    appendToConsole('[Dashboard] Server restarting...');
                } else {
                    alert('Failed to restart server: ' + data.error);
                }
            } catch (error) {
                console.error('Error restarting server:', error);
            }
        }
        
        // Backup Functions
        async function createBackup() {
            try {
                const response = await fetch('/api/minecraft/backup', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('Backup created successfully!');
                    refreshStatus();
                } else {
                    alert('Failed to create backup: ' + data.error);
                }
            } catch (error) {
                console.error('Error creating backup:', error);
            }
        }
        
        async function restoreBackup(path) {
            if (!confirm('This will replace the current world. Are you sure?')) return;
            if (serverStatus.running) {
                alert('Please stop the server before restoring a backup.');
                return;
            }
            
            try {
                const response = await fetch('/api/minecraft/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Backup restored successfully!');
                } else {
                    alert('Failed to restore backup: ' + data.error);
                }
            } catch (error) {
                console.error('Error restoring backup:', error);
            }
        }
        
        // World Functions
        async function deleteWorld(name) {
            if (!confirm(`Are you sure you want to delete the world "${name}"? This cannot be undone!`)) return;
            if (serverStatus.running) {
                alert('Please stop the server before deleting worlds.');
                return;
            }
            
            try {
                const response = await fetch('/api/minecraft/world/' + name, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    alert('World deleted successfully!');
                    refreshStatus();
                } else {
                    alert('Failed to delete world: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting world:', error);
            }
        }
        
        // Whitelist Functions
        function addToWhitelist() {
            const modal = new bootstrap.Modal(document.getElementById('whitelistModal'));
            modal.show();
        }
        
        async function submitWhitelist() {
            const username = document.getElementById('whitelist-username').value.trim();
            if (!username) return;
            
            try {
                const response = await fetch('/api/minecraft/whitelist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Player added to whitelist!');
                    bootstrap.Modal.getInstance(document.getElementById('whitelistModal')).hide();
                    refreshStatus();
                } else {
                    alert('Failed to add to whitelist: ' + data.error);
                }
            } catch (error) {
                console.error('Error adding to whitelist:', error);
            }
        }
        
        // Config Functions
        async function saveConfig() {
            const config = {
                server_type: document.getElementById('config-server-type').value,
                minecraft_version: document.getElementById('config-version').value,
                max_players: parseInt(document.getElementById('config-max-players').value),
                motd: document.getElementById('config-motd').value,
                memory_min: document.getElementById('config-mem-min').value,
                memory_max: document.getElementById('config-mem-max').value,
                schedule: {
                    mode: document.getElementById('config-schedule-mode').value,
                    start_hour: parseInt(document.getElementById('config-start-hour').value),
                    end_hour: parseInt(document.getElementById('config-end-hour').value)
                }
            };
            
            try {
                const response = await fetch('/api/minecraft/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Configuration saved!');
                } else {
                    alert('Failed to save configuration: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving config:', error);
            }
        }
        
        async function downloadServerJar() {
            if (!confirm('This will download/update the Minecraft server JAR. Continue?')) return;
            
            try {
                const response = await fetch('/api/minecraft/download', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('Server download started!');
                } else {
                    alert('Failed to start download: ' + data.error);
                }
            } catch (error) {
                console.error('Error downloading server:', error);
            }
        }
        
        // Utility functions
        function openWhitelist() {
            document.querySelector('[data-bs-target="#tab-whitelist"]').click();
        }
        
        function openSchedule() {
            document.querySelector('[data-bs-target="#tab-config"]').click();
        }
    </script>
</body>
</html>
