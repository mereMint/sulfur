{% extends "layout.html" %}

{% block title %}Economy Dashboard - Sulfur Bot{% endblock %}

{% block extra_styles %}
<style>
    .wealth-card {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 165, 0, 0.2) 100%);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .wealth-card:hover {
        border-color: #FFD700;
        transform: scale(1.02);
    }
    
    .wealth-value {
        font-size: 2rem;
        font-weight: bold;
        color: #FFD700;
    }
    
    .transaction-positive {
        color: #00d4aa;
    }
    
    .transaction-negative {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4 fade-in">
    <div class="col-12">
        <h2 class="gradient-text mb-4">
            <i class="bi bi-cash-coin"></i> Economy Dashboard
        </h2>
    </div>
</div>

<!-- Economy Statistics -->
<div class="row mb-4 fade-in">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="wealth-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-muted mb-1">Total Coins</h6>
                    <div class="wealth-value" id="total-coins">0</div>
                </div>
                <i class="bi bi-coin" style="font-size: 3rem; color: #FFD700;"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="wealth-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-muted mb-1">Active Users</h6>
                    <div class="wealth-value" id="total-users">0</div>
                </div>
                <i class="bi bi-people-fill" style="font-size: 3rem; color: #FFD700;"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="wealth-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-muted mb-1">Avg Wealth</h6>
                    <div class="wealth-value" id="avg-coins">0</div>
                </div>
                <i class="bi bi-graph-up-arrow" style="font-size: 3rem; color: #FFD700;"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="wealth-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-muted mb-1">Market Cap</h6>
                    <div class="wealth-value" id="market-cap">0</div>
                </div>
                <i class="bi bi-graph-up" style="font-size: 3rem; color: #FFD700;"></i>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row fade-in">
    <div class="col-lg-6 mb-4">
        <div class="card p-4">
            <h4 class="section-title mb-4">
                <i class="bi bi-trophy-fill"></i> Richest Users
            </h4>
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Wealth</th>
                        </tr>
                    </thead>
                    <tbody id="richest-users-table">
                        <tr><td colspan="3" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card p-4">
            <h4 class="section-title mb-4">
                <i class="bi bi-bar-chart-fill"></i> Transaction Activity (7 Days)
            </h4>
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Count</th>
                            <th>Volume</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-types-table">
                        <tr><td colspan="3" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Stock Market Section -->
<div class="row fade-in" id="stock-section" style="display: none;">
    <div class="col-12 mb-4">
        <div class="card p-4">
            <h4 class="section-title mb-4">
                <i class="bi bi-graph-up"></i> Stock Market
            </h4>
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Change</th>
                            <th>Volume</th>
                        </tr>
                    </thead>
                    <tbody id="stocks-table">
                        <tr><td colspan="5" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="row fade-in">
    <div class="col-12 mb-4">
        <div class="card p-4">
            <h4 class="section-title mb-4">
                <i class="bi bi-clock-history"></i> Recent Transactions
            </h4>
            <div class="table-responsive" style="max-height: 500px;">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>User</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table">
                        <tr><td colspan="5" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .section-title {
        color: var(--accent-primary);
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.5rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadEconomyStats();
        loadStockData();
        
        // Refresh every 30 seconds
        setInterval(loadEconomyStats, 30000);
    });
    
    async function loadEconomyStats() {
        try {
            const response = await fetch('/api/economy/stats');
            const data = await response.json();
            
            // Update summary stats
            document.getElementById('total-coins').textContent = data.total_coins.toLocaleString();
            document.getElementById('total-users').textContent = data.total_users.toLocaleString();
            document.getElementById('avg-coins').textContent = data.avg_coins.toLocaleString();
            document.getElementById('market-cap').textContent = data.total_coins.toLocaleString();
            
            // Update richest users table
            const richestTable = document.getElementById('richest-users-table');
            if (data.richest_users && data.richest_users.length > 0) {
                let html = '';
                data.richest_users.forEach((user, index) => {
                    const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : '';
                    html += `
                        <tr>
                            <td>${medal} #${index + 1}</td>
                            <td>${user.display_name || user.username || 'Unknown'}</td>
                            <td class="transaction-positive"><strong>${user.coins.toLocaleString()} ðŸª™</strong></td>
                        </tr>
                    `;
                });
                richestTable.innerHTML = html;
            } else {
                richestTable.innerHTML = '<tr><td colspan="3" class="text-center">No data</td></tr>';
            }
            
            // Update transaction types table
            const typesTable = document.getElementById('transaction-types-table');
            if (data.transaction_types && data.transaction_types.length > 0) {
                let html = '';
                data.transaction_types.forEach(type => {
                    const amountClass = type.total_amount >= 0 ? 'transaction-positive' : 'transaction-negative';
                    html += `
                        <tr>
                            <td><span class="badge bg-secondary">${type.transaction_type}</span></td>
                            <td>${type.count.toLocaleString()}</td>
                            <td class="${amountClass}"><strong>${type.total_amount.toLocaleString()} ðŸª™</strong></td>
                        </tr>
                    `;
                });
                typesTable.innerHTML = html;
            } else {
                typesTable.innerHTML = '<tr><td colspan="3" class="text-center">No data</td></tr>';
            }
            
            // Update recent transactions table
            const transTable = document.getElementById('transactions-table');
            if (data.recent_transactions && data.recent_transactions.length > 0) {
                let html = '';
                data.recent_transactions.forEach(trans => {
                    const amountClass = trans.amount >= 0 ? 'transaction-positive' : 'transaction-negative';
                    const timestamp = new Date(trans.created_at).toLocaleString();
                    const amountSign = trans.amount >= 0 ? '+' : '';
                    html += `
                        <tr>
                            <td><small>${timestamp}</small></td>
                            <td>${trans.display_name || trans.username || 'Unknown'}</td>
                            <td><span class="badge bg-info">${trans.transaction_type}</span></td>
                            <td class="${amountClass}"><strong>${amountSign}${trans.amount.toLocaleString()} ðŸª™</strong></td>
                            <td><small>${trans.description || '-'}</small></td>
                        </tr>
                    `;
                });
                transTable.innerHTML = html;
            } else {
                transTable.innerHTML = '<tr><td colspan="5" class="text-center">No transactions</td></tr>';
            }
        } catch (error) {
            console.error('Error loading economy stats:', error);
        }
    }
    
    async function loadStockData() {
        try {
            const response = await fetch('/api/economy/stocks');
            const data = await response.json();
            
            if (data.stocks && data.stocks.length > 0) {
                document.getElementById('stock-section').style.display = 'block';
                
                const stocksTable = document.getElementById('stocks-table');
                let html = '';
                data.stocks.forEach(stock => {
                    const change = stock.change_percent || 0;
                    const changeClass = change >= 0 ? 'transaction-positive' : 'transaction-negative';
                    const changeSign = change >= 0 ? '+' : '';
                    html += `
                        <tr>
                            <td><strong>${stock.symbol}</strong></td>
                            <td>${stock.name || stock.symbol}</td>
                            <td>${stock.current_price.toLocaleString()} ðŸª™</td>
                            <td class="${changeClass}">${changeSign}${change.toFixed(2)}%</td>
                            <td>${(stock.volume || 0).toLocaleString()}</td>
                        </tr>
                    `;
                });
                stocksTable.innerHTML = html;
            }
        } catch (error) {
            console.error('Error loading stock data:', error);
        }
    }
</script>
{% endblock %}
