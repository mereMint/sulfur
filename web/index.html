{% extends "layout.html" %}
{% block title %}Console - Sulfur Bot{% endblock %}

{% block content %}
<!-- System Status Header -->
<div class="row mb-4 fade-in">
    <div class="col-md-12 mb-3">
        <h3 class="matrix-text"><i class="bi bi-terminal"></i> SYSTEM_CONSOLE</h3>
        <p class="text-muted" style="font-family: 'Courier New', monospace;">
            > Real-time bot monitoring and control interface
        </p>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-muted mb-1">STATUS</h6>
                    <div class="stat-value" id="quick-status" style="font-size: 1.5rem;">INIT</div>
                </div>
                <i class="bi bi-circle-fill" id="status-indicator" style="font-size: 2rem; color: var(--lofi-green);"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-muted mb-1">AI_CALLS</h6>
                    <div class="stat-value" id="quick-ai-calls" style="font-size: 1.5rem;">0</div>
                    <small class="text-muted" id="quick-ai-tokens" style="font-size: 0.7rem;">0 tokens</small>
                </div>
                <i class="bi bi-cpu" style="font-size: 2rem; color: var(--lofi-teal);"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-muted mb-1">ECONOMY</h6>
                    <div class="stat-value" id="quick-wealth" style="font-size: 1.5rem;">0</div>
                </div>
                <i class="bi bi-coin" style="font-size: 2rem; color: var(--warning);"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-muted mb-1">GAMES</h6>
                    <div class="stat-value" id="quick-games" style="font-size: 1.5rem;">0</div>
                </div>
                <i class="bi bi-controller" style="font-size: 2rem; color: var(--danger);"></i>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-terminal"></i> BOT_CONTROL</span>
                <span id="bot-status-badge" class="badge bg-secondary">STATUS: UNKNOWN</span>
            </div>
            <div class="card-body">
                <div class="btn-toolbar mb-3" role="toolbar">
                    <div class="btn-group me-2" role="group">
                        <button type="button" class="btn btn-success" onclick="runAction('/api/restart-bot')" title="Restart the bot">
                            <i class="bi bi-arrow-clockwise"></i> Restart Bot
                        </button>
                        <button type="button" class="btn btn-danger" onclick="runAction('/api/stop-bot')" title="Stop the bot">
                            <i class="bi bi-stop-circle"></i> Stop Bot
                        </button>
                    </div>
                    <div class="btn-group me-2" role="group">
                        <button type="button" class="btn btn-info" onclick="runAction('/api/update-bot')" title="Pull latest changes from git">
                            <i class="bi bi-download"></i> Update from Git
                        </button>
                        <button type="button" class="btn btn-primary" onclick="runAction('/api/sync-db')" title="Sync database">
                            <i class="bi bi-database"></i> Sync DB
                        </button>
                    </div>
                </div>
                <div id="alert-placeholder"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="console-tab" data-bs-toggle="tab" data-bs-target="#console-pane" type="button" role="tab">
                            <i class="bi bi-terminal"></i> Live Console
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-pane" type="button" role="tab">
                            <i class="bi bi-cpu"></i> AI Analytics
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="wrapped-tab" data-bs-toggle="tab" data-bs-target="#wrapped-pane" type="button" role="tab">
                            <i class="bi bi-gift"></i> Wrapped
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin-pane" type="button" role="tab">
                            <i class="bi bi-gear"></i> Admin
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body p-0">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="console-pane" role="tabpanel">
                        <div class="p-3 border-bottom">
                            <div class="row">
                                <div class="col-md-12 mb-2">
                                    <label class="text-muted small">Log Level:</label>
                                    <div class="btn-group me-3" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary active" onclick="filterLogs('all')">All</button>
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="filterLogs('info')">Info</button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="filterLogs('warning')">Warnings</button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="filterLogs('error')">Errors</button>
                                    </div>
                                    <label class="text-muted small ms-3">Feature:</label>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary active" onclick="filterFeature('all')">All</button>
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="filterFeature('chat')">Chat</button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="filterFeature('werwolf')">Werwolf</button>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="filterFeature('wrapped')">Wrapped</button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="filterFeature('admin')">Admin</button>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="d-flex gap-2 justify-content-end">
                                        <input type="text" class="form-control form-control-sm" id="log-search" placeholder="Search logs..." style="max-width: 200px;" oninput="searchLogs()">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="pauseConsole()" title="Pause console updates">
                                            <i class="bi bi-pause-circle" id="pause-icon"></i> <span id="pause-text">Pause</span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearConsole()" title="Clear console">
                                            <i class="bi bi-x-circle"></i> Clear
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" id="auto-scroll-toggle" onclick="toggleAutoScroll()" title="Toggle auto-scroll">
                                            <i class="bi bi-arrow-down-circle"></i> Auto-scroll: ON
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="console" class="console"></div>
                    </div>
                    
                    <div class="tab-pane fade p-4" id="ai-pane" role="tabpanel">
                        <h5 class="mb-3">AI Usage Statistics</h5>
                        <div id="ai-stats-loading" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="ai-stats-content" style="display: none;">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">Total API Calls</h6>
                                            <h3 id="total-calls">0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">Total Tokens</h6>
                                            <h3 id="total-tokens">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-dark table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Model / Feature</th>
                                            <th>Calls</th>
                                            <th>Input Tokens</th>
                                            <th>Output Tokens</th>
                                            <th>Cost (USD)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ai-usage-table">
                                        <tr><td colspan="5" class="text-center">No data available</td></tr>
                                    </tbody>
                                </table>
                                <small class="text-muted">ðŸ’¡ Click on a model row to expand/collapse feature details</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade p-4" id="wrapped-pane" role="tabpanel">
                        <h5 class="mb-3">Monthly Wrapped Statistics</h5>
                        <div id="wrapped-stats-loading" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="wrapped-stats-content" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted">Registered Users</h6>
                                            <h3 id="wrapped-users">0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted">Total Messages</h6>
                                            <h3 id="wrapped-messages">0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted">VC Hours</h6>
                                            <h3 id="wrapped-vc-hours">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-dark table-striped">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Messages</th>
                                            <th>VC Minutes</th>
                                            <th>Registered</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wrapped-users-table">
                                        <tr><td colspan="4" class="text-center">No data available</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade p-4" id="admin-pane" role="tabpanel">
                        <h5 class="mb-4">Admin Controls</h5>
                        
                        <!-- Config Management -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-file-earmark-code"></i> Configuration</h6>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-primary" onclick="reloadConfig()">
                                    <i class="bi bi-arrow-clockwise"></i> Reload Config
                                </button>
                                <small class="text-muted d-block mt-2">Reload config.json and system_prompt.txt without restarting</small>
                            </div>
                        </div>
                        
                        <!-- Chat History Management -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-chat-dots"></i> Chat History</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning" role="alert">
                                    <small><i class="bi bi-info-circle"></i> Saving history requires bot access. Use Discord command <code>/admin save_history</code> instead.</small>
                                </div>
                                <label for="channel-id-clear" class="form-label">Clear History for Channel</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="channel-id-clear" placeholder="1234567890">
                                    <button class="btn btn-danger" onclick="clearHistory()">
                                        <i class="bi bi-trash"></i> Clear
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-2">Clear all chat history for a specific channel</small>
                            </div>
                        </div>
                        
                        <!-- Memory Management -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-brain"></i> Bot Memory</h6>
                            </div>
                            <div class="card-body">
                                <label for="user-id-memory" class="form-label">User ID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="user-id-memory" placeholder="1234567890">
                                    <button class="btn btn-warning" onclick="deleteMemory()">
                                        <i class="bi bi-eraser"></i> Delete Memory
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-2">Delete the bot's relationship summary for a user</small>
                            </div>
                        </div>
                        
                        <!-- Wrapped Management -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-gift"></i> Wrapped Management</h6>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-info mb-2 w-100" onclick="viewWrappedDates()">
                                    <i class="bi bi-calendar"></i> View Next Wrapped Dates
                                </button>
                                <div class="alert alert-warning mt-2" role="alert">
                                    <small><i class="bi bi-info-circle"></i> Event creation and previews require bot access. Use Discord commands <code>/admin view_event</code> and <code>/admin view_wrapped</code>.</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Results Display -->
                        <div id="admin-result" class="alert" style="display: none;" role="alert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <span><i class="bi bi-gear"></i> QUICK_CONFIG</span>
            </div>
            <div class="card-body">
                <h6 class="matrix-text mb-3" style="font-size: 0.85rem;">AI_MODEL</h6>
                <div class="mb-3">
                    <label for="provider-select" class="form-label" style="font-size: 0.75rem;">Provider</label>
                    <select class="form-select form-select-sm" id="provider-select" onchange="updateModelOptions()">
                        <option value="gemini">Gemini</option>
                        <option value="openai">OpenAI</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="model-select" class="form-label" style="font-size: 0.75rem;">Model</label>
                    <select class="form-select form-select-sm" id="model-select">
                        <option value="">Loading config...</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-sm w-100 mb-3" onclick="changeModel()">
                    <i class="bi bi-check-circle"></i> APPLY
                </button>

                <hr style="border-color: var(--border-color);">

                <h6 class="matrix-text mb-3" style="font-size: 0.85rem;">TEMPERATURE</h6>
                <div class="mb-3">
                    <label for="temperature-slider" class="form-label" style="font-size: 0.75rem;">
                        Value: <span id="temperature-value" class="matrix-text">0.7</span>
                    </label>
                    <input type="range" class="form-range" id="temperature-slider" 
                           min="0" max="2" step="0.1" value="0.7" 
                           oninput="updateTemperatureLabel()">
                    <button class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="updateTemperature()">
                        SET
                    </button>
                </div>

                <hr style="border-color: var(--border-color);">

                <h6 class="matrix-text mb-3" style="font-size: 0.85rem;">NAVIGATION</h6>
                <div class="d-grid gap-2">
                    <a href="/activity" class="btn btn-primary btn-sm">
                        <i class="bi bi-activity"></i> ACTIVITY_FEED
                    </a>
                    <a href="/database" class="btn btn-info btn-sm">
                        <i class="bi bi-database"></i> DATABASE
                    </a>
                    <a href="/ai_dashboard" class="btn btn-success btn-sm">
                        <i class="bi bi-cpu"></i> AI_ANALYTICS
                    </a>
                    <a href="/config" class="btn btn-warning btn-sm">
                        <i class="bi bi-gear"></i> CONFIG_EDITOR
                    </a>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span><i class="bi bi-info-circle"></i> SYSTEM_INFO</span>
            </div>
            <div class="card-body" style="font-size: 0.8rem;">
                <div id="system-info">
                    <p class="mb-1"><span class="text-muted">PID:</span> <span id="bot-pid" class="matrix-text">-</span></p>
                    <p class="mb-1"><span class="text-muted">UPDATED:</span> <span id="last-update" class="matrix-text">-</span></p>
                    <p class="mb-0"><span class="text-muted">MODEL:</span> <span id="current-model" class="matrix-text">Loading...</span></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script>
    let autoScroll = true;
    let socket;
    let currentConfig = null;

    document.addEventListener('DOMContentLoaded', function () {
        socket = io();
        const consoleDiv = document.getElementById('console');

        socket.on('connect', function() {
            console.log('Connected to WebSocket server.');
            appendToConsole('> WEBSOCKET_CONNECTED\n');
        });

        socket.on('log_update', function(msg) {
            appendToConsole(msg.data);
        });

        // Bot Status Polling
        const statusBadge = document.getElementById('bot-status-badge');
        const statusIndicator = document.getElementById('status-indicator');

        function updateBotStatus() {
            fetch('/api/bot-status')
                .then(response => response.json())
                .then(data => {
                    let status = data.status || 'Unknown';
                    let badgeClass = 'bg-secondary';
                    let indicatorColor = 'var(--matrix-gray)';

                    if (status.toLowerCase() === 'running') {
                        badgeClass = 'bg-success';
                        indicatorColor = 'var(--lofi-green)';
                    } else if (status.toLowerCase() === 'stopped' || status.toLowerCase() === 'shutdown') {
                        badgeClass = 'bg-danger';
                        indicatorColor = 'var(--danger)';
                    } else if (status.toLowerCase().includes('updating') || status.toLowerCase().includes('starting')) {
                        badgeClass = 'bg-warning';
                        indicatorColor = 'var(--warning)';
                    } else if (status.toLowerCase() === 'error') {
                        badgeClass = 'bg-danger';
                        indicatorColor = 'var(--danger)';
                    }

                    statusBadge.textContent = `STATUS: ${status.toUpperCase()}`;
                    statusBadge.className = `badge ${badgeClass}`;
                    
                    // Update quick status
                    document.getElementById('quick-status').textContent = status.toUpperCase();
                    if (statusIndicator) {
                        statusIndicator.style.color = indicatorColor;
                    }

                    // Update system info
                    if (data.pid) {
                        document.getElementById('bot-pid').textContent = data.pid;
                    }
                    if (data.timestamp) {
                        const date = new Date(data.timestamp);
                        document.getElementById('last-update').textContent = date.toLocaleTimeString();
                    }
                })
                .catch(error => {
                    statusBadge.textContent = 'STATUS: ERROR';
                    statusBadge.className = 'badge bg-danger';
                });
        }
        
        // Load quick stats
        function loadQuickStats() {
            // AI Stats
            fetch('/api/ai-usage?days=30')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const totalCalls = data.summary.total_calls;
                        const totalTokens = data.summary.total_tokens;
                        
                        // Update calls display
                        document.getElementById('quick-ai-calls').textContent = 
                            totalCalls.toLocaleString();
                        
                        // Update tokens display
                        const tokensElement = document.getElementById('quick-ai-tokens');
                        if (tokensElement) {
                            tokensElement.textContent = `${totalTokens.toLocaleString()} tokens`;
                        }
                        
                        // Add tooltip with token info
                        document.getElementById('quick-ai-calls').title = 
                            `${totalTokens.toLocaleString()} tokens used (30 days)`;
                    }
                })
                .catch(error => console.error('Error loading AI stats:', error));
            
            // Economy Stats
            fetch('/api/economy/stats')
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        document.getElementById('quick-wealth').textContent = 
                            data.total_coins.toLocaleString() + ' ðŸª™';
                    }
                })
                .catch(error => console.error('Error loading economy stats:', error));
            
            // Games Stats
            fetch('/api/games/stats')
                .then(response => response.json())
                .then(data => {
                    let totalGames = 0;
                    if (data.werwolf && data.werwolf.total_games) totalGames += parseInt(data.werwolf.total_games) || 0;
                    if (data.detective && data.detective.total_games) totalGames += parseInt(data.detective.total_games) || 0;
                    if (data.wordle && data.wordle.total_games) totalGames += parseInt(data.wordle.total_games) || 0;
                    if (data.casino) {
                        totalGames += parseInt(data.casino.blackjack_games) || 0;
                        totalGames += parseInt(data.casino.roulette_games) || 0;
                        totalGames += parseInt(data.casino.mines_games) || 0;
                    }
                    document.getElementById('quick-games').textContent = 
                        totalGames.toLocaleString();
                })
                .catch(error => {
                    console.error('Error loading games stats:', error);
                    document.getElementById('quick-games').textContent = '0';
                });
        }

        // Load current config
        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentConfig = data.config;
                        updateUIFromConfig();
                    }
                })
                .catch(error => console.error('Error loading config:', error));
        }

        function updateUIFromConfig() {
            if (!currentConfig) return;

            const provider = currentConfig.api?.provider || 'gemini';
            document.getElementById('provider-select').value = provider;
            updateModelOptions();

            if (provider === 'gemini') {
                const model = currentConfig.api?.gemini?.model || 'gemini-2.5-flash';
                document.getElementById('model-select').value = model;
                document.getElementById('current-model').textContent = `${provider}/${model}`;
                
                const temp = currentConfig.api?.gemini?.generation_config?.temperature || 0.7;
                document.getElementById('temperature-slider').value = temp;
                document.getElementById('temperature-value').textContent = temp;
            } else if (provider === 'openai') {
                const model = currentConfig.api?.openai?.chat_model || 'gpt-4o-mini';
                document.getElementById('model-select').value = model;
                document.getElementById('current-model').textContent = `${provider}/${model}`;
                
                const temp = currentConfig.api?.openai?.chat_temperature || 0.7;
                document.getElementById('temperature-slider').value = temp;
                document.getElementById('temperature-value').textContent = temp;
            }
        }

        setInterval(updateBotStatus, 5000);
        updateBotStatus();
        loadConfig();
        loadQuickStats();
        setInterval(loadConfig, 10000); // Reload config every 10 seconds
        setInterval(loadQuickStats, 30000); // Reload quick stats every 30 seconds
    });

    function clearConsole() {
        document.getElementById('console').innerHTML = '';
    }

    function toggleAutoScroll() {
        autoScroll = !autoScroll;
        const btn = document.getElementById('auto-scroll-toggle');
        btn.innerHTML = autoScroll 
            ? '<i class="bi bi-arrow-down-circle"></i> Auto-scroll: ON'
            : '<i class="bi bi-arrow-down-circle"></i> Auto-scroll: OFF';
        btn.className = autoScroll ? 'btn btn-sm btn-outline-secondary' : 'btn btn-sm btn-secondary';
    }
    
    let consolePaused = false;
    let consoleFilter = 'all';
    let pausedMessages = [];
    let searchTerm = '';
    let featureFilter = 'all';
    
    function pauseConsole() {
        consolePaused = !consolePaused;
        const btn = document.querySelector('[onclick="pauseConsole()"]');
        const icon = document.getElementById('pause-icon');
        const text = document.getElementById('pause-text');
        
        if (consolePaused) {
            icon.className = 'bi bi-play-circle';
            text.textContent = 'Resume';
            btn.className = 'btn btn-sm btn-warning';
            pausedMessages = [];
        } else {
            icon.className = 'bi bi-pause-circle';
            text.textContent = 'Pause';
            btn.className = 'btn btn-sm btn-outline-secondary';
            // Flush paused messages
            pausedMessages.forEach(msg => appendToConsole(msg, true));
            pausedMessages = [];
        }
    }
    
    function searchLogs() {
        searchTerm = document.getElementById('log-search').value.toLowerCase();
        applyFilters();
    }
    
    function filterLogs(level) {
        consoleFilter = level;
        
        // Update button states
        document.querySelectorAll('[onclick^="filterLogs"]').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        applyFilters();
    }
    
    function filterFeature(feature) {
        featureFilter = feature;
        
        // Update button states
        document.querySelectorAll('[onclick^="filterFeature"]').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        applyFilters();
    }
    
    function applyFilters() {
        const console = document.getElementById('console');
        const lines = console.querySelectorAll('.console-line');
        
        lines.forEach(line => {
            const text = line.textContent.toLowerCase();
            const html = line.innerHTML.toLowerCase();
            let shouldShow = true;
            
            // Apply level filter
            if (consoleFilter !== 'all') {
                shouldShow = 
                    (consoleFilter === 'info' && (text.includes('[info]') || text.includes('[94m'))) ||
                    (consoleFilter === 'warning' && (text.includes('[warning]') || text.includes('[93m'))) ||
                    (consoleFilter === 'error' && (text.includes('[error]') || text.includes('[91m') || text.includes('error')));
            }
            
            // Apply feature filter
            if (shouldShow && featureFilter !== 'all') {
                shouldShow = html.includes(`badge bg-`) && html.includes(featureFilter);
            }
            
            // Apply search filter
            if (shouldShow && searchTerm) {
                shouldShow = text.includes(searchTerm);
            }
            
            line.style.display = shouldShow ? '' : 'none';
        });
    }
    
    function appendToConsole(message, skipPauseCheck = false) {
        if (!skipPauseCheck && consolePaused) {
            pausedMessages.push(message);
            return;
        }
        
        const console = document.getElementById('console');
        const div = document.createElement('div');
        div.className = 'console-line';
        div.innerHTML = message;
        console.appendChild(div);
        
        // Apply current filters
        const text = message.toLowerCase();
        let shouldShow = true;
        
        if (consoleFilter !== 'all') {
            shouldShow = 
                (consoleFilter === 'info' && (text.includes('[info]') || text.includes('[94m'))) ||
                (consoleFilter === 'warning' && (text.includes('[warning]') || text.includes('[93m'))) ||
                (consoleFilter === 'error' && (text.includes('[error]') || text.includes('[91m') || text.includes('error')));
            
            if (!shouldShow) {
                div.style.display = 'none';
            }
        }
        
        // Apply search filter
        if (shouldShow && searchTerm && !text.includes(searchTerm)) {
            div.style.display = 'none';
        }
        
        // Limit console to last 500 lines for performance
        const maxLines = 500;
        while (console.children.length > maxLines) {
            console.removeChild(console.firstChild);
        }
        
        if (autoScroll) {
            console.scrollTop = console.scrollHeight;
        }
    }

    function updateModelOptions() {
        const provider = document.getElementById('provider-select').value;
        const modelSelect = document.getElementById('model-select');
        
        modelSelect.innerHTML = '';
        
        if (provider === 'gemini') {
            // Include all Gemini models with pricing info
            const models = [
                {name: 'gemini-2.5-flash', price: '$0.075/1M'},
                {name: 'gemini-2.5-flash-lite', price: '$0.02/1M'},
                {name: 'gemini-2.5-pro', price: '$1.25/1M'},
                {name: 'gemini-2.0-flash-exp', price: '$0.075/1M'},
                {name: 'gemini-1.5-pro', price: '$1.25/1M'},
                {name: 'gemini-1.5-flash', price: '$0.075/1M'}
            ];
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.price})`;
                modelSelect.appendChild(option);
            });
        } else if (provider === 'openai') {
            // Include all OpenAI models with pricing info
            const models = [
                {name: 'gpt-5-nano', price: '$0.05/1M'},
                {name: 'gpt-5-mini', price: '$0.15/1M'},
                {name: 'gpt-4.1-nano', price: '$0.10/1M'},
                {name: 'gpt-4.1-mini', price: '$0.40/1M'},
                {name: 'gpt-4o-mini', price: '$0.15/1M'},
                {name: 'gpt-4o', price: '$2.50/1M'},
                {name: 'gpt-4-turbo', price: '$10.00/1M'},
                {name: 'o1-mini', price: '$1.10/1M'},
                {name: 'o3-mini', price: '$1.10/1M'},
                {name: 'o1', price: '$15.00/1M'}
            ];
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.price})`;
                modelSelect.appendChild(option);
            });
        }
    }

    function updateTemperatureLabel() {
        const slider = document.getElementById('temperature-slider');
        document.getElementById('temperature-value').textContent = slider.value;
    }

    function changeModel() {
        const provider = document.getElementById('provider-select').value;
        const model = document.getElementById('model-select').value;
        
        const alertPlaceholder = document.getElementById('alert-placeholder');
        
        fetch('/api/config/model', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ provider, model })
        })
        .then(response => response.json())
        .then(data => {
            let alertClass = data.status === 'success' ? 'alert-success' : 'alert-danger';
            let alertHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            alertPlaceholder.innerHTML = alertHTML;
            
            if (data.status === 'success') {
                document.getElementById('current-model').textContent = `${provider}/${model}`;
            }
        })
        .catch(error => {
            alertPlaceholder.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                Error: ${error}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
        });
    }

    function updateTemperature() {
        const temperature = parseFloat(document.getElementById('temperature-slider').value);
        const provider = document.getElementById('provider-select').value;
        
        let path;
        if (provider === 'gemini') {
            path = 'api.gemini.generation_config.temperature';
        } else {
            path = 'api.openai.chat_temperature';
        }
        
        const alertPlaceholder = document.getElementById('alert-placeholder');
        
        fetch('/api/config/setting', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ path, value: temperature })
        })
        .then(response => response.json())
        .then(data => {
            let alertClass = data.status === 'success' ? 'alert-success' : 'alert-danger';
            let alertHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            alertPlaceholder.innerHTML = alertHTML;
        })
        .catch(error => {
            alertPlaceholder.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                Error: ${error}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
        });
    }

    function runAction(endpoint) {
        const alertPlaceholder = document.getElementById('alert-placeholder');
        fetch(endpoint, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                let alertClass = data.status === 'success' ? 'alert-success' : 'alert-danger';
                let alertHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
                alertPlaceholder.innerHTML = alertHTML;
            })
            .catch(error => {
                let alertHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                    A network error occurred: ${error}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
                alertPlaceholder.innerHTML = alertHTML;
            });
    }

    // Load AI Statistics
    function loadAIStats() {
        const loading = document.getElementById('ai-stats-loading');
        const content = document.getElementById('ai-stats-content');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        
        fetch('/api/ai-usage?days=30')
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                content.style.display = 'block';
                
                if (data.status === 'success' && data.by_model) {
                    // Update summary totals
                    document.getElementById('total-calls').textContent = data.summary.total_calls.toLocaleString();
                    document.getElementById('total-tokens').textContent = data.summary.total_tokens.toLocaleString();
                    
                    // Build table with grouped by model data
                    let tableHTML = '';
                    
                    // Create expandable rows by model
                    Object.entries(data.by_model).forEach(([model, modelData]) => {
                        const totalTokens = modelData.input_tokens + modelData.output_tokens;
                        const modelRowId = `model-${model.replace(/[^a-zA-Z0-9]/g, '-')}`;
                        
                        // Model summary row (clickable to expand)
                        tableHTML += `<tr class="table-primary fw-bold" style="cursor: pointer;" onclick="toggleModelDetails('${modelRowId}')">
                            <td colspan="2">ðŸ“Š ${model}</td>
                            <td>${modelData.calls.toLocaleString()}</td>
                            <td>${totalTokens.toLocaleString()}</td>
                            <td>$${modelData.cost.toFixed(4)}</td>
                        </tr>`;
                        
                        // Feature breakdown rows (hidden by default)
                        Object.entries(modelData.features).forEach(([feature, featureData]) => {
                            const featureTokens = featureData.input_tokens + featureData.output_tokens;
                            tableHTML += `<tr class="${modelRowId} model-details" style="display: none;">
                                <td class="ps-4">â†³ ${feature}</td>
                                <td>${featureData.calls.toLocaleString()}</td>
                                <td>${featureData.input_tokens.toLocaleString()}</td>
                                <td>${featureData.output_tokens.toLocaleString()}</td>
                                <td>$${featureData.cost.toFixed(4)}</td>
                            </tr>`;
                        });
                    });
                    
                    document.getElementById('ai-usage-table').innerHTML = tableHTML;
                } else {
                    document.getElementById('ai-usage-table').innerHTML = '<tr><td colspan="5" class="text-center">No data available</td></tr>';
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                content.style.display = 'block';
                console.error('Error loading AI stats:', error);
                document.getElementById('ai-usage-table').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>';
            });
    }
    
    function toggleModelDetails(modelRowId) {
        const rows = document.querySelectorAll(`.${modelRowId}`);
        rows.forEach(row => {
            row.style.display = row.style.display === 'none' ? '' : 'none';
        });
    }

    // Load Wrapped Statistics
    function loadWrappedStats() {
        const loading = document.getElementById('wrapped-stats-loading');
        const content = document.getElementById('wrapped-stats-content');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        
        fetch('/api/wrapped_stats')
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                content.style.display = 'block';
                
                if (data.registrations && data.registrations.length > 0) {
                    let totalMessages = 0;
                    let totalVCMinutes = 0;
                    let tableHTML = '';
                    
                    data.registrations.forEach(user => {
                        const messages = user.message_count || 0;
                        const vcMinutes = user.vc_minutes || 0;
                        totalMessages += messages;
                        totalVCMinutes += vcMinutes;
                        
                        tableHTML += `<tr>
                            <td>${user.display_name || user.username || 'Unknown'}</td>
                            <td>${messages}</td>
                            <td>${vcMinutes}</td>
                            <td>${user.registered ? 'Yes' : 'No'}</td>
                        </tr>`;
                    });
                    
                    document.getElementById('wrapped-users').textContent = data.registrations.length;
                    document.getElementById('wrapped-messages').textContent = totalMessages.toLocaleString();
                    document.getElementById('wrapped-vc-hours').textContent = (totalVCMinutes / 60).toFixed(1);
                    document.getElementById('wrapped-users-table').innerHTML = tableHTML;
                } else {
                    document.getElementById('wrapped-users-table').innerHTML = '<tr><td colspan="4" class="text-center">No registered users</td></tr>';
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                content.style.display = 'block';
                console.error('Error loading wrapped stats:', error);
            });
    }

    // Load Leaderboards
    function loadLeaderboards() {
        const loading = document.getElementById('leaderboard-loading');
        const content = document.getElementById('leaderboard-content');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        
        // Load Level Leaderboard
        fetch('/api/level_leaderboard')
            .then(response => response.json())
            .then(data => {
                if (data.leaderboard && data.leaderboard.length > 0) {
                    let tableHTML = '';
                    data.leaderboard.forEach((player, index) => {
                        const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : '';
                        tableHTML += `<tr>
                            <td>${medal} #${index + 1}</td>
                            <td>${player.display_name || player.username || 'Unknown'}</td>
                            <td>${player.level || 1}</td>
                            <td>${player.xp || 0}</td>
                        </tr>`;
                    });
                    document.getElementById('level-leaderboard-table').innerHTML = tableHTML;
                }
            })
            .catch(error => console.error('Error loading level leaderboard:', error));
        
        // Load Werwolf Leaderboard
        fetch('/api/ww_leaderboard')
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                content.style.display = 'block';
                
                if (data.leaderboard && data.leaderboard.length > 0) {
                    let tableHTML = '';
                    data.leaderboard.forEach((player, index) => {
                        const wins = player.wins || 0;
                        const losses = player.losses || 0;
                        const total = wins + losses;
                        const winRate = total > 0 ? ((wins / total) * 100).toFixed(1) : '0.0';
                        const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : '';
                        
                        tableHTML += `<tr>
                            <td>${medal} #${index + 1}</td>
                            <td>${player.display_name || player.username || 'Unknown'}</td>
                            <td>${wins}</td>
                            <td>${losses}</td>
                            <td>${winRate}%</td>
                        </tr>`;
                    });
                    document.getElementById('ww-leaderboard-table').innerHTML = tableHTML;
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                content.style.display = 'block';
                console.error('Error loading werwolf leaderboard:', error);
            });
    }

    // Load Maintenance Logs
    function loadMaintenanceLogs() {
        const loading = document.getElementById('maintenance-loading');
        const content = document.getElementById('maintenance-content');
        const container = document.getElementById('maintenance-logs-container');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        
        fetch('/api/maintenance/logs')
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                content.style.display = 'block';
                
                if (data.status === 'success' && data.logs && data.logs.length > 0) {
                    let html = '';
                    data.logs.forEach(log => {
                        html += `<div class="card mb-3">
                            <div class="card-header bg-dark text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-file-text"></i> ${log.filename}
                                    <small class="text-muted float-end">${log.timestamp}</small>
                                </h6>
                            </div>
                            <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">`;
                        
                        if (log.activities && log.activities.length > 0) {
                            html += '<ul class="list-unstyled mb-0 font-monospace small">';
                            log.activities.forEach(activity => {
                                // Color code activities
                                let color = '';
                                if (activity.toLowerCase().includes('error')) color = 'text-danger';
                                else if (activity.toLowerCase().includes('restart')) color = 'text-warning';
                                else if (activity.toLowerCase().includes('backup')) color = 'text-info';
                                else if (activity.toLowerCase().includes('update') || activity.toLowerCase().includes('pull')) color = 'text-success';
                                
                                html += `<li class="${color}">${activity}</li>`;
                            });
                            html += '</ul>';
                        } else {
                            html += '<p class="text-muted mb-0">No significant activities recorded</p>';
                        }
                        
                        html += `</div></div>`;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="alert alert-info">No maintenance logs available</div>';
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                content.style.display = 'block';
                container.innerHTML = '<div class="alert alert-danger">Error loading maintenance logs</div>';
                console.error('Error loading maintenance logs:', error);
            });
    }

    // Tab change listeners to load data when tabs are opened
    document.getElementById('ai-tab').addEventListener('shown.bs.tab', loadAIStats);
    document.getElementById('maintenance-tab').addEventListener('shown.bs.tab', loadMaintenanceLogs);
    document.getElementById('wrapped-tab').addEventListener('shown.bs.tab', loadWrappedStats);
    document.getElementById('leaderboard-tab').addEventListener('shown.bs.tab', loadLeaderboards);
    
    // ========== Admin Functions ==========
    
    function showAdminResult(message, type = 'success') {
        const result = document.getElementById('admin-result');
        result.className = `alert alert-${type}`;
        result.textContent = message;
        result.style.display = 'block';
        setTimeout(() => { result.style.display = 'none'; }, 5000);
    }
    
    function reloadConfig() {
        fetch('/api/admin/reload_config', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showAdminResult(data.message || 'Config reloaded successfully', data.success ? 'success' : 'danger');
            })
            .catch(error => {
                showAdminResult('Error: ' + error.message, 'danger');
            });
    }
    
    function clearHistory() {
        const channelId = document.getElementById('channel-id-clear').value;
        
        if (!channelId) {
            showAdminResult('Please enter a channel ID', 'warning');
            return;
        }
        
        if (!confirm(`Are you sure you want to clear all history for channel ${channelId}?`)) {
            return;
        }
        
        fetch('/api/admin/clear_history', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ channel_id: channelId })
        })
        .then(response => response.json())
        .then(data => {
            showAdminResult(data.message || 'History cleared', data.success ? 'success' : 'danger');
        })
        .catch(error => showAdminResult('Error: ' + error.message, 'danger'));
    }
    
    function deleteMemory() {
        const userId = document.getElementById('user-id-memory').value;
        
        if (!userId) {
            showAdminResult('Please enter a user ID', 'warning');
            return;
        }
        
        if (!confirm(`Are you sure you want to delete memory for user ${userId}?`)) {
            return;
        }
        
        fetch('/api/admin/delete_memory', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        })
        .then(response => response.json())
        .then(data => {
            showAdminResult(data.message || 'Memory deleted', data.success ? 'success' : 'danger');
        })
        .catch(error => showAdminResult('Error: ' + error.message, 'danger'));
    }
    
    function viewWrappedDates() {
        fetch('/api/admin/wrapped_dates')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const eventDate = new Date(data.event_creation_date).toLocaleString();
                    const releaseDate = new Date(data.release_date).toLocaleString();
                    const message = `Stat Period: ${data.stat_period} | Event: ${eventDate} | Release: ${releaseDate}`;
                    showAdminResult(message, 'info');
                } else {
                    showAdminResult(data.message || 'Error fetching dates', 'danger');
                }
            })
            .catch(error => showAdminResult('Error: ' + error.message, 'danger'));
    }
</script>
{% endblock %}