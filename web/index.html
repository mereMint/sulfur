{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex align-items-center mb-3">
            <h3 class="me-3">Controls</h3>
            <span id="bot-status-badge" class="badge bg-secondary">Status: Unknown</span>
        </div>
        <h3>Controls</h3>
        <div class="btn-toolbar" role="toolbar">
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-primary" onclick="runAction('/api/sync-db')">Sync DB</button>
                <button type="button" class="btn btn-info" onclick="runAction('/api/update-bot')">Update Bot</button>
            </div>
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-warning" onclick="runAction('/api/restart-bot')">Restart Bot</button>
                <button type="button" class="btn btn-danger" onclick="runAction('/api/stop-bot')">Stop Bot</button>
            </div>
        </div>
        <div id="alert-placeholder" class="mt-3"></div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <h3>Live Console</h3>
        <div id="console" class="console"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const socket = io();
        const consoleDiv = document.getElementById('console');

        socket.on('connect', function() {
            console.log('Connected to WebSocket server.');
        });

        socket.on('log_update', function(msg) {
            consoleDiv.innerHTML += msg.data;
            // Auto-scroll to the bottom
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        });

        // --- NEW: Bot Status Polling ---
        const statusBadge = document.getElementById('bot-status-badge');

        function updateBotStatus() {
            fetch('/api/bot-status')
                .then(response => response.json())
                .then(data => {
                    let status = data.status || 'Unknown';
                    let badgeClass = 'bg-secondary'; // Default for Unknown

                    if (status.toLowerCase() === 'running') {
                        badgeClass = 'bg-success';
                    } else if (status.toLowerCase() === 'stopped' || status.toLowerCase() === 'shutdown') {
                        badgeClass = 'bg-danger';
                    } else if (status.toLowerCase().includes('updating') || status.toLowerCase().includes('restarting')) {
                        badgeClass = 'bg-warning text-dark';
                    } else if (status.toLowerCase() === 'error') {
                        badgeClass = 'bg-danger';
                    }

                    statusBadge.textContent = `Status: ${status}`;
                    statusBadge.className = `badge ${badgeClass}`;
                })
                .catch(error => {
                    statusBadge.textContent = 'Status: Error';
                    statusBadge.className = 'badge bg-danger';
                });
        }
        setInterval(updateBotStatus, 5000); // Update every 5 seconds
        updateBotStatus(); // Initial call
    });

    function runAction(endpoint) {
        const alertPlaceholder = document.getElementById('alert-placeholder');
        fetch(endpoint, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                let alertClass = data.status === 'success' ? 'alert-success' : 'alert-danger';
                let alertHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
                alertPlaceholder.innerHTML = alertHTML;
            })
            .catch(error => {
                let alertHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                    A network error occurred: ${error}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
                alertPlaceholder.innerHTML = alertHTML;
            });
    }
</script>
{% endblock %}