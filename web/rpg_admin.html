{% extends "layout.html" %}

{% block title %}RPG Admin - Sulfur Bot Dashboard{% endblock %}

{% block extra_styles %}
<style>
    /* RPG-specific rarity colors */
    .rarity-common { background: #95a5a6; }
    .rarity-uncommon { background: #27ae60; }
    .rarity-rare { background: #3498db; }
    .rarity-epic { background: #9b59b6; }
    .rarity-legendary { background: #f39c12; }
    
    /* Override stat-card for RPG specific look */
    .rpg-stat-card {
        background: linear-gradient(135deg, rgba(83, 52, 131, 0.3) 0%, rgba(233, 69, 96, 0.3) 100%);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .rpg-stat-card:hover {
        border-color: var(--accent-primary);
        transform: scale(1.02);
    }
    
    .rpg-stat-card .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--accent-primary);
    }
    
    .rpg-stat-card i {
        font-size: 2rem;
        color: var(--accent-primary);
    }
    
    /* Section titles */
    .section-title {
        color: var(--accent-primary);
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }
    
    /* Tab styling */
    .nav-tabs {
        border-bottom: 2px solid var(--border-color);
    }
    
    .nav-tabs .nav-link {
        color: var(--text-secondary);
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
    }
    
    .nav-tabs .nav-link.active {
        color: var(--accent-primary);
        background: transparent;
        border-bottom-color: var(--accent-primary);
    }
    
    /* Table improvements */
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .table-responsive::-webkit-scrollbar {
        width: 8px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: var(--accent-secondary);
        border-radius: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: var(--accent-primary);
    }
    
    /* Enhanced Skill Tree Styles */
    .nav-pills .nav-link {
        color: var(--text-secondary);
        background: rgba(30, 34, 56, 0.6);
        border: 1px solid var(--border-color);
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .nav-pills .nav-link:hover {
        background: rgba(83, 52, 131, 0.4);
        border-color: var(--accent-primary);
        transform: translateY(-2px);
    }
    
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
        border-color: var(--accent-primary);
        color: white;
    }
    
    /* Skill Tree Path Content */
    .path-header {
        border-left: 4px solid var(--accent-primary);
    }
    
    .branch-container {
        transition: all 0.3s ease;
    }
    
    .branch-container:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .skill-card {
        transition: all 0.3s ease;
    }
    
    .skill-card:hover {
        background: rgba(83, 52, 131, 0.3) !important;
    }
    
    .ultimate-skill {
        transition: all 0.3s ease;
        animation: ultimatePulse 2s infinite;
    }
    
    .ultimate-skill:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
    }
    
    @keyframes ultimatePulse {
        0%, 100% { box-shadow: 0 0 5px rgba(231, 76, 60, 0.3); }
        50% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
    }
    
    /* Skill Tree Legend */
    .skill-tree-legend {
        border-left: 4px solid var(--accent-tertiary);
    }
    
    /* Effects list in modal */
    .effects-list .effect-item {
        transition: all 0.2s ease;
    }
    
    .effects-list .effect-item:hover {
        background: rgba(83, 52, 131, 0.4) !important;
        transform: translateX(5px);
    }
    
    /* Custom badge for purple tier */
    .bg-purple {
        background-color: #9b59b6 !important;
    }
    
    /* Responsive skill tree */
    @media (max-width: 768px) {
        .nav-pills {
            flex-wrap: wrap;
        }
        
        .nav-pills .nav-link {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }
        
        .branch-container {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- RPG Statistics -->
<div class="row mb-4 fade-in">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="rpg-stat-card">
            <i class="bi bi-people-fill"></i>
            <div class="stat-value" id="total-players">0</div>
            <div>Total Players</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="rpg-stat-card">
            <i class="bi bi-shield-fill-exclamation"></i>
            <div class="stat-value" id="total-monsters">0</div>
            <div>Monsters</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="rpg-stat-card">
            <i class="bi bi-box-seam"></i>
            <div class="stat-value" id="total-items">0</div>
            <div>Items</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="rpg-stat-card">
            <i class="bi bi-coin"></i>
            <div class="stat-value" id="total-gold">0</div>
            <div>Total Gold</div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="rpgTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">
            <i class="bi bi-box"></i> Items & Weapons
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="monsters-tab" data-bs-toggle="tab" data-bs-target="#monsters" type="button" role="tab">
            <i class="bi bi-bug-fill"></i> Monsters
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="skills-tab" data-bs-toggle="tab" data-bs-target="#skills" type="button" role="tab">
            <i class="bi bi-tree-fill"></i> Skill Tree
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button" role="tab">
            <i class="bi bi-people-fill"></i> Player Management
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
            <i class="bi bi-gear-fill"></i> Settings
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content fade-in" id="rpgTabContent">
    <!-- Items Tab -->
    <div class="tab-pane fade show active" id="items" role="tabpanel">
        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-plus-circle"></i> Create Item</h3>
                    <form id="createItemForm">
                        <div class="mb-3">
                            <label for="itemName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="mb-3">
                            <label for="itemType" class="form-label">Type</label>
                            <select class="form-select" id="itemType" required>
                                <option value="weapon">Weapon</option>
                                <option value="skill">Skill</option>
                                <option value="consumable">Consumable</option>
                                <option value="loot">Loot</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="itemRarity" class="form-label">Rarity</label>
                            <select class="form-select" id="itemRarity" required>
                                <option value="common">Common</option>
                                <option value="uncommon">Uncommon</option>
                                <option value="rare">Rare</option>
                                <option value="epic">Epic</option>
                                <option value="legendary">Legendary</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="itemDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="itemDescription" rows="2" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="itemDamage" class="form-label">Damage</label>
                                <input type="number" class="form-control" id="itemDamage" value="0" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemPrice" class="form-label">Price</label>
                                <input type="number" class="form-control" id="itemPrice" value="100" min="0" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="itemLevel" class="form-label">Required Level</label>
                                <input type="number" class="form-control" id="itemLevel" value="1" min="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemDamageType" class="form-label">Damage Type</label>
                                <select class="form-select" id="itemDamageType">
                                    <option value="">None</option>
                                    <option value="physical">Physical</option>
                                    <option value="fire">Fire</option>
                                    <option value="ice">Ice</option>
                                    <option value="lightning">Lightning</option>
                                    <option value="poison">Poison</option>
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="itemEffects" class="form-label">Effects (JSON)</label>
                            <textarea class="form-control" id="itemEffects" rows="2" placeholder='{"heal": 50}'></textarea>
                            <small class="text-muted">Optional: JSON object with effects</small>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus-circle"></i> Create Item
                        </button>
                    </form>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-list"></i> All Items</h3>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="itemsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Rarity</th>
                                    <th>Damage</th>
                                    <th>Price</th>
                                    <th>Level</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monsters Tab -->
    <div class="tab-pane fade" id="monsters" role="tabpanel">
        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-plus-circle"></i> Create Monster</h3>
                    <form id="createMonsterForm">
                        <div class="mb-3">
                            <label for="monsterName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="monsterName" required>
                        </div>
                        <div class="mb-3">
                            <label for="monsterWorld" class="form-label">World</label>
                            <select class="form-select" id="monsterWorld" required>
                                <option value="overworld">Overworld</option>
                                <option value="underworld">Underworld</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="monsterLevel" class="form-label">Level</label>
                                <input type="number" class="form-control" id="monsterLevel" value="1" min="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="monsterHealth" class="form-label">Health</label>
                                <input type="number" class="form-control" id="monsterHealth" value="50" min="1" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="monsterStrength" class="form-label">Strength</label>
                                <input type="number" class="form-control" id="monsterStrength" value="5" min="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="monsterDefense" class="form-label">Defense</label>
                                <input type="number" class="form-control" id="monsterDefense" value="5" min="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="monsterSpeed" class="form-label">Speed</label>
                                <input type="number" class="form-control" id="monsterSpeed" value="5" min="1" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="monsterXP" class="form-label">XP Reward</label>
                                <input type="number" class="form-control" id="monsterXP" value="10" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="monsterGold" class="form-label">Gold Reward</label>
                                <input type="number" class="form-control" id="monsterGold" value="10" min="0" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus-circle"></i> Create Monster
                        </button>
                    </form>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-list"></i> All Monsters</h3>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="monstersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>World</th>
                                    <th>Level</th>
                                    <th>HP</th>
                                    <th>Stats</th>
                                    <th>Rewards</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="monstersTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skill Tree Tab -->
    <div class="tab-pane fade" id="skills" role="tabpanel">
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-tree-fill"></i> Enhanced Skill Tree System</h3>
                    <p class="text-muted">6 unique paths with branching specializations, strategic choices, and ultimate abilities</p>
                    
                    <!-- Skill Tree Legend -->
                    <div class="skill-tree-legend mb-4 p-3" style="background: rgba(30,34,56,0.6); border-radius: 10px;">
                        <h6 class="mb-3">üìã Legend</h6>
                        <div class="d-flex flex-wrap gap-3">
                            <span class="badge" style="background: #27ae60;">üü¢ Tier 1 - Anf√§nger</span>
                            <span class="badge" style="background: #3498db;">üîµ Tier 2 - Fortgeschritten</span>
                            <span class="badge" style="background: #9b59b6;">üü£ Tier 3 - Experte</span>
                            <span class="badge" style="background: #e67e22;">üü† Tier 4 - Meister</span>
                            <span class="badge" style="background: #e74c3c;">üî¥ Ultimate</span>
                        </div>
                        <div class="d-flex flex-wrap gap-3 mt-2">
                            <span class="badge bg-secondary">üìà Stat - Passive Boni</span>
                            <span class="badge bg-info">‚ö° Skill - Aktive F√§higkeit</span>
                            <span class="badge bg-warning text-dark">üîÆ Passive - Dauerhafter Effekt</span>
                            <span class="badge bg-danger">üí• Ultimate - Finaler Skill</span>
                        </div>
                    </div>
                    
                    <!-- Path Selection Tabs -->
                    <ul class="nav nav-pills mb-4" id="skillPathTabs" role="tablist">
                        <!-- Paths will be loaded dynamically -->
                    </ul>
                    
                    <!-- Path Content -->
                    <div class="tab-content" id="skillPathContent">
                        <!-- Content loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Skill Details Modal -->
        <div class="modal fade" id="skillModal" tabindex="-1" aria-labelledby="skillModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                    <div class="modal-header">
                        <h5 class="modal-title" id="skillModalLabel">Skill Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="skillModalBody">
                        <!-- Skill details will be loaded here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Players Tab -->
    <div class="tab-pane fade" id="players" role="tabpanel">
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-person-x-fill"></i> Reset Player RPG Data</h3>
                    <p class="text-muted">This will completely reset a player's RPG progress, returning them to a fresh start.</p>
                    <p class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> <strong>Warning:</strong> This action cannot be undone!</p>
                    
                    <form id="resetPlayerForm" onsubmit="resetPlayerData(event)">
                        <div class="mb-3">
                            <label for="resetUserId" class="form-label">User ID</label>
                            <input type="text" class="form-control" id="resetUserId" placeholder="Enter Discord User ID" required>
                            <small class="form-text text-muted">Enter the Discord User ID of the player to reset</small>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="resetConfirm" required>
                            <label class="form-check-label text-danger" for="resetConfirm">
                                I confirm that I want to permanently delete this player's RPG data
                            </label>
                        </div>
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="bi bi-trash-fill"></i> Reset Player RPG Data
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-gear"></i> RPG Settings</h3>
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="adventureCooldown" class="form-label">Adventure Cooldown (seconds)</label>
                            <input type="number" class="form-control" id="adventureCooldown" value="120" min="0">
                        </div>
                        <div class="mb-3">
                            <label for="baseStatValue" class="form-label">Base Stat Value</label>
                            <input type="number" class="form-control" id="baseStatValue" value="10" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="respecCost" class="form-label">Respec Cost Per Point</label>
                            <input type="number" class="form-control" id="respecCost" value="50" min="0">
                        </div>
                        <div class="mb-3">
                            <label for="levelRewardMultiplier" class="form-label">Level Reward Multiplier</label>
                            <input type="number" class="form-control" id="levelRewardMultiplier" value="0.1" step="0.01" min="0">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-save"></i> Save Settings
                        </button>
                    </form>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-tools"></i> Maintenance</h3>
                    <div class="d-grid gap-3">
                        <button class="btn btn-primary" onclick="initializeDefaults()">
                            <i class="bi bi-arrow-clockwise"></i> Reinitialize Default Monsters
                        </button>
                        <button class="btn btn-primary" onclick="initializeShopItems()">
                            <i class="bi bi-shop"></i> Reinitialize Shop Items
                        </button>
                        <button class="btn btn-warning" onclick="refreshStats()">
                            <i class="bi bi-arrow-repeat"></i> Refresh Statistics
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load statistics on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadItems();
        loadMonsters();
        loadSkillTree();
    });

    async function loadStats() {
        try {
            const response = await fetch('/api/rpg/stats');
            const data = await response.json();
            
            document.getElementById('total-players').textContent = data.total_players || 0;
            document.getElementById('total-monsters').textContent = data.total_monsters || 0;
            document.getElementById('total-items').textContent = data.total_items || 0;
            document.getElementById('total-gold').textContent = (data.total_gold || 0).toLocaleString();
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async function loadItems() {
        try {
            const response = await fetch('/api/rpg/items');
            const items = await response.json();
            const tbody = document.getElementById('itemsTableBody');
            
            tbody.innerHTML = items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td><span class="badge bg-secondary">${item.type}</span></td>
                    <td><span class="badge rarity-${item.rarity}">${item.rarity}</span></td>
                    <td>${item.damage || 0}</td>
                    <td>${item.price}</td>
                    <td>${item.required_level}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading items:', error);
        }
    }

    async function loadMonsters() {
        try {
            const response = await fetch('/api/rpg/monsters');
            const monsters = await response.json();
            const tbody = document.getElementById('monstersTableBody');
            
            tbody.innerHTML = monsters.map(monster => `
                <tr>
                    <td>${monster.name}</td>
                    <td><span class="badge bg-info">${monster.world}</span></td>
                    <td>${monster.level}</td>
                    <td>${monster.health}</td>
                    <td><small>STR:${monster.strength} DEF:${monster.defense} SPD:${monster.speed}</small></td>
                    <td><small>XP:${monster.xp_reward} Gold:${monster.gold_reward}</small></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteMonster(${monster.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading monsters:', error);
        }
    }

    // Form submissions
    document.getElementById('createItemForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const itemData = {
            name: document.getElementById('itemName').value,
            type: document.getElementById('itemType').value,
            rarity: document.getElementById('itemRarity').value,
            description: document.getElementById('itemDescription').value,
            damage: parseInt(document.getElementById('itemDamage').value) || 0,
            price: parseInt(document.getElementById('itemPrice').value),
            required_level: parseInt(document.getElementById('itemLevel').value),
            damage_type: document.getElementById('itemDamageType').value || null,
            effects: document.getElementById('itemEffects').value || null
        };
        
        try {
            const response = await fetch('/api/rpg/items', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(itemData)
            });
            
            if (response.ok) {
                alert('Item created successfully!');
                this.reset();
                loadItems();
                loadStats();
            } else {
                alert('Error creating item');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error creating item');
        }
    });

    document.getElementById('createMonsterForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const monsterData = {
            name: document.getElementById('monsterName').value,
            world: document.getElementById('monsterWorld').value,
            level: parseInt(document.getElementById('monsterLevel').value),
            health: parseInt(document.getElementById('monsterHealth').value),
            strength: parseInt(document.getElementById('monsterStrength').value),
            defense: parseInt(document.getElementById('monsterDefense').value),
            speed: parseInt(document.getElementById('monsterSpeed').value),
            xp_reward: parseInt(document.getElementById('monsterXP').value),
            gold_reward: parseInt(document.getElementById('monsterGold').value)
        };
        
        try {
            const response = await fetch('/api/rpg/monsters', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(monsterData)
            });
            
            if (response.ok) {
                alert('Monster created successfully!');
                this.reset();
                loadMonsters();
                loadStats();
            } else {
                alert('Error creating monster');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error creating monster');
        }
    });

    async function deleteItem(id) {
        if (!confirm('Are you sure you want to delete this item?')) return;
        
        try {
            const response = await fetch(`/api/rpg/items/${id}`, {method: 'DELETE'});
            if (response.ok) {
                alert('Item deleted successfully!');
                loadItems();
                loadStats();
            } else {
                alert('Error deleting item');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting item');
        }
    }

    async function deleteMonster(id) {
        if (!confirm('Are you sure you want to delete this monster?')) return;
        
        try {
            const response = await fetch(`/api/rpg/monsters/${id}`, {method: 'DELETE'});
            if (response.ok) {
                alert('Monster deleted successfully!');
                loadMonsters();
                loadStats();
            } else {
                alert('Error deleting monster');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting monster');
        }
    }

    async function initializeDefaults() {
        if (!confirm('This will reset all monsters to defaults. Continue?')) return;
        
        try {
            const response = await fetch('/api/rpg/init_monsters', {method: 'POST'});
            if (response.ok) {
                alert('Monsters reinitialized successfully!');
                loadMonsters();
                loadStats();
            } else {
                alert('Error reinitializing monsters');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error reinitializing monsters');
        }
    }

    async function initializeShopItems() {
        if (!confirm('This will reset all shop items to defaults. Continue?')) return;
        
        try {
            const response = await fetch('/api/rpg/init_items', {method: 'POST'});
            if (response.ok) {
                alert('Shop items reinitialized successfully!');
                loadItems();
                loadStats();
            } else {
                alert('Error reinitializing items');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error reinitializing items');
        }
    }

    function refreshStats() {
        loadStats();
        loadItems();
        loadMonsters();
    }

    async function resetPlayerData(event) {
        event.preventDefault();
        
        const userId = document.getElementById('resetUserId').value.trim();
        const confirm = document.getElementById('resetConfirm').checked;
        
        if (!userId) {
            alert('Please enter a User ID');
            return;
        }
        
        // Validate that userId is numeric (format checking for user experience)
        // Actual injection prevention is handled by backend parameterized queries
        if (!/^\d+$/.test(userId)) {
            alert('User ID must be a valid number');
            return;
        }
        
        if (!confirm) {
            alert('Please confirm that you want to reset this player\'s data');
            return;
        }
        
        // Double confirmation - userId is already validated as numeric so it's safe to use
        if (!window.confirm('Are you absolutely sure you want to reset all RPG data for user ' + userId + '? This cannot be undone!')) {
            return;
        }
        
        try {
            const response = await fetch('/api/rpg/player/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: parseInt(userId, 10),
                    confirm: true
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                alert('Success! RPG data reset for user ' + userId + '\n\nTables cleared:\n' + result.tables_cleared.join('\n'));
                document.getElementById('resetPlayerForm').reset();
                loadStats(); // Refresh stats
            } else {
                alert(`Error: ${result.message || result.error || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert(`Error resetting player data: ${error.message}`);
        }
    }

    // Enhanced Skill Tree Loading
    async function loadSkillTree() {
        try {
            const response = await fetch('/api/rpg/skill_tree');
            const skillTree = await response.json();
            
            // Build tabs for each path
            const tabsContainer = document.getElementById('skillPathTabs');
            const contentContainer = document.getElementById('skillPathContent');
            
            let tabsHtml = '';
            let contentHtml = '';
            let isFirst = true;
            
            Object.entries(skillTree).forEach(([pathKey, pathData]) => {
                const activeClass = isFirst ? 'active' : '';
                const showClass = isFirst ? 'show active' : '';
                
                // Create tab
                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${activeClass}" id="${pathKey}-tab" data-bs-toggle="pill" 
                                data-bs-target="#${pathKey}-content" type="button" role="tab">
                            ${pathData.emoji} ${pathData.name}
                        </button>
                    </li>
                `;
                
                // Create content
                contentHtml += `
                    <div class="tab-pane fade ${showClass}" id="${pathKey}-content" role="tabpanel">
                        ${buildPathContent(pathKey, pathData)}
                    </div>
                `;
                
                isFirst = false;
            });
            
            tabsContainer.innerHTML = tabsHtml;
            contentContainer.innerHTML = contentHtml;
            
        } catch (error) {
            console.error('Error loading skill tree:', error);
            document.getElementById('skillPathContent').innerHTML = 
                '<div class="alert alert-danger">Error loading skill tree</div>';
        }
    }
    
    function buildPathContent(pathKey, pathData) {
        // Get specializations if any
        const specializations = pathData.specializations || [];
        
        // Group skills by tier and branch
        const skillsByTier = {
            tier1: [],
            tier2: [],
            tier3: {},  // Grouped by branch
            tier4: {},  // Grouped by branch
            ultimate: []
        };
        
        Object.entries(pathData.skills).forEach(([skillKey, skill]) => {
            const tier = skill.tier || 'tier1';
            const branch = skill.branch || 'common';
            
            if (tier === 'tier3' || tier === 'tier4') {
                if (!skillsByTier[tier][branch]) {
                    skillsByTier[tier][branch] = [];
                }
                skillsByTier[tier][branch].push({ key: skillKey, ...skill });
            } else if (tier === 'ultimate') {
                skillsByTier.ultimate.push({ key: skillKey, ...skill });
            } else {
                skillsByTier[tier].push({ key: skillKey, ...skill });
            }
        });
        
        let html = `
            <div class="path-header mb-4 p-3" style="background: linear-gradient(135deg, rgba(83,52,131,0.4) 0%, rgba(233,69,96,0.3) 100%); border-radius: 12px;">
                <h4>${pathData.emoji} ${pathData.name}</h4>
                <p class="mb-2">${pathData.description}</p>
                ${specializations.length > 0 ? `
                    <div class="specializations">
                        <strong>Spezialisierungen:</strong> 
                        ${specializations.map(s => `<span class="badge bg-secondary ms-1">${formatBranchName(s)}</span>`).join('')}
                    </div>
                ` : ''}
                <div class="mt-2">
                    <small class="text-muted">
                        Gesamt Skills: ${Object.keys(pathData.skills).length} | 
                        SP ben√∂tigt: ${Object.values(pathData.skills).reduce((sum, s) => sum + s.cost, 0)}
                    </small>
                </div>
            </div>
        `;
        
        // Tier 1 Skills
        html += buildTierSection('Tier 1 - Anf√§nger', skillsByTier.tier1, pathKey, pathData, '#27ae60');
        
        // Tier 2 Skills  
        html += buildTierSection('Tier 2 - Fortgeschritten', skillsByTier.tier2, pathKey, pathData, '#3498db');
        
        // Tier 3 Skills (branching)
        if (Object.keys(skillsByTier.tier3).length > 0) {
            html += `<h5 class="mt-4 mb-3" style="color: #9b59b6;"><i class="bi bi-diagram-3"></i> Tier 3 - Spezialisierung</h5>`;
            html += '<div class="row">';
            Object.entries(skillsByTier.tier3).forEach(([branch, skills]) => {
                const branchName = formatBranchName(branch);
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="branch-container p-3" style="background: rgba(155,89,182,0.15); border-radius: 10px; border: 2px solid #9b59b6;">
                            <h6 class="text-center mb-3" style="color: #9b59b6;">
                                ${getBranchIcon(branch)} ${branchName}
                            </h6>
                            ${skills.map(skill => buildSkillCard(skill, pathKey, pathData, '#9b59b6')).join('')}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        // Tier 4 Skills (advanced branching)
        if (Object.keys(skillsByTier.tier4).length > 0) {
            html += `<h5 class="mt-4 mb-3" style="color: #e67e22;"><i class="bi bi-star-fill"></i> Tier 4 - Meister</h5>`;
            html += '<div class="row">';
            Object.entries(skillsByTier.tier4).forEach(([branch, skills]) => {
                const branchName = formatBranchName(branch);
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="branch-container p-3" style="background: rgba(230,126,34,0.15); border-radius: 10px; border: 2px solid #e67e22;">
                            <h6 class="text-center mb-3" style="color: #e67e22;">
                                ${getBranchIcon(branch)} ${branchName}
                            </h6>
                            ${skills.map(skill => buildSkillCard(skill, pathKey, pathData, '#e67e22')).join('')}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        // Ultimate Skills
        if (skillsByTier.ultimate.length > 0) {
            html += `
                <h5 class="mt-4 mb-3" style="color: #e74c3c;"><i class="bi bi-lightning-charge-fill"></i> Ultimate F√§higkeiten</h5>
                <div class="row">
            `;
            skillsByTier.ultimate.forEach(skill => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="ultimate-skill p-3" style="background: linear-gradient(135deg, rgba(231,76,60,0.2) 0%, rgba(192,57,43,0.3) 100%); border-radius: 10px; border: 2px solid #e74c3c; cursor: pointer;"
                             onclick="showSkillDetails('${pathKey}', '${skill.key}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="text-danger">üí• ${skill.name}</strong>
                                    <div class="text-muted small mt-1">${skill.description}</div>
                                    <small class="text-warning">Ben√∂tigt: ${pathData.skills[skill.requires]?.name || skill.requires}</small>
                                </div>
                                <span class="badge bg-danger">${skill.cost} SP</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        return html;
    }
    
    function buildTierSection(title, skills, pathKey, pathData, color) {
        if (skills.length === 0) return '';
        
        return `
            <h5 class="mt-4 mb-3" style="color: ${color};"><i class="bi bi-circle-fill"></i> ${title}</h5>
            <div class="row">
                ${skills.map(skill => `
                    <div class="col-md-4 mb-3">
                        ${buildSkillCard(skill, pathKey, pathData, color)}
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    function buildSkillCard(skill, pathKey, pathData, borderColor) {
        const typeIcon = getTypeIcon(skill.type);
        const typeBadge = getTypeBadge(skill.type);
        const requiresText = skill.requires 
            ? `<small class="text-warning d-block">‚¨ÜÔ∏è ${pathData.skills[skill.requires]?.name || skill.requires}</small>` 
            : '';
        
        return `
            <div class="skill-card p-3 mb-2" style="background: rgba(30,34,56,0.8); border-radius: 8px; border-left: 4px solid ${borderColor}; cursor: pointer; transition: all 0.3s ease;"
                 onclick="showSkillDetails('${pathKey}', '${skill.key}')"
                 onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.3)';"
                 onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong>${typeIcon} ${skill.name}</strong>
                        <div class="mt-1">${typeBadge}</div>
                        <div class="text-muted small mt-1">${skill.description}</div>
                        ${requiresText}
                    </div>
                    <span class="badge bg-primary ms-2">${skill.cost} SP</span>
                </div>
            </div>
        `;
    }
    
    function getTypeIcon(type) {
        const icons = {
            'stat': 'üìà',
            'skill': '‚ö°',
            'passive': 'üîÆ',
            'ultimate': 'üí•'
        };
        return icons[type] || 'üìä';
    }
    
    function getTypeBadge(type) {
        const badges = {
            'stat': '<span class="badge bg-secondary">Stat</span>',
            'skill': '<span class="badge bg-info">Skill</span>',
            'passive': '<span class="badge bg-warning text-dark">Passive</span>',
            'ultimate': '<span class="badge bg-danger">Ultimate</span>'
        };
        return badges[type] || '<span class="badge bg-secondary">Unknown</span>';
    }
    
    function formatBranchName(branch) {
        const names = {
            'berserker': 'Berserker',
            'guardian': 'W√§chter',
            'assassin': 'Assassine',
            'shadow': 'Schatten',
            'archmage': 'Erzmagier',
            'spellweaver': 'Zauberweber',
            'priest': 'Priester',
            'paladin': 'Paladin',
            'lich': 'Lich',
            'blood_mage': 'Blutmagier',
            'pyromancer': 'Pyromant',
            'cryomancer': 'Kryomant',
            'stormcaller': 'Sturmrufer',
            'common': 'Allgemein'
        };
        return names[branch] || branch;
    }
    
    function getBranchIcon(branch) {
        const icons = {
            'berserker': 'üî•',
            'guardian': 'üõ°Ô∏è',
            'assassin': 'üó°Ô∏è',
            'shadow': 'üåë',
            'archmage': '‚ú®',
            'spellweaver': 'üï∏Ô∏è',
            'priest': '‚úùÔ∏è',
            'paladin': '‚öîÔ∏è',
            'lich': 'üíÄ',
            'blood_mage': 'ü©∏',
            'pyromancer': 'üî•',
            'cryomancer': '‚ùÑÔ∏è',
            'stormcaller': '‚ö°',
            'common': '‚≠ê'
        };
        return icons[branch] || 'üìå';
    }

    function topologicalSortSkills(skills) {
        // Simple topological sort for skills based on requirements
        const sorted = [];
        const visited = new Set();
        
        function visit(skillKey) {
            if (visited.has(skillKey)) return;
            visited.add(skillKey);
            
            const skill = skills[skillKey];
            if (skill.requires && skills[skill.requires]) {
                visit(skill.requires);
            }
            
            sorted.push(skillKey);
        }
        
        Object.keys(skills).forEach(skillKey => visit(skillKey));
        return sorted;
    }

    function showSkillDetails(pathKey, skillKey) {
        fetch('/api/rpg/skill_tree')
            .then(response => response.json())
            .then(skillTree => {
                const pathData = skillTree[pathKey];
                const skill = pathData.skills[skillKey];
                
                let effectsHtml = '<div class="effects-list">';
                if (skill.effect) {
                    Object.entries(skill.effect).forEach(([key, value]) => {
                        const displayKey = formatEffectKey(key);
                        const displayValue = formatEffectValue(key, value);
                        effectsHtml += `
                            <div class="effect-item d-flex justify-content-between p-2 mb-1" style="background: rgba(83,52,131,0.2); border-radius: 5px;">
                                <span>${displayKey}</span>
                                <strong class="text-success">${displayValue}</strong>
                            </div>
                        `;
                    });
                }
                effectsHtml += '</div>';
                
                const requiresHtml = skill.requires 
                    ? `<div class="alert alert-warning py-2"><i class="bi bi-arrow-up-circle"></i> <strong>Ben√∂tigt:</strong> ${pathData.skills[skill.requires]?.name || skill.requires}</div>`
                    : '<div class="alert alert-success py-2"><i class="bi bi-check-circle"></i> Keine Voraussetzungen</div>';
                
                const tierInfo = skill.tier ? `<span class="badge ${getTierBadgeClass(skill.tier)} ms-2">${formatTierName(skill.tier)}</span>` : '';
                const branchInfo = skill.branch ? `<span class="badge bg-secondary ms-2">${formatBranchName(skill.branch)}</span>` : '';
                
                const modalBody = document.getElementById('skillModalBody');
                modalBody.innerHTML = `
                    <div class="skill-detail-header mb-4 p-3" style="background: linear-gradient(135deg, rgba(83,52,131,0.3) 0%, rgba(233,69,96,0.2) 100%); border-radius: 10px;">
                        <h4 class="mb-2">${pathData.emoji} ${skill.name}</h4>
                        <div class="badges">
                            ${getTypeBadge(skill.type)}
                            <span class="badge bg-primary ms-2">${skill.cost} SP</span>
                            ${tierInfo}
                            ${branchInfo}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6><i class="bi bi-info-circle"></i> Beschreibung</h6>
                        <p class="lead">${skill.description}</p>
                    </div>
                    
                    <div class="mb-4">
                        <h6><i class="bi bi-diagram-3"></i> Pfad</h6>
                        <p>${pathData.emoji} <strong>${pathData.name}</strong> - ${pathData.description}</p>
                    </div>
                    
                    <div class="mb-4">
                        <h6><i class="bi bi-lock"></i> Voraussetzungen</h6>
                        ${requiresHtml}
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="bi bi-magic"></i> Effekte</h6>
                        ${effectsHtml}
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('skillModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading skill details:', error);
            });
    }
    
    function formatEffectKey(key) {
        const keyNames = {
            'strength': 'üí™ St√§rke',
            'defense': 'üõ°Ô∏è Verteidigung',
            'speed': '‚ö° Geschwindigkeit',
            'dexterity': 'üéØ Geschicklichkeit',
            'max_health': '‚ù§Ô∏è Max HP',
            'damage_multiplier': '‚öîÔ∏è Schadensmultiplikator',
            'cooldown': '‚è±Ô∏è Abklingzeit',
            'lifesteal_percent': 'ü©∏ Lebensentzug',
            'crit_chance': 'üéØ Kritische Trefferchance',
            'crit_damage_bonus': 'üí• Kritischer Schaden',
            'dodge_chance': 'üí® Ausweichen',
            'hp_regen_percent': 'üíö HP Regeneration',
            'damage_reduction': 'üõ°Ô∏è Schadensreduktion',
            'stun_duration': 'üòµ Bet√§ubungsdauer',
            'element': 'üåü Element',
            'heal': 'üíö Heilung',
            'burn_damage': 'üî• Brennschaden',
            'freeze_chance': '‚ùÑÔ∏è Einfrierchance',
            'poison_damage': '‚ò†Ô∏è Giftschaden',
            'reflect_damage_percent': '‚Ü©Ô∏è Schadensreflexion',
            'spell_damage_bonus': '‚ú® Zauberschaden',
            'fire_damage_bonus': 'üî• Feuerschaden',
            'ice_damage_bonus': '‚ùÑÔ∏è Eisschaden',
            'lightning_damage_bonus': '‚ö° Blitzschaden',
            'dark_damage_bonus': 'üåë Dunkelschaden',
            'healing_bonus': 'üíö Heilungsbonus',
            'duration': '‚è≥ Dauer (Runden)'
        };
        return keyNames[key] || key.replace(/_/g, ' ');
    }
    
    function formatEffectValue(key, value) {
        // Format damage multiplier specifically (e.g., 1.5 = "150% Schaden")
        if (key === 'damage_multiplier' || key.includes('_multiplier')) {
            if (typeof value === 'number') {
                return `${(value * 100).toFixed(0)}% Schaden`;
            }
        }
        // Format percentages (values 0-1 that represent percentages)
        if (key.includes('percent') || key.includes('chance') || key.includes('reduction')) {
            if (typeof value === 'number' && value > 0 && value <= 1) {
                return `${(value * 100).toFixed(0)}%`;
            }
        }
        // Format bonus values (can be > 1 for large bonuses)
        if (key.includes('bonus')) {
            if (typeof value === 'number') {
                if (value <= 1 && value > 0) {
                    return `+${(value * 100).toFixed(0)}%`;
                }
                return `+${value}`;
            }
        }
        // Format booleans
        if (typeof value === 'boolean') {
            return value ? '‚úÖ Ja' : '‚ùå Nein';
        }
        // Format numbers with appropriate prefix
        if (typeof value === 'number') {
            // Don't add + for cooldown, duration, hits, etc.
            if (key === 'cooldown' || key === 'duration' || key === 'hits' || key === 'delay') {
                return `${value} Runden`;
            }
            return value > 0 ? `+${value}` : String(value);
        }
        return value;
    }
    
    function getTierBadgeClass(tier) {
        const classes = {
            'tier1': 'bg-success',
            'tier2': 'bg-info',
            'tier3': 'bg-purple',
            'tier4': 'bg-warning text-dark',
            'ultimate': 'bg-danger'
        };
        return classes[tier] || 'bg-secondary';
    }
    
    function formatTierName(tier) {
        const names = {
            'tier1': 'Tier 1',
            'tier2': 'Tier 2',
            'tier3': 'Tier 3',
            'tier4': 'Tier 4',
            'ultimate': 'Ultimate'
        };
        return names[tier] || tier;
    }

</script>
{% endblock %}
