{% extends "layout.html" %}

{% block title %}RPG Admin - Sulfur Bot Dashboard{% endblock %}

{% block extra_styles %}
<style>
    /* RPG-specific rarity colors */
    .rarity-common { background: #95a5a6; }
    .rarity-uncommon { background: #27ae60; }
    .rarity-rare { background: #3498db; }
    .rarity-epic { background: #9b59b6; }
    .rarity-legendary { background: #f39c12; }
    
    /* Override stat-card for RPG specific look */
    .rpg-stat-card {
        background: linear-gradient(135deg, rgba(83, 52, 131, 0.3) 0%, rgba(233, 69, 96, 0.3) 100%);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .rpg-stat-card:hover {
        border-color: var(--accent-primary);
        transform: scale(1.02);
    }
    
    .rpg-stat-card .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--accent-primary);
    }
    
    .rpg-stat-card i {
        font-size: 2rem;
        color: var(--accent-primary);
    }
    
    /* Section titles */
    .section-title {
        color: var(--accent-primary);
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }
    
    /* Tab styling */
    .nav-tabs {
        border-bottom: 2px solid var(--border-color);
    }
    
    .nav-tabs .nav-link {
        color: var(--text-secondary);
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
    }
    
    .nav-tabs .nav-link.active {
        color: var(--accent-primary);
        background: transparent;
        border-bottom-color: var(--accent-primary);
    }
    
    /* Table improvements */
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .table-responsive::-webkit-scrollbar {
        width: 8px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: var(--accent-secondary);
        border-radius: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: var(--accent-primary);
    }
</style>
{% endblock %}

{% block content %}
<!-- RPG Statistics -->
<div class="row mb-4 fade-in">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="rpg-stat-card">
            <i class="bi bi-people-fill"></i>
            <div class="stat-value" id="total-players">0</div>
            <div>Total Players</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="rpg-stat-card">
            <i class="bi bi-shield-fill-exclamation"></i>
            <div class="stat-value" id="total-monsters">0</div>
            <div>Monsters</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="rpg-stat-card">
            <i class="bi bi-box-seam"></i>
            <div class="stat-value" id="total-items">0</div>
            <div>Items</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="rpg-stat-card">
            <i class="bi bi-coin"></i>
            <div class="stat-value" id="total-gold">0</div>
            <div>Total Gold</div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="rpgTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">
            <i class="bi bi-box"></i> Items & Weapons
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="monsters-tab" data-bs-toggle="tab" data-bs-target="#monsters" type="button" role="tab">
            <i class="bi bi-bug-fill"></i> Monsters
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="skills-tab" data-bs-toggle="tab" data-bs-target="#skills" type="button" role="tab">
            <i class="bi bi-tree-fill"></i> Skill Tree
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button" role="tab">
            <i class="bi bi-people-fill"></i> Player Management
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
            <i class="bi bi-gear-fill"></i> Settings
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content fade-in" id="rpgTabContent">
    <!-- Items Tab -->
    <div class="tab-pane fade show active" id="items" role="tabpanel">
        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-plus-circle"></i> Create Item</h3>
                    <form id="createItemForm">
                        <div class="mb-3">
                            <label for="itemName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="mb-3">
                            <label for="itemType" class="form-label">Type</label>
                            <select class="form-select" id="itemType" required>
                                <option value="weapon">Weapon</option>
                                <option value="skill">Skill</option>
                                <option value="consumable">Consumable</option>
                                <option value="loot">Loot</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="itemRarity" class="form-label">Rarity</label>
                            <select class="form-select" id="itemRarity" required>
                                <option value="common">Common</option>
                                <option value="uncommon">Uncommon</option>
                                <option value="rare">Rare</option>
                                <option value="epic">Epic</option>
                                <option value="legendary">Legendary</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="itemDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="itemDescription" rows="2" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="itemDamage" class="form-label">Damage</label>
                                <input type="number" class="form-control" id="itemDamage" value="0" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemPrice" class="form-label">Price</label>
                                <input type="number" class="form-control" id="itemPrice" value="100" min="0" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="itemLevel" class="form-label">Required Level</label>
                                <input type="number" class="form-control" id="itemLevel" value="1" min="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemDamageType" class="form-label">Damage Type</label>
                                <select class="form-select" id="itemDamageType">
                                    <option value="">None</option>
                                    <option value="physical">Physical</option>
                                    <option value="fire">Fire</option>
                                    <option value="ice">Ice</option>
                                    <option value="lightning">Lightning</option>
                                    <option value="poison">Poison</option>
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="itemEffects" class="form-label">Effects (JSON)</label>
                            <textarea class="form-control" id="itemEffects" rows="2" placeholder='{"heal": 50}'></textarea>
                            <small class="text-muted">Optional: JSON object with effects</small>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus-circle"></i> Create Item
                        </button>
                    </form>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-list"></i> All Items</h3>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="itemsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Rarity</th>
                                    <th>Damage</th>
                                    <th>Price</th>
                                    <th>Level</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monsters Tab -->
    <div class="tab-pane fade" id="monsters" role="tabpanel">
        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-plus-circle"></i> Create Monster</h3>
                    <form id="createMonsterForm">
                        <div class="mb-3">
                            <label for="monsterName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="monsterName" required>
                        </div>
                        <div class="mb-3">
                            <label for="monsterWorld" class="form-label">World</label>
                            <select class="form-select" id="monsterWorld" required>
                                <option value="overworld">Overworld</option>
                                <option value="underworld">Underworld</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="monsterLevel" class="form-label">Level</label>
                                <input type="number" class="form-control" id="monsterLevel" value="1" min="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="monsterHealth" class="form-label">Health</label>
                                <input type="number" class="form-control" id="monsterHealth" value="50" min="1" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="monsterStrength" class="form-label">Strength</label>
                                <input type="number" class="form-control" id="monsterStrength" value="5" min="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="monsterDefense" class="form-label">Defense</label>
                                <input type="number" class="form-control" id="monsterDefense" value="5" min="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="monsterSpeed" class="form-label">Speed</label>
                                <input type="number" class="form-control" id="monsterSpeed" value="5" min="1" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="monsterXP" class="form-label">XP Reward</label>
                                <input type="number" class="form-control" id="monsterXP" value="10" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="monsterGold" class="form-label">Gold Reward</label>
                                <input type="number" class="form-control" id="monsterGold" value="10" min="0" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus-circle"></i> Create Monster
                        </button>
                    </form>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-list"></i> All Monsters</h3>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="monstersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>World</th>
                                    <th>Level</th>
                                    <th>HP</th>
                                    <th>Stats</th>
                                    <th>Rewards</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="monstersTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skill Tree Tab -->
    <div class="tab-pane fade" id="skills" role="tabpanel">
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-tree-fill"></i> Skill Tree Paths</h3>
                    <p class="text-muted">View and manage all skill tree paths and their skills</p>
                    
                    <div class="row mt-4" id="skillTreeContainer">
                        <!-- Skill trees will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Skill Details Modal -->
        <div class="modal fade" id="skillModal" tabindex="-1" aria-labelledby="skillModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                    <div class="modal-header">
                        <h5 class="modal-title" id="skillModalLabel">Skill Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="skillModalBody">
                        <!-- Skill details will be loaded here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Players Tab -->
    <div class="tab-pane fade" id="players" role="tabpanel">
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-person-x-fill"></i> Reset Player RPG Data</h3>
                    <p class="text-muted">This will completely reset a player's RPG progress, returning them to a fresh start.</p>
                    <p class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> <strong>Warning:</strong> This action cannot be undone!</p>
                    
                    <form id="resetPlayerForm" onsubmit="resetPlayerData(event)">
                        <div class="mb-3">
                            <label for="resetUserId" class="form-label">User ID</label>
                            <input type="text" class="form-control" id="resetUserId" placeholder="Enter Discord User ID" required>
                            <small class="form-text text-muted">Enter the Discord User ID of the player to reset</small>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="resetConfirm" required>
                            <label class="form-check-label text-danger" for="resetConfirm">
                                I confirm that I want to permanently delete this player's RPG data
                            </label>
                        </div>
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="bi bi-trash-fill"></i> Reset Player RPG Data
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-gear"></i> RPG Settings</h3>
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="adventureCooldown" class="form-label">Adventure Cooldown (seconds)</label>
                            <input type="number" class="form-control" id="adventureCooldown" value="120" min="0">
                        </div>
                        <div class="mb-3">
                            <label for="baseStatValue" class="form-label">Base Stat Value</label>
                            <input type="number" class="form-control" id="baseStatValue" value="10" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="respecCost" class="form-label">Respec Cost Per Point</label>
                            <input type="number" class="form-control" id="respecCost" value="50" min="0">
                        </div>
                        <div class="mb-3">
                            <label for="levelRewardMultiplier" class="form-label">Level Reward Multiplier</label>
                            <input type="number" class="form-control" id="levelRewardMultiplier" value="0.1" step="0.01" min="0">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-save"></i> Save Settings
                        </button>
                    </form>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card p-4">
                    <h3 class="section-title"><i class="bi bi-tools"></i> Maintenance</h3>
                    <div class="d-grid gap-3">
                        <button class="btn btn-primary" onclick="initializeDefaults()">
                            <i class="bi bi-arrow-clockwise"></i> Reinitialize Default Monsters
                        </button>
                        <button class="btn btn-primary" onclick="initializeShopItems()">
                            <i class="bi bi-shop"></i> Reinitialize Shop Items
                        </button>
                        <button class="btn btn-warning" onclick="refreshStats()">
                            <i class="bi bi-arrow-repeat"></i> Refresh Statistics
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load statistics on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadItems();
        loadMonsters();
        loadSkillTree();
    });

    async function loadStats() {
        try {
            const response = await fetch('/api/rpg/stats');
            const data = await response.json();
            
            document.getElementById('total-players').textContent = data.total_players || 0;
            document.getElementById('total-monsters').textContent = data.total_monsters || 0;
            document.getElementById('total-items').textContent = data.total_items || 0;
            document.getElementById('total-gold').textContent = (data.total_gold || 0).toLocaleString();
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async function loadItems() {
        try {
            const response = await fetch('/api/rpg/items');
            const items = await response.json();
            const tbody = document.getElementById('itemsTableBody');
            
            tbody.innerHTML = items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td><span class="badge bg-secondary">${item.type}</span></td>
                    <td><span class="badge rarity-${item.rarity}">${item.rarity}</span></td>
                    <td>${item.damage || 0}</td>
                    <td>${item.price}</td>
                    <td>${item.required_level}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading items:', error);
        }
    }

    async function loadMonsters() {
        try {
            const response = await fetch('/api/rpg/monsters');
            const monsters = await response.json();
            const tbody = document.getElementById('monstersTableBody');
            
            tbody.innerHTML = monsters.map(monster => `
                <tr>
                    <td>${monster.name}</td>
                    <td><span class="badge bg-info">${monster.world}</span></td>
                    <td>${monster.level}</td>
                    <td>${monster.health}</td>
                    <td><small>STR:${monster.strength} DEF:${monster.defense} SPD:${monster.speed}</small></td>
                    <td><small>XP:${monster.xp_reward} Gold:${monster.gold_reward}</small></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteMonster(${monster.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading monsters:', error);
        }
    }

    // Form submissions
    document.getElementById('createItemForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const itemData = {
            name: document.getElementById('itemName').value,
            type: document.getElementById('itemType').value,
            rarity: document.getElementById('itemRarity').value,
            description: document.getElementById('itemDescription').value,
            damage: parseInt(document.getElementById('itemDamage').value) || 0,
            price: parseInt(document.getElementById('itemPrice').value),
            required_level: parseInt(document.getElementById('itemLevel').value),
            damage_type: document.getElementById('itemDamageType').value || null,
            effects: document.getElementById('itemEffects').value || null
        };
        
        try {
            const response = await fetch('/api/rpg/items', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(itemData)
            });
            
            if (response.ok) {
                alert('Item created successfully!');
                this.reset();
                loadItems();
                loadStats();
            } else {
                alert('Error creating item');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error creating item');
        }
    });

    document.getElementById('createMonsterForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const monsterData = {
            name: document.getElementById('monsterName').value,
            world: document.getElementById('monsterWorld').value,
            level: parseInt(document.getElementById('monsterLevel').value),
            health: parseInt(document.getElementById('monsterHealth').value),
            strength: parseInt(document.getElementById('monsterStrength').value),
            defense: parseInt(document.getElementById('monsterDefense').value),
            speed: parseInt(document.getElementById('monsterSpeed').value),
            xp_reward: parseInt(document.getElementById('monsterXP').value),
            gold_reward: parseInt(document.getElementById('monsterGold').value)
        };
        
        try {
            const response = await fetch('/api/rpg/monsters', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(monsterData)
            });
            
            if (response.ok) {
                alert('Monster created successfully!');
                this.reset();
                loadMonsters();
                loadStats();
            } else {
                alert('Error creating monster');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error creating monster');
        }
    });

    async function deleteItem(id) {
        if (!confirm('Are you sure you want to delete this item?')) return;
        
        try {
            const response = await fetch(`/api/rpg/items/${id}`, {method: 'DELETE'});
            if (response.ok) {
                alert('Item deleted successfully!');
                loadItems();
                loadStats();
            } else {
                alert('Error deleting item');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting item');
        }
    }

    async function deleteMonster(id) {
        if (!confirm('Are you sure you want to delete this monster?')) return;
        
        try {
            const response = await fetch(`/api/rpg/monsters/${id}`, {method: 'DELETE'});
            if (response.ok) {
                alert('Monster deleted successfully!');
                loadMonsters();
                loadStats();
            } else {
                alert('Error deleting monster');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting monster');
        }
    }

    async function initializeDefaults() {
        if (!confirm('This will reset all monsters to defaults. Continue?')) return;
        
        try {
            const response = await fetch('/api/rpg/init_monsters', {method: 'POST'});
            if (response.ok) {
                alert('Monsters reinitialized successfully!');
                loadMonsters();
                loadStats();
            } else {
                alert('Error reinitializing monsters');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error reinitializing monsters');
        }
    }

    async function initializeShopItems() {
        if (!confirm('This will reset all shop items to defaults. Continue?')) return;
        
        try {
            const response = await fetch('/api/rpg/init_items', {method: 'POST'});
            if (response.ok) {
                alert('Shop items reinitialized successfully!');
                loadItems();
                loadStats();
            } else {
                alert('Error reinitializing items');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error reinitializing items');
        }
    }

    function refreshStats() {
        loadStats();
        loadItems();
        loadMonsters();
    }

    async function resetPlayerData(event) {
        event.preventDefault();
        
        const userId = document.getElementById('resetUserId').value.trim();
        const confirm = document.getElementById('resetConfirm').checked;
        
        if (!userId) {
            alert('Please enter a User ID');
            return;
        }
        
        if (!confirm) {
            alert('Please confirm that you want to reset this player\'s data');
            return;
        }
        
        // Double confirmation
        if (!window.confirm(`Are you absolutely sure you want to reset all RPG data for user ${userId}? This cannot be undone!`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/rpg/player/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    confirm: true
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                alert(`Success! RPG data reset for user ${userId}\n\nTables cleared:\n${result.tables_cleared.join('\n')}`);
                document.getElementById('resetPlayerForm').reset();
                loadStats(); // Refresh stats
            } else {
                alert(`Error: ${result.message || result.error || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert(`Error resetting player data: ${error.message}`);
        }
    }

    async function loadSkillTree() {
        try {
            const response = await fetch('/api/rpg/skill_tree');
            const skillTree = await response.json();
            const container = document.getElementById('skillTreeContainer');
            
            let html = '';
            
            // Create a card for each path
            Object.entries(skillTree).forEach(([pathKey, pathData]) => {
                html += `
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header text-center">
                            <h4>${pathData.emoji} ${pathData.name}</h4>
                            <p class="text-muted small mb-0">${pathData.description}</p>
                        </div>
                        <div class="card-body">
                            <div class="skill-list">
                `;
                
                // Display skills in order (considering requirements)
                const sortedSkills = topologicalSortSkills(pathData.skills);
                
                sortedSkills.forEach(skillKey => {
                    const skill = pathData.skills[skillKey];
                    const typeIcon = skill.type === 'active' ? 'âš¡' : 'ðŸ“Š';
                    const requiresText = skill.requires ? `<small class="text-warning">Requires: ${pathData.skills[skill.requires]?.name || skill.requires}</small>` : '';
                    
                    html += `
                    <div class="skill-item mb-3 p-3" style="background: rgba(83, 52, 131, 0.2); border-radius: 8px; border-left: 3px solid var(--accent-primary); cursor: pointer;" 
                         onclick="showSkillDetails('${pathKey}', '${skillKey}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${typeIcon} ${skill.name}</strong>
                                <div class="text-muted small">${skill.description}</div>
                                ${requiresText}
                            </div>
                            <span class="badge bg-primary">${skill.cost} SP</span>
                        </div>
                    </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });
            
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading skill tree:', error);
            document.getElementById('skillTreeContainer').innerHTML = 
                '<div class="col-12"><div class="alert alert-danger">Error loading skill tree</div></div>';
        }
    }

    function topologicalSortSkills(skills) {
        // Simple topological sort for skills based on requirements
        const sorted = [];
        const visited = new Set();
        
        function visit(skillKey) {
            if (visited.has(skillKey)) return;
            visited.add(skillKey);
            
            const skill = skills[skillKey];
            if (skill.requires && skills[skill.requires]) {
                visit(skill.requires);
            }
            
            sorted.push(skillKey);
        }
        
        Object.keys(skills).forEach(skillKey => visit(skillKey));
        return sorted;
    }

    function showSkillDetails(pathKey, skillKey) {
        fetch('/api/rpg/skill_tree')
            .then(response => response.json())
            .then(skillTree => {
                const pathData = skillTree[pathKey];
                const skill = pathData.skills[skillKey];
                
                let effectsHtml = '<ul class="list-unstyled">';
                if (skill.effect) {
                    Object.entries(skill.effect).forEach(([key, value]) => {
                        const displayValue = typeof value === 'number' && value < 1 && value > 0 
                            ? `${(value * 100).toFixed(0)}%` 
                            : value;
                        effectsHtml += `<li><strong>${key}:</strong> ${displayValue}</li>`;
                    });
                }
                effectsHtml += '</ul>';
                
                const requiresHtml = skill.requires 
                    ? `<p><strong>Requires:</strong> ${pathData.skills[skill.requires]?.name || skill.requires}</p>`
                    : '<p><em>No prerequisites</em></p>';
                
                const modalBody = document.getElementById('skillModalBody');
                modalBody.innerHTML = `
                    <div class="mb-3">
                        <h4>${pathData.emoji} ${skill.name}</h4>
                        <span class="badge bg-${skill.type === 'active' ? 'success' : 'info'}">${skill.type.toUpperCase()}</span>
                        <span class="badge bg-primary ms-2">Cost: ${skill.cost} SP</span>
                    </div>
                    <div class="mb-3">
                        <h6>Description</h6>
                        <p>${skill.description}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Path</h6>
                        <p>${pathData.emoji} ${pathData.name} - ${pathData.description}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Requirements</h6>
                        ${requiresHtml}
                    </div>
                    <div class="mb-3">
                        <h6>Effects</h6>
                        ${effectsHtml}
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('skillModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading skill details:', error);
            });
    }

</script>
{% endblock %}
