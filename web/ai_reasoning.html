{% extends "layout.html" %}
{% block title %}AI Reasoning Debug - Sulfur Bot{% endblock %}

{% block extra_styles %}
<style>
    .reasoning-card {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .reasoning-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
    }
    
    .context-message {
        background: rgba(26, 26, 46, 0.7);
        border-left: 3px solid var(--info);
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
    }
    
    .context-message.user {
        border-left-color: var(--success);
    }
    
    .context-message.assistant {
        border-left-color: var(--primary);
    }
    
    .progress {
        height: 25px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .token-bar {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    
    #context-window-container {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4 fade-in">
    <div class="col-12">
        <h2 class="gradient-text mb-4">
            <i class="bi bi-cpu"></i> AI Reasoning Debug
        </h2>
    </div>
</div>

<!-- Stats Overview -->
<div class="row mb-4 fade-in">
    <div class="col-md-3 mb-3">
        <div class="reasoning-card">
            <h5><i class="bi bi-lightning-charge"></i> Token Usage</h5>
            <h3 class="metric-value" id="current-tokens">0</h3>
            <div class="progress mt-2">
                <div class="progress-bar token-bar" role="progressbar" id="token-progress" style="width: 0%"></div>
            </div>
            <small class="text-muted">of <span id="max-tokens">4000</span> tokens</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="reasoning-card">
            <h5><i class="bi bi-chat-dots"></i> Context Messages</h5>
            <h3 class="metric-value" id="context-messages">0</h3>
            <small class="text-muted">in current window</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="reasoning-card">
            <h5><i class="bi bi-file-earmark-zip"></i> Compressions</h5>
            <h3 class="metric-value" id="compressions">0</h3>
            <small class="text-muted">context summaries</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="reasoning-card">
            <h5><i class="bi bi-speedometer2"></i> Avg Response</h5>
            <h3 class="metric-value" id="avg-response-time">0ms</h3>
            <small class="text-muted">response time</small>
        </div>
    </div>
</div>

<!-- API Usage Table -->
<div class="row mb-4 fade-in">
    <div class="col-12">
        <div class="reasoning-card">
            <h4><i class="bi bi-graph-up"></i> API Usage (Last 24h)</h4>
            <div class="table-responsive mt-3">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Calls</th>
                            <th>Input Tokens</th>
                            <th>Output Tokens</th>
                            <th>Total Tokens</th>
                        </tr>
                    </thead>
                    <tbody id="api-usage-table">
                        <tr>
                            <td colspan="5" class="text-center text-muted">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Context Window -->
<div class="row mb-4 fade-in">
    <div class="col-12">
        <div class="reasoning-card">
            <h4><i class="bi bi-chat-left-text"></i> Context Window (Recent)</h4>
            <div id="context-window-container" class="mt-3">
                <p class="text-muted">No context messages available</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function loadReasoningData() {
        try {
            const response = await fetch('/api/ai_reasoning_debug');
            if (!response.ok) {
                throw new Error('Failed to fetch reasoning data');
            }
            const data = await response.json();
            
            // Update metrics
            document.getElementById('current-tokens').textContent = data.current_tokens || 0;
            document.getElementById('max-tokens').textContent = data.max_tokens || 4000;
            document.getElementById('context-messages').textContent = data.context_messages || 0;
            document.getElementById('compressions').textContent = data.compressed_summaries || 0;
            document.getElementById('avg-response-time').textContent = (data.avg_response_time || 0) + 'ms';
            
            // Update progress bar
            const tokenPercent = data.max_tokens > 0 ? (data.current_tokens / data.max_tokens * 100) : 0;
            const progressBar = document.getElementById('token-progress');
            progressBar.style.width = tokenPercent + '%';
            progressBar.textContent = tokenPercent.toFixed(1) + '%';
            
            // Update API usage table
            const tableBody = document.getElementById('api-usage-table');
            if (data.api_usage && data.api_usage.length > 0) {
                tableBody.innerHTML = data.api_usage.map(row => `
                    <tr>
                        <td><span class="badge bg-secondary">${row.model || 'Unknown'}</span></td>
                        <td>${row.calls || 0}</td>
                        <td>${(row.input_tokens || 0).toLocaleString()}</td>
                        <td>${(row.output_tokens || 0).toLocaleString()}</td>
                        <td><strong>${(row.total_tokens || 0).toLocaleString()}</strong></td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No API usage data</td></tr>';
            }
            
            // Update context window
            const contextContainer = document.getElementById('context-window-container');
            if (data.context_window && data.context_window.length > 0) {
                contextContainer.innerHTML = data.context_window.map(msg => `
                    <div class="context-message ${msg.role}">
                        <strong>${msg.role === 'user' ? '<i class="bi bi-person"></i> User' : '<i class="bi bi-robot"></i> Assistant'}</strong>
                        <span class="text-muted float-end">${msg.timestamp || ''}</span>
                        <p class="mb-0 mt-2">${escapeHtml(msg.content)}</p>
                    </div>
                `).join('');
            } else {
                contextContainer.innerHTML = '<p class="text-muted">No context messages available</p>';
            }
            
        } catch (error) {
            console.error('Error loading reasoning data:', error);
            document.getElementById('api-usage-table').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>';
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }
    
    // Load data on page load and refresh every 30 seconds
    loadReasoningData();
    setInterval(loadReasoningData, 30000);
</script>
{% endblock %}
