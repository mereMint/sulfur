{% extends "layout.html" %}

{% block title %}VPN Manager - Sulfur Bot Dashboard{% endblock %}

{% block content %}
<style>
    .vpn-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .vpn-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px var(--card-shadow);
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-online { background-color: var(--success); }
    .status-offline { background-color: var(--danger); }
    .status-pending { background-color: var(--warning); }
    
    .client-row {
        background: rgba(232, 165, 85, 0.05);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        transition: background 0.2s;
    }

    .client-row:hover {
        background: rgba(232, 165, 85, 0.1);
    }

    .config-box {
        background: var(--bg-primary, #1a1410);
        border-radius: 8px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 12px;
        padding: 15px;
        color: var(--lofi-green, #a8b88c);
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
    }

    .btn-vpn {
        background: linear-gradient(135deg, var(--lofi-amber, #e8a555) 0%, var(--lofi-peach, #d4956a) 100%);
        border: none;
        color: #1a1410;
    }

    .btn-vpn:hover {
        background: linear-gradient(135deg, var(--lofi-peach, #d4956a) 0%, var(--lofi-amber, #e8a555) 100%);
        color: #1a1410;
    }

    .platform-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 12px;
        background: rgba(232, 165, 85, 0.2);
    }
</style>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-shield-lock"></i> VPN Manager</h2>
            <p class="text-muted mb-0">WireGuard VPN configuration and management</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="refreshStatus()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button class="btn btn-vpn" onclick="openAddDevice()">
                <i class="bi bi-plus-lg"></i> Add Device
            </button>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="vpn-card p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-shield-check fs-2 me-3" style="color: var(--lofi-green);"></i>
                    <div>
                        <h5 class="mb-0">WireGuard Status</h5>
                        <span id="wg-status" class="text-muted">Checking...</span>
                    </div>
                </div>
                <div id="wg-installed-badge" class="badge bg-secondary">Unknown</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="vpn-card p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-hdd-network fs-2 me-3" style="color: var(--lofi-blue);"></i>
                    <div>
                        <h5 class="mb-0">Server Address</h5>
                        <span id="server-address" class="text-muted">--</span>
                    </div>
                </div>
                <span id="server-port" class="badge bg-info">Port: --</span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="vpn-card p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-people fs-2 me-3" style="color: var(--lofi-pink);"></i>
                    <div>
                        <h5 class="mb-0">Connected Clients</h5>
                        <span id="client-count" class="text-muted">0</span>
                    </div>
                </div>
                <span class="badge bg-primary">Active Connections</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Client Management -->
        <div class="col-lg-8">
            <div class="vpn-card">
                <div class="card-header d-flex justify-content-between align-items-center p-3" 
                     style="background: var(--bg-tertiary); border-radius: 12px 12px 0 0;">
                    <h5 class="mb-0"><i class="bi bi-laptop"></i> VPN Clients</h5>
                    <button class="btn btn-sm btn-vpn" onclick="openAddDevice()">
                        <i class="bi bi-plus"></i> Add Client
                    </button>
                </div>
                <div class="card-body p-3">
                    <div id="clients-list">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-shield-x fs-1 mb-3 d-block"></i>
                            <p>No VPN clients configured</p>
                            <button class="btn btn-vpn" onclick="openAddDevice()">
                                <i class="bi bi-plus-lg"></i> Add Your First Client
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Info -->
        <div class="col-lg-4">
            <div class="vpn-card mb-4">
                <div class="card-header p-3" style="background: var(--bg-tertiary); border-radius: 12px 12px 0 0;">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                </div>
                <div class="card-body p-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-secondary" onclick="generateServerConfig()">
                            <i class="bi bi-file-code"></i> Setup VPN Server
                        </button>
                        <button class="btn btn-outline-secondary" onclick="showQuickSetup()">
                            <i class="bi bi-book"></i> Quick Setup Guide
                        </button>
                        <button class="btn btn-outline-secondary" onclick="showServerQR()">
                            <i class="bi bi-qr-code"></i> Show Server QR Code
                        </button>
                        <button class="btn btn-outline-danger" onclick="restartVPN()">
                            <i class="bi bi-arrow-repeat"></i> Restart VPN Service
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="vpn-card">
                <div class="card-header p-3" style="background: var(--bg-tertiary); border-radius: 12px 12px 0 0;">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Platform Support</h5>
                </div>
                <div class="card-body p-3">
                    <p class="text-muted small mb-3">WireGuard clients are available for:</p>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="platform-badge"><i class="bi bi-windows"></i> Windows</span>
                        <span class="platform-badge"><i class="bi bi-apple"></i> macOS</span>
                        <span class="platform-badge"><i class="bi bi-ubuntu"></i> Linux</span>
                        <span class="platform-badge"><i class="bi bi-android"></i> Android</span>
                        <span class="platform-badge"><i class="bi bi-phone"></i> iOS</span>
                    </div>
                    <hr>
                    <p class="text-muted small mb-2">Official WireGuard App:</p>
                    <a href="https://www.wireguard.com/install/" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                        <i class="bi bi-download"></i> Download WireGuard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--bg-secondary);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add VPN Device</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-device-form">
                    <div class="mb-3">
                        <label class="form-label">Device Name</label>
                        <input type="text" class="form-control" id="device-name" 
                               placeholder="e.g., John's Phone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discord User ID (optional)</label>
                        <input type="text" class="form-control" id="discord-user-id" 
                               placeholder="Discord user ID for linking">
                    </div>
                </form>
                <div id="add-device-status" class="alert alert-info" style="display: none;">
                    <i class="bi bi-hourglass-split"></i> Creating device configuration...
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-vpn" id="add-device-btn" onclick="addDevice()">
                    <i class="bi bi-plus-lg"></i> Create Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Server Setup Modal -->
<div class="modal fade" id="serverSetupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-secondary);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-hdd-network"></i> VPN Server Setup</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> This will configure your machine as a WireGuard VPN server.
                    Make sure to forward UDP port 51820 on your router.
                </div>
                <form id="server-setup-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Public Endpoint (IP or Domain)</label>
                            <input type="text" class="form-control" id="server-endpoint" 
                                   placeholder="Leave empty to auto-detect">
                            <small class="text-muted">Your public IP address or domain name</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">UDP Port</label>
                            <input type="number" class="form-control" id="server-port" 
                                   value="51820" min="1024" max="65535">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">VPN Network Address</label>
                        <input type="text" class="form-control" id="server-address" 
                               value="10.0.0.1/24">
                        <small class="text-muted">Private network range for VPN clients</small>
                    </div>
                </form>
                <div id="server-setup-status" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-vpn" id="setup-server-btn" onclick="setupServer()">
                    <i class="bi bi-gear"></i> Setup Server
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Config Display Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-secondary);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-file-code"></i> Client Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <label class="form-label">Configuration File</label>
                        <pre id="config-content" class="config-box"></pre>
                    </div>
                    <div class="col-md-4 text-center" id="qr-container" style="display: none;">
                        <label class="form-label">Scan with WireGuard App</label>
                        <img id="qr-code-image" src="" alt="QR Code" class="img-fluid rounded" style="max-width: 200px;">
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-vpn" onclick="copyConfig()">
                        <i class="bi bi-clipboard"></i> Copy to Clipboard
                    </button>
                    <button class="btn btn-outline-secondary" onclick="downloadConfig()">
                        <i class="bi bi-download"></i> Download .conf File
                    </button>
                </div>
                <div id="setup-steps" class="mt-3" style="display: none;">
                    <h6>Setup Instructions:</h6>
                    <div id="setup-steps-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Setup Modal -->
<div class="modal fade" id="quickSetupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-secondary);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-lightning"></i> Quick Setup Guide</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="quick-setup-content">
                    <p class="text-muted">Loading setup guide...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentConfig = '';
    let currentDeviceName = '';
    let currentSteps = [];

    document.addEventListener('DOMContentLoaded', function() {
        refreshStatus();
        setInterval(refreshStatus, 30000); // Refresh every 30 seconds
    });

    async function refreshStatus() {
        try {
            const response = await fetch('/api/vpn/status');
            const data = await response.json();
            
            // Update status indicators
            const wgStatus = document.getElementById('wg-status');
            const installedBadge = document.getElementById('wg-installed-badge');
            
            if (data.wireguard_installed) {
                wgStatus.textContent = data.interface_active ? 'Running' : 'Installed (Stopped)';
                installedBadge.className = data.interface_active ? 'badge bg-success' : 'badge bg-warning';
                installedBadge.textContent = data.interface_active ? 'Active' : 'Inactive';
            } else {
                wgStatus.textContent = 'Not Installed';
                installedBadge.className = 'badge bg-danger';
                installedBadge.textContent = 'Not Available';
            }
            
            // Update server info
            if (data.server_address) {
                document.getElementById('server-address').textContent = data.server_address;
            } else {
                document.getElementById('server-address').textContent = 'Not configured';
            }
            if (data.port) {
                document.getElementById('server-port').textContent = `Port: ${data.port}`;
            }
            
            // Update client count and list
            const clients = data.clients || [];
            document.getElementById('client-count').textContent = clients.length;
            updateClientsList(clients);
            
        } catch (error) {
            console.error('Error fetching VPN status:', error);
            document.getElementById('wg-status').textContent = 'Error';
            document.getElementById('wg-installed-badge').className = 'badge bg-danger';
            document.getElementById('wg-installed-badge').textContent = 'Error';
        }
    }

    function updateClientsList(clients) {
        const container = document.getElementById('clients-list');
        
        if (!clients || clients.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="bi bi-shield-x fs-1 mb-3 d-block"></i>
                    <p>No VPN clients configured</p>
                    <button class="btn btn-vpn" onclick="openAddDevice()">
                        <i class="bi bi-plus-lg"></i> Add Your First Client
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = clients.map(client => `
            <div class="client-row d-flex justify-content-between align-items-center">
                <div>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator ${client.is_active ? 'status-online' : 'status-offline'}"></span>
                        <strong>${client.name || 'Unknown Device'}</strong>
                    </div>
                    <small class="text-muted">IP: ${client.assigned_ip || 'N/A'}</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="showClientConfig('${client.id}')" title="View Config">
                        <i class="bi bi-file-code"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeClient('${client.id}')" title="Remove">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function openAddDevice() {
        document.getElementById('device-name').value = '';
        document.getElementById('discord-user-id').value = '';
        document.getElementById('add-device-status').style.display = 'none';
        const modal = new bootstrap.Modal(document.getElementById('addDeviceModal'));
        modal.show();
    }

    async function addDevice() {
        const name = document.getElementById('device-name').value.trim();
        const discordId = document.getElementById('discord-user-id').value.trim();
        
        if (!name) {
            alert('Please enter a device name');
            return;
        }
        
        // Show loading state
        document.getElementById('add-device-status').style.display = 'block';
        document.getElementById('add-device-btn').disabled = true;
        
        try {
            const response = await fetch('/api/vpn/add_device', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_name: name, discord_user_id: discordId || null })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close modal and show config
                bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
                
                if (data.config) {
                    currentConfig = data.config;
                    currentDeviceName = name;
                    currentSteps = data.steps || [];
                    document.getElementById('config-content').textContent = data.config;
                    
                    // Show QR code if available
                    if (data.qr_code) {
                        document.getElementById('qr-container').style.display = 'block';
                        document.getElementById('qr-code-image').src = 'data:image/png;base64,' + data.qr_code;
                    } else {
                        document.getElementById('qr-container').style.display = 'none';
                    }
                    
                    // Show setup steps
                    if (currentSteps.length > 0) {
                        document.getElementById('setup-steps').style.display = 'block';
                        document.getElementById('setup-steps-list').innerHTML = currentSteps.map(step => `<p class="mb-1">${step}</p>`).join('');
                    } else {
                        document.getElementById('setup-steps').style.display = 'none';
                    }
                    
                    const configModal = new bootstrap.Modal(document.getElementById('configModal'));
                    configModal.show();
                }
                
                refreshStatus();
            } else {
                document.getElementById('add-device-status').className = 'alert alert-danger';
                document.getElementById('add-device-status').innerHTML = '<i class="bi bi-x-circle"></i> ' + (data.error || 'Unknown error');
            }
        } catch (error) {
            console.error('Error adding device:', error);
            document.getElementById('add-device-status').className = 'alert alert-danger';
            document.getElementById('add-device-status').innerHTML = '<i class="bi bi-x-circle"></i> Error adding device';
        } finally {
            document.getElementById('add-device-btn').disabled = false;
        }
    }

    function copyConfig() {
        navigator.clipboard.writeText(currentConfig).then(() => {
            alert('Configuration copied to clipboard!');
        });
    }

    function downloadConfig() {
        const blob = new Blob([currentConfig], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentDeviceName.replace(/[^a-z0-9]/gi, '_')}.conf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function showClientConfig(clientId) {
        try {
            const response = await fetch(`/api/vpn/client_config/${clientId}`);
            const data = await response.json();
            
            if (data.success) {
                currentConfig = data.config;
                currentDeviceName = data.device_name || 'client';
                document.getElementById('config-content').textContent = data.config;
                document.getElementById('qr-container').style.display = 'none';
                document.getElementById('setup-steps').style.display = 'none';
                
                const configModal = new bootstrap.Modal(document.getElementById('configModal'));
                configModal.show();
            } else {
                alert('Could not load configuration: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error loading config:', error);
            alert('Error loading configuration');
        }
    }

    async function removeClient(clientId) {
        if (!confirm('Are you sure you want to remove this VPN client? This cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/vpn/remove_device', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_id: clientId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Device removed successfully');
                refreshStatus();
            } else {
                alert('Failed to remove device: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error removing device:', error);
            alert('Error removing device');
        }
    }

    function generateServerConfig() {
        const modal = new bootstrap.Modal(document.getElementById('serverSetupModal'));
        document.getElementById('server-setup-status').style.display = 'none';
        modal.show();
    }

    async function setupServer() {
        const endpoint = document.getElementById('server-endpoint').value.trim();
        const port = parseInt(document.getElementById('server-port').value) || 51820;
        const address = document.getElementById('server-address').value.trim() || '10.0.0.1/24';
        
        const statusDiv = document.getElementById('server-setup-status');
        statusDiv.className = 'alert alert-info';
        statusDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> Setting up VPN server...';
        statusDiv.style.display = 'block';
        document.getElementById('setup-server-btn').disabled = true;
        
        try {
            const response = await fetch('/api/vpn/setup_server', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    endpoint: endpoint,
                    port: port,
                    server_address: address
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                statusDiv.className = 'alert alert-success';
                statusDiv.innerHTML = `<i class="bi bi-check-circle"></i> Server configured successfully!<br>
                    <strong>Public Key:</strong> ${data.public_key}<br>
                    <strong>Endpoint:</strong> ${data.endpoint}<br>
                    <strong>Address:</strong> ${data.address}<br><br>
                    Don't forget to forward UDP port ${port} on your router!`;
                refreshStatus();
            } else {
                statusDiv.className = 'alert alert-danger';
                statusDiv.innerHTML = '<i class="bi bi-x-circle"></i> ' + (data.error || 'Failed to setup server');
            }
        } catch (error) {
            console.error('Error setting up server:', error);
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = '<i class="bi bi-x-circle"></i> Error setting up server';
        } finally {
            document.getElementById('setup-server-btn').disabled = false;
        }
    }

    async function showServerQR() {
        alert('Server QR code feature coming soon!');
    }

    async function restartVPN() {
        if (!confirm('Are you sure you want to restart the VPN service?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/vpn/restart', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.success) {
                alert('VPN service restarted successfully!');
                refreshStatus();
            } else {
                alert('Failed to restart VPN: ' + (data.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error restarting VPN:', error);
            alert('Error restarting VPN service');
        }
    }

    async function showQuickSetup() {
        try {
            const response = await fetch('/api/vpn/quick_setup');
            const data = await response.json();
            
            if (data.success) {
                const content = document.getElementById('quick-setup-content');
                let html = `<div class="mb-3"><strong>Platform:</strong> <span class="badge bg-info">${data.platform}</span></div>`;
                
                if (data.quick_guide) {
                    html += `<div class="card mb-3"><div class="card-body"><pre style="white-space: pre-wrap;">${data.quick_guide}</pre></div></div>`;
                }
                
                if (data.termux_guide) {
                    html += `<div class="card"><div class="card-header">Termux-Specific Instructions</div><div class="card-body"><pre style="white-space: pre-wrap;">${data.termux_guide}</pre></div></div>`;
                }
                
                content.innerHTML = html;
                
                const modal = new bootstrap.Modal(document.getElementById('quickSetupModal'));
                modal.show();
            }
        } catch (error) {
            console.error('Error loading quick setup:', error);
        }
    }
</script>
{% endblock %}
