{% extends "layout.html" %}

{% block title %}VPN Manager - Sulfur Bot Dashboard{% endblock %}

{% block content %}
<style>
    .vpn-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .vpn-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px var(--card-shadow);
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-online { background-color: var(--success); }
    .status-offline { background-color: var(--danger); }
    .status-pending { background-color: var(--warning); }
    
    .client-row {
        background: rgba(157, 132, 183, 0.05);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        transition: background 0.2s;
    }
    
    .client-row:hover {
        background: rgba(157, 132, 183, 0.1);
    }
    
    .config-box {
        background: var(--bg-primary, #0a0a0a);
        border-radius: 8px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 12px;
        padding: 15px;
        color: var(--lofi-green, #00ff00);
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
    }
    
    .btn-vpn {
        background: linear-gradient(135deg, var(--lofi-purple) 0%, var(--lofi-pink) 100%);
        border: none;
        color: white;
    }
    
    .btn-vpn:hover {
        background: linear-gradient(135deg, var(--lofi-pink) 0%, var(--lofi-purple) 100%);
        color: white;
    }
    
    .platform-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 12px;
        background: rgba(157, 132, 183, 0.2);
    }
</style>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-shield-lock"></i> VPN Manager</h2>
            <p class="text-muted mb-0">WireGuard VPN configuration and management</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="refreshStatus()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button class="btn btn-vpn" onclick="openAddDevice()">
                <i class="bi bi-plus-lg"></i> Add Device
            </button>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="vpn-card p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-shield-check fs-2 me-3" style="color: var(--lofi-green);"></i>
                    <div>
                        <h5 class="mb-0">WireGuard Status</h5>
                        <span id="wg-status" class="text-muted">Checking...</span>
                    </div>
                </div>
                <div id="wg-installed-badge" class="badge bg-secondary">Unknown</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="vpn-card p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-hdd-network fs-2 me-3" style="color: var(--lofi-blue);"></i>
                    <div>
                        <h5 class="mb-0">Server Address</h5>
                        <span id="server-address" class="text-muted">--</span>
                    </div>
                </div>
                <span id="server-port" class="badge bg-info">Port: --</span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="vpn-card p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-people fs-2 me-3" style="color: var(--lofi-pink);"></i>
                    <div>
                        <h5 class="mb-0">Connected Clients</h5>
                        <span id="client-count" class="text-muted">0</span>
                    </div>
                </div>
                <span class="badge bg-primary">Active Connections</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Client Management -->
        <div class="col-lg-8">
            <div class="vpn-card">
                <div class="card-header d-flex justify-content-between align-items-center p-3" 
                     style="background: var(--bg-tertiary); border-radius: 12px 12px 0 0;">
                    <h5 class="mb-0"><i class="bi bi-laptop"></i> VPN Clients</h5>
                    <button class="btn btn-sm btn-vpn" onclick="openAddDevice()">
                        <i class="bi bi-plus"></i> Add Client
                    </button>
                </div>
                <div class="card-body p-3">
                    <div id="clients-list">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-shield-x fs-1 mb-3 d-block"></i>
                            <p>No VPN clients configured</p>
                            <button class="btn btn-vpn" onclick="openAddDevice()">
                                <i class="bi bi-plus-lg"></i> Add Your First Client
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Info -->
        <div class="col-lg-4">
            <div class="vpn-card mb-4">
                <div class="card-header p-3" style="background: var(--bg-tertiary); border-radius: 12px 12px 0 0;">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                </div>
                <div class="card-body p-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-secondary" onclick="generateServerConfig()">
                            <i class="bi bi-file-code"></i> Generate Server Config
                        </button>
                        <button class="btn btn-outline-secondary" onclick="showServerQR()">
                            <i class="bi bi-qr-code"></i> Show Server QR Code
                        </button>
                        <button class="btn btn-outline-danger" onclick="restartVPN()">
                            <i class="bi bi-arrow-repeat"></i> Restart VPN Service
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="vpn-card">
                <div class="card-header p-3" style="background: var(--bg-tertiary); border-radius: 12px 12px 0 0;">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Platform Support</h5>
                </div>
                <div class="card-body p-3">
                    <p class="text-muted small mb-3">WireGuard clients are available for:</p>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="platform-badge"><i class="bi bi-windows"></i> Windows</span>
                        <span class="platform-badge"><i class="bi bi-apple"></i> macOS</span>
                        <span class="platform-badge"><i class="bi bi-ubuntu"></i> Linux</span>
                        <span class="platform-badge"><i class="bi bi-android"></i> Android</span>
                        <span class="platform-badge"><i class="bi bi-phone"></i> iOS</span>
                    </div>
                    <hr>
                    <p class="text-muted small mb-2">Official WireGuard App:</p>
                    <a href="https://www.wireguard.com/install/" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                        <i class="bi bi-download"></i> Download WireGuard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--bg-secondary);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add VPN Device</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-device-form">
                    <div class="mb-3">
                        <label class="form-label">Device Name</label>
                        <input type="text" class="form-control" id="device-name" 
                               placeholder="e.g., John's Phone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discord User ID (optional)</label>
                        <input type="text" class="form-control" id="discord-user-id" 
                               placeholder="Discord user ID for linking">
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-vpn" onclick="addDevice()">
                    <i class="bi bi-plus-lg"></i> Create Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Config Display Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-secondary);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-file-code"></i> Client Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Configuration File</label>
                    <pre id="config-content" class="config-box"></pre>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-vpn" onclick="copyConfig()">
                        <i class="bi bi-clipboard"></i> Copy to Clipboard
                    </button>
                    <button class="btn btn-outline-secondary" onclick="downloadConfig()">
                        <i class="bi bi-download"></i> Download .conf File
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentConfig = '';
    let currentDeviceName = '';

    document.addEventListener('DOMContentLoaded', function() {
        refreshStatus();
        setInterval(refreshStatus, 30000); // Refresh every 30 seconds
    });

    async function refreshStatus() {
        try {
            const response = await fetch('/api/vpn/status');
            const data = await response.json();
            
            // Update status indicators
            const wgStatus = document.getElementById('wg-status');
            const installedBadge = document.getElementById('wg-installed-badge');
            
            if (data.wireguard_installed) {
                wgStatus.textContent = 'Installed';
                installedBadge.className = 'badge bg-success';
                installedBadge.textContent = 'Available';
            } else {
                wgStatus.textContent = 'Not Installed';
                installedBadge.className = 'badge bg-warning';
                installedBadge.textContent = 'Not Available';
            }
            
            // Update server info
            if (data.server_address) {
                document.getElementById('server-address').textContent = data.server_address;
            }
            if (data.port) {
                document.getElementById('server-port').textContent = `Port: ${data.port}`;
            }
            
            // Update client count and list
            const clients = data.clients || [];
            document.getElementById('client-count').textContent = clients.length;
            updateClientsList(clients);
            
        } catch (error) {
            console.error('Error fetching VPN status:', error);
            document.getElementById('wg-status').textContent = 'Error';
            document.getElementById('wg-installed-badge').className = 'badge bg-danger';
            document.getElementById('wg-installed-badge').textContent = 'Error';
        }
    }

    function updateClientsList(clients) {
        const container = document.getElementById('clients-list');
        
        if (!clients || clients.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="bi bi-shield-x fs-1 mb-3 d-block"></i>
                    <p>No VPN clients configured</p>
                    <button class="btn btn-vpn" onclick="openAddDevice()">
                        <i class="bi bi-plus-lg"></i> Add Your First Client
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = clients.map(client => `
            <div class="client-row d-flex justify-content-between align-items-center">
                <div>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator ${client.is_active ? 'status-online' : 'status-offline'}"></span>
                        <strong>${client.name || 'Unknown Device'}</strong>
                    </div>
                    <small class="text-muted">IP: ${client.assigned_ip || 'N/A'}</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="showClientConfig('${client.id}')">
                        <i class="bi bi-file-code"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeClient('${client.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function openAddDevice() {
        const modal = new bootstrap.Modal(document.getElementById('addDeviceModal'));
        modal.show();
    }

    async function addDevice() {
        const name = document.getElementById('device-name').value.trim();
        const discordId = document.getElementById('discord-user-id').value.trim();
        
        if (!name) {
            alert('Please enter a device name');
            return;
        }
        
        try {
            const response = await fetch('/api/vpn/add_device', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_name: name, discord_user_id: discordId || null })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close modal and show config
                bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
                
                if (data.config) {
                    currentConfig = data.config;
                    currentDeviceName = name;
                    document.getElementById('config-content').textContent = data.config;
                    const configModal = new bootstrap.Modal(document.getElementById('configModal'));
                    configModal.show();
                }
                
                refreshStatus();
            } else {
                alert('Failed to add device: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error adding device:', error);
            alert('Error adding device');
        }
    }

    function copyConfig() {
        navigator.clipboard.writeText(currentConfig).then(() => {
            alert('Configuration copied to clipboard!');
        });
    }

    function downloadConfig() {
        const blob = new Blob([currentConfig], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentDeviceName.replace(/[^a-z0-9]/gi, '_')}.conf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function showClientConfig(clientId) {
        // This would fetch the client config from the API
        alert('Feature coming soon!');
    }

    async function removeClient(clientId) {
        if (!confirm('Are you sure you want to remove this VPN client?')) {
            return;
        }
        // This would call the API to remove the client
        alert('Feature coming soon!');
    }

    function generateServerConfig() {
        alert('Feature coming soon!');
    }

    function showServerQR() {
        alert('Feature coming soon!');
    }

    function restartVPN() {
        if (!confirm('Are you sure you want to restart the VPN service?')) {
            return;
        }
        alert('Feature coming soon!');
    }
</script>
{% endblock %}
