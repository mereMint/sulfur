{% extends "layout.html" %}
{% block title %}Music Dashboard - Sulfur Bot{% endblock %}

{% block extra_styles %}
<style>
    .music-card {
        background: linear-gradient(135deg, rgba(157, 132, 183, 0.2) 0%, rgba(244, 166, 215, 0.2) 100%);
        border: 2px solid var(--border-color);
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .music-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(157, 132, 183, 0.3);
        border-color: var(--lofi-purple);
    }
    
    .now-playing {
        border-color: var(--lofi-green);
        animation: pulse-border 2s ease-in-out infinite;
    }
    
    @keyframes pulse-border {
        0%, 100% {
            box-shadow: 0 8px 32px rgba(184, 212, 168, 0.3);
        }
        50% {
            box-shadow: 0 12px 48px rgba(184, 212, 168, 0.5);
        }
    }
    
    .queue-item {
        background: rgba(26, 26, 46, 0.7);
        border-left: 3px solid var(--lofi-teal);
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .queue-item:hover {
        background: rgba(26, 26, 46, 0.9);
        border-left-color: var(--lofi-pink);
        transform: translateX(8px);
    }
    
    .progress-ring {
        transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
        stroke-dasharray: 283;
        stroke-dashoffset: 283;
        transition: stroke-dashoffset 0.35s;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4 fade-in">
    <div class="col-12">
        <h2 class="gradient-text mb-4">
            <i class="bi bi-music-note-beamed"></i> Music Dashboard
        </h2>
    </div>
</div>

<!-- Now Playing Section -->
<div class="row mb-4 fade-in">
    <div class="col-lg-8 mb-4">
        <div class="music-card now-playing" id="now-playing-card">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <div class="position-relative">
                        <img src="" id="album-art" class="img-fluid rounded" style="max-width: 150px; display: none;" alt="Album Art">
                        <i class="bi bi-disc" id="default-icon" style="font-size: 6rem; color: var(--lofi-green);"></i>
                    </div>
                </div>
                <div class="col-md-7">
                    <h5 class="text-muted mb-2"><i class="bi bi-play-circle"></i> NOW PLAYING</h5>
                    <h3 class="mb-1" id="current-song-title">No song playing</h3>
                    <p class="text-muted mb-2" id="current-song-artist">-</p>
                    <div class="d-flex gap-2 mb-2">
                        <span class="badge bg-success" id="current-guild">Guild: -</span>
                        <span class="badge bg-info" id="current-channel">Channel: -</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="playback-progress" 
                             style="width: 0%"
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted">
                        <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
                    </small>
                </div>
                <div class="col-md-2 text-center">
                    <div class="mb-3">
                        <i class="bi bi-people-fill" style="font-size: 2rem; color: var(--lofi-teal);"></i>
                        <h4 id="listener-count" style="color: var(--lofi-teal);">0</h4>
                        <small class="text-muted">Listeners</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card p-4">
            <h5 class="mb-3"><i class="bi bi-graph-up"></i> Music Stats</h5>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>Total Songs Played</span>
                    <strong id="total-songs-played">0</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Queue Length</span>
                    <strong id="queue-length">0</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Listening Time Today</span>
                    <strong id="listening-time-today">0h 0m</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Active Sessions</span>
                    <strong id="active-sessions">0</strong>
                </div>
            </div>
            
            <!-- Sleep Timer Section -->
            <hr>
            <h6 class="mb-3"><i class="bi bi-alarm"></i> Sleep Timer</h6>
            <div class="mb-2">
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="sleep-timer-minutes" 
                           placeholder="Minutes" min="1" max="480" value="30">
                    <button class="btn btn-primary" onclick="setSleepTimer()">
                        <i class="bi bi-alarm-fill"></i> Set
                    </button>
                </div>
            </div>
            <div id="sleep-timer-status" class="text-muted small" style="display: none;">
                Timer: <span id="sleep-timer-remaining">-</span>
                <button class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="cancelSleepTimer()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Album Search Section -->
<div class="row mb-4 fade-in">
    <div class="col-12">
        <div class="card p-4">
            <h5 class="mb-3"><i class="bi bi-disc"></i> Album Search & Queue</h5>
            <p class="text-muted small mb-3">Search for an album to see its tracklist and add it to the queue</p>
            <div class="row">
                <div class="col-md-5 mb-3">
                    <input type="text" class="form-control" id="album-name" placeholder="Album Name" required>
                </div>
                <div class="col-md-4 mb-3">
                    <input type="text" class="form-control" id="album-artist" placeholder="Artist (optional)">
                </div>
                <div class="col-md-3 mb-3">
                    <button class="btn btn-primary w-100" onclick="searchAlbum()">
                        <i class="bi bi-search"></i> Search Album
                    </button>
                </div>
            </div>
            
            <!-- Album Results -->
            <div id="album-results" style="display: none;">
                <hr>
                <div class="row">
                    <div class="col-md-3 text-center">
                        <img id="album-thumbnail" src="" class="img-fluid rounded mb-2" alt="Album Art" style="max-width: 200px;">
                    </div>
                    <div class="col-md-9">
                        <h5 id="album-title">-</h5>
                        <p class="text-muted"><i class="bi bi-person"></i> <span id="album-artist-display">-</span></p>
                        <p class="text-muted"><i class="bi bi-music-note-list"></i> <span id="album-track-count">0</span> tracks</p>
                        <button class="btn btn-success" onclick="addAlbumToQueue()">
                            <i class="bi bi-plus-circle"></i> Add All Tracks to Queue
                        </button>
                    </div>
                </div>
                
                <!-- Tracklist -->
                <div class="mt-3">
                    <h6>Tracklist:</h6>
                    <div id="album-tracklist" style="max-height: 300px; overflow-y: auto;">
                        <!-- Tracks will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Queue Section -->
<div class="row mb-4 fade-in">
    <div class="col-lg-6 mb-4">
        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-list-ol"></i> Queue</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshQueue()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div id="queue-list" style="max-height: 500px; overflow-y: auto;">
                <p class="text-muted text-center">Queue is empty</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card p-4">
            <h5 class="mb-3"><i class="bi bi-clock-history"></i> Recently Played</h5>
            <div id="recent-songs-list" style="max-height: 500px; overflow-y: auto;">
                <p class="text-muted text-center">No recent songs</p>
            </div>
        </div>
    </div>
</div>

<!-- Top Songs & Artists -->
<div class="row fade-in">
    <div class="col-lg-6 mb-4">
        <div class="card p-4">
            <h5 class="mb-3"><i class="bi bi-trophy"></i> Top Songs (30 Days)</h5>
            <div id="top-songs-list">
                <p class="text-muted text-center">Loading...</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card p-4">
            <h5 class="mb-3"><i class="bi bi-star"></i> Top Artists (30 Days)</h5>
            <div id="top-artists-list">
                <p class="text-muted text-center">Loading...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let updateInterval;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadMusicDashboard();
        
        // Update every 5 seconds
        updateInterval = setInterval(loadMusicDashboard, 5000);
    });
    
    async function loadMusicDashboard() {
        try {
            const response = await fetch('/api/music/status');
            const data = await response.json();
            
            if (data.error) {
                console.error('Error loading music status:', data.error);
                return;
            }
            
            // Update now playing
            if (data.now_playing && data.now_playing.title) {
                currentGuildId = data.now_playing.guild_id; // Store guild_id
                document.getElementById('current-song-title').textContent = data.now_playing.title;
                document.getElementById('current-song-artist').textContent = data.now_playing.artist || 'Unknown Artist';
                document.getElementById('current-guild').textContent = `Guild: ${data.now_playing.guild_name || 'Unknown'}`;
                document.getElementById('current-channel').textContent = `Channel: ${data.now_playing.channel_name || 'Unknown'}`;
                document.getElementById('listener-count').textContent = data.now_playing.listeners || 0;
                
                // Update progress (mock for now)
                const progress = Math.min((data.now_playing.elapsed_seconds || 0) / (data.now_playing.duration_seconds || 1) * 100, 100);
                document.getElementById('playback-progress').style.width = `${progress}%`;
                
                const currentMins = Math.floor((data.now_playing.elapsed_seconds || 0) / 60);
                const currentSecs = Math.floor((data.now_playing.elapsed_seconds || 0) % 60);
                const totalMins = Math.floor((data.now_playing.duration_seconds || 0) / 60);
                const totalSecs = Math.floor((data.now_playing.duration_seconds || 0) % 60);
                
                document.getElementById('current-time').textContent = `${currentMins}:${currentSecs.toString().padStart(2, '0')}`;
                document.getElementById('total-time').textContent = `${totalMins}:${totalSecs.toString().padStart(2, '0')}`;
            } else {
                document.getElementById('current-song-title').textContent = 'No song playing';
                document.getElementById('current-song-artist').textContent = '-';
                document.getElementById('listener-count').textContent = '0';
            }
            
            // Update stats
            document.getElementById('total-songs-played').textContent = (data.stats?.total_songs_played || 0).toLocaleString();
            document.getElementById('queue-length').textContent = data.stats?.queue_length || 0;
            document.getElementById('active-sessions').textContent = data.stats?.active_sessions || 0;
            
            const listeningMins = data.stats?.listening_time_today_minutes || 0;
            const hours = Math.floor(listeningMins / 60);
            const mins = listeningMins % 60;
            document.getElementById('listening-time-today').textContent = `${hours}h ${mins}m`;
            
            // Update queue
            updateQueue(data.queue || []);
            
            // Update recent songs
            updateRecentSongs(data.recent_songs || []);
            
        } catch (error) {
            console.error('Error loading music dashboard:', error);
        }
    }
    
    function updateQueue(queue) {
        const queueList = document.getElementById('queue-list');
        
        if (!queue || queue.length === 0) {
            queueList.innerHTML = '<p class="text-muted text-center">Queue is empty</p>';
            return;
        }
        
        let html = '';
        queue.forEach((song, index) => {
            html += `
                <div class="queue-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-secondary me-2">${index + 1}</span>
                            <strong>${song.title || 'Unknown'}</strong>
                            <br>
                            <small class="text-muted ms-4">${song.artist || 'Unknown Artist'}</small>
                        </div>
                        <div>
                            ${song.source ? `<span class="badge bg-info">${song.source}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        queueList.innerHTML = html;
    }
    
    function updateRecentSongs(songs) {
        const recentList = document.getElementById('recent-songs-list');
        
        if (!songs || songs.length === 0) {
            recentList.innerHTML = '<p class="text-muted text-center">No recent songs</p>';
            return;
        }
        
        let html = '';
        songs.forEach(song => {
            const albumInfo = song.album && song.album !== 'Unknown Album' ? `<small class="text-info">ðŸ“€ ${song.album}</small><br>` : '';
            html += `
                <div class="queue-item mb-2">
                    <strong>${song.title || 'Unknown'}</strong><br>
                    <small class="text-muted">${song.artist || 'Unknown Artist'}</small><br>
                    ${albumInfo}
                    <small class="text-muted">${song.played_at || ''}</small>
                </div>
            `;
        });
        
        recentList.innerHTML = html;
    }
    
    function refreshQueue() {
        loadMusicDashboard();
    }
    
    // Load top songs and artists
    async function loadTopMusic() {
        try {
            const response = await fetch('/api/music/top');
            const data = await response.json();
            
            if (!data.error) {
                updateTopSongs(data.top_songs || []);
                updateTopArtists(data.top_artists || []);
            }
        } catch (error) {
            console.error('Error loading top music:', error);
        }
    }
    
    function updateTopSongs(songs) {
        const topList = document.getElementById('top-songs-list');
        
        if (!songs || songs.length === 0) {
            topList.innerHTML = '<p class="text-muted">No data available</p>';
            return;
        }
        
        let html = '<div class="list-group list-group-flush">';
        songs.forEach((song, index) => {
            const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : `${index + 1}.`;
            html += `
                <div class="list-group-item bg-transparent border-0 p-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <span class="me-2">${medal}</span>
                            <strong>${song.title}</strong><br>
                            <small class="text-muted ms-4">${song.artist}</small>
                        </div>
                        <div class="text-end">
                            <strong>${song.play_count}</strong><br>
                            <small class="text-muted">plays</small>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        topList.innerHTML = html;
    }
    
    function updateTopArtists(artists) {
        const topList = document.getElementById('top-artists-list');
        
        if (!artists || artists.length === 0) {
            topList.innerHTML = '<p class="text-muted">No data available</p>';
            return;
        }
        
        let html = '<div class="list-group list-group-flush">';
        artists.forEach((artist, index) => {
            const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : `${index + 1}.`;
            html += `
                <div class="list-group-item bg-transparent border-0 p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="me-2">${medal}</span>
                            <strong>${artist.artist}</strong>
                        </div>
                        <div>
                            <strong>${artist.play_count}</strong>
                            <small class="text-muted">plays</small>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        topList.innerHTML = html;
    }
    
    // Load top music on page load
    setTimeout(loadTopMusic, 1000);
    
    // ===== Sleep Timer Functions =====
    let currentGuildId = null; // Will be set from now playing data
    
    async function setSleepTimer() {
        const minutes = parseInt(document.getElementById('sleep-timer-minutes').value);
        
        if (!minutes || minutes < 1 || minutes > 480) {
            alert('Please enter a valid number of minutes (1-480)');
            return;
        }
        
        if (!currentGuildId) {
            alert('No active music session detected. Please start playing music first.');
            return;
        }
        
        try {
            const response = await fetch('/api/music/sleep_timer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    guild_id: currentGuildId,
                    minutes: minutes
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                document.getElementById('sleep-timer-status').style.display = 'block';
                updateSleepTimerDisplay(minutes);
                alert(`Sleep timer set for ${minutes} minutes`);
            } else {
                alert(`Error: ${data.error || 'Failed to set sleep timer'}`);
            }
        } catch (error) {
            console.error('Error setting sleep timer:', error);
            alert('Error setting sleep timer');
        }
    }
    
    async function cancelSleepTimer() {
        if (!currentGuildId) {
            return;
        }
        
        try {
            const response = await fetch('/api/music/sleep_timer/cancel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({guild_id: currentGuildId})
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                document.getElementById('sleep-timer-status').style.display = 'none';
                alert('Sleep timer cancelled');
            }
        } catch (error) {
            console.error('Error cancelling sleep timer:', error);
        }
    }
    
    function updateSleepTimerDisplay(minutes) {
        const remainingText = minutes >= 60 
            ? `${Math.floor(minutes/60)}h ${minutes%60}m remaining`
            : `${minutes}m remaining`;
        document.getElementById('sleep-timer-remaining').textContent = remainingText;
    }
    
    // ===== Album Search Functions =====
    let currentAlbumInfo = null;
    
    async function searchAlbum() {
        const albumName = document.getElementById('album-name').value.trim();
        const artist = document.getElementById('album-artist').value.trim();
        
        if (!albumName) {
            alert('Please enter an album name');
            return;
        }
        
        try {
            const response = await fetch('/api/music/album/search', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    album_name: albumName,
                    artist: artist || null
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success' && data.album) {
                currentAlbumInfo = data.album;
                displayAlbumResults(data.album);
            } else {
                alert(`Album not found: ${data.error || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error searching album:', error);
            alert('Error searching for album');
        }
    }
    
    function displayAlbumResults(album) {
        document.getElementById('album-results').style.display = 'block';
        
        // Set album info
        document.getElementById('album-title').textContent = album.album_name || 'Unknown Album';
        document.getElementById('album-artist-display').textContent = album.artist || 'Unknown Artist';
        document.getElementById('album-track-count').textContent = album.total_tracks || 0;
        
        // Set thumbnail if available
        const thumbnail = document.getElementById('album-thumbnail');
        if (album.thumbnail) {
            thumbnail.src = album.thumbnail;
            thumbnail.style.display = 'block';
        } else {
            thumbnail.style.display = 'none';
        }
        
        // Display tracklist
        const tracklistDiv = document.getElementById('album-tracklist');
        let html = '<div class="list-group">';
        
        album.tracks.forEach((track, index) => {
            html += `
                <div class="list-group-item bg-transparent border-secondary">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-primary me-2">${track.track_number}</span>
                            <strong>${track.title}</strong>
                            <br>
                            <small class="text-muted ms-4">${track.artist}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        tracklistDiv.innerHTML = html;
    }
    
    async function addAlbumToQueue() {
        if (!currentAlbumInfo) {
            alert('Please search for an album first');
            return;
        }
        
        if (!currentGuildId) {
            alert('No active music session detected. Please start playing music first.');
            return;
        }
        
        try {
            const response = await fetch('/api/music/album/queue', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    guild_id: currentGuildId,
                    album_name: currentAlbumInfo.album_name,
                    artist: currentAlbumInfo.artist
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                alert(`âœ… ${data.message}`);
                // Refresh dashboard to show updated queue
                loadMusicDashboard();
            } else {
                alert(`Error: ${data.error || 'Failed to add album to queue'}`);
            }
        } catch (error) {
            console.error('Error adding album to queue:', error);
            alert('Error adding album to queue');
        }
    }
</script>
{% endblock %}
